<%
  def render_once( target_view )
    @style_included ||= false
    unless @style_included
      @style_included = true
      render partial: target_view
    end
  end
%>
<%= render_once('milestone/gantt_style') %>

<%
  # Îã¥ÎãπÏûê ÎßÅÌÅ¨ Ï∫êÏã± Ìó¨Ìçº Î©îÏÜåÎìú
  def cached_link_to_principal(principal, options = {})
    @cached_principals ||= {}
    principal_id = principal.is_a?(Principal) ? principal.id : principal
    
    unless @cached_principals.key?(principal_id)
      if principal.is_a?(Principal)
        @cached_principals[principal_id] = link_to_principal(principal, options)
      else
        principal_obj = Principal.find_by(id: principal_id)
        @cached_principals[principal_id] = principal_obj ? link_to_principal(principal_obj, options) : principal_id.to_s
      end
    end
    
    @cached_principals[principal_id]
  end

  gantt_opts ||= {}
  date_marks ||= []
  virtual_ids ||= []

  issue_link_url = gantt_opts[:issue_link_url] || '/issues/'

  cell_width = gantt_opts[:cell_width] || 18
  cell_height = gantt_opts[:cell_height] || 18
  title_width = gantt_opts[:title_width] || 400
  person_width = gantt_opts[:person_width] || 90
  show_status_history = gantt_opts[:show_status_history] || params[:show_status_history] || false

  # N+1 ÏøºÎ¶¨ Î∞©ÏßÄ
  ActiveRecord::Associations::Preloader.new(
    records: issues,
    associations: [:assigned_to, :project]
  ).call

  # Ìó¨Ìçº Î©îÏÑúÎìúÎ°ú ÎπÑÏ¶àÎãàÏä§ Î°úÏßÅ Î∂ÑÎ¶¨
  paused_periods_map = gantt_paused_periods(issues)
  depth_map_hash = gantt_depth_map(issues)

  _due_date = defined?(due_date) && due_date ? due_date : nil
  date_info = gantt_date_range(issues, gantt_opts, _due_date)
  start_date = date_info[:start_date]
  end_date = date_info[:end_date]
  today_index = date_info[:today_index]
  due_date_index = date_info[:due_date_index]
  total_days = date_info[:total_days]

  _issues = gantt_prepare_issues(issues, depth_map_hash)

  holidays = []
  if TxBaseHelper::HolidayApi.available?
    holidays = TxBaseHelper::HolidayApi.for_date_range( start_date, end_date )
  end
%>

<% gantt_container_id = "gantt-container-#{rand(1000000)}" %>

<div class="gantt-wrapper mouseover-wrapper-<%=gantt_container_id%>" style="display: flex; position: relative;">
  <div class="cursor-container-<%=gantt_container_id%>" style="top: 36px; height: <%=cell_height%>px;"></div>
  
  <div class="gantt-info-container" style="flex-shrink: 0; border: 1px solid #ccc;">

    <div class="gantt-grid" style="grid-template-columns: <%=title_width%>px <%=person_width%>px;">

        <div class="task-name" style="height: <%=cell_height*2%>px;"><span class="task-name-text"><%= title ? title : 'ÏùºÍ∞ê' %></span></div>
        <% if gantt_opts[:hide_assignee] != true %>
            <div class="assignee" style="left: <%=title_width%>px;">Îã¥ÎãπÏûê</div>
        <% end %>

        
          <% _issues.each_with_index do |_issue, index| %>

            <%
            issue = _issue[:issue]
            depth = _issue[:depth]
            show_no_due_date_warning = _issue[:show_no_due_date_warning]
            %>

            <div id="issue-<%= issue.id %>" class="task-row mouseover-<%=gantt_container_id%> hascontextmenu">

                <div class="task-name priority-<%= issue.priority_id %>" style="height: <%=cell_height%>px;">
                <% subject_class = gantt_issue_css_class(issue) %>

                <% if depth > 0 then %>
                    <span class="depth-indent" style="margin-left: <%=depth * 10%>px;">‚ñ∏ </span>
                <% end %>

                <% if virtual_ids.include?(issue.id) then %>
                    <span class="virtual-marker">‚ú® </span>
                <% end %>

                <% if IssueStatus.is_postponed?(issue.status_id) && !Tracker.is_exception?( issue.tracker_id ) then %>
                    <i class='fas fa-hourglass-half warning-icon icon-postponed'> </i>
                <% end %>

                <% if show_no_due_date_warning then %>
                    <i class='fas fa-circle-question warning-icon icon-no-due-date'> </i>
                <% end %>

                <% if IssueStatus.is_discarded?(issue.status_id) then %>
                    <span class="icon-discarded">üóëÔ∏è</span>
                <% elsif IssueStatus.is_implemented?(issue.status_id) then %>
                    <span class="icon-implemented">‚úì</span>
                <% elsif IssueStatus.is_in_review?(issue.status_id) then %>
                    üîç
                <% elsif IssueStatus.is_paused?(issue.status_id) then %>
                    <i class='fas fa-pause icon-paused'> </i>
                <% elsif IssueStatus.is_new?(issue.status_id) && issue.start_date && issue.start_date <= Date.today then %>
                    ‚ö†Ô∏è
                <% elsif !IssueStatus.is_completed?(issue.status_id) && issue.due_date && issue.due_date < Date.today then %>
                    üî•
                <% end %>
                <span class="issue-subject-link <%= subject_class %>" data-issue-tooltip="<%= issue.id %>">
                    <%= link_to "##{issue.id}", "/projects/#{ @project ? @project.identifier : issue.project.identifier }/milestone/gantt/issues/#{issue.id}" %>
                    <%= link_to issue.subject.html_safe, gantt_opts[:issue_link_url] ? gantt_opts[:issue_link_url] + issue.id.to_s : issue_path(issue),
                                class: issue.css_classes, title: issue.subject.truncate(100) %>
                </span>

                </div>
                <% if gantt_opts[:hide_assignee] != true %>
                <div class="assignee priority-<%= issue.priority_id %>" style="left: <%=title_width%>px; height: <%=cell_height%>px;"><%= cached_link_to_principal(issue.assigned_to) if issue.assigned_to %></div>
                <% end %>        
            </div>
          <% end %>
        
    </div>
  </div>
  
  <div id="<%= gantt_container_id %>" class="gantt-container" style='border: 1px solid #ccc;'>
    <div class="gantt-grid" style="grid-template-columns: repeat(<%=total_days+1%>, <%=cell_width%>px);">
      <!-- Ïõî Ìó§Îçî -->
      <% 
        current_month = nil
        month_cell_count = 0
        
        (start_date..end_date).each do |date|
          if current_month != date.month
            if current_month
      %>
              <div class="month-header" style="grid-column: span <%= month_cell_count %>; white-space: nowrap;"><%= current_month %>Ïõî</div>
      <%
            end
            current_month = date.month
            month_cell_count = 1
          else
            month_cell_count += 1
          end
          
          if date == end_date
      %>
            <div class="month-header" style="height: <%=cell_height - 4%>px; grid-column: span <%= month_cell_count %>;"><%= current_month %>Ïõî</div>
      <%  
          end
        end 
      %>

      <!-- ÎÇ†Ïßú Ìó§Îçî -->
      <% (start_date..end_date).each do |date| %>
        <div class="date-header" <%= date == start_date ? "style='height: #{cell_height - 4}px;'".html_safe : "" %>>
          <span class="date-header-text">

            <font color="<%= date.sunday? ? 'red' : date.saturday? ? 'blue' : 'black' %>"><%= date.day %></font>

            <% if date.sunday? || holidays[date] %>
              <div class="highlight-column" style="width: <%=cell_width%>px; top: <%=cell_height  %>px; left: <%= ((date - start_date).to_i * cell_width) %>px; background-color: rgba(255, 0, 0, 0.1);"></div>
            <% end %>
            <% if date.saturday? %>
              <div class="highlight-column" style="width: <%=cell_width%>px; top: <%=cell_height  %>px; left: <%= ((date - start_date).to_i * cell_width) %>px; background-color: rgba(0, 80, 255, 0.1);"></div>
            <% end %>

            <% vacation = ( ( defined?(user) && defined?(vacation_info) && vacation_info && vacation_info[date] ) ? vacation_info[date].select{ |k, v| k == user.login }[ user.login ] : nil ) %>
            <% if vacation then

                 vacation_left_margin = 0
                 vacation_width = cell_width

                 if vacation[:status] == "Ïò§Ï†ÑÎ∞òÏ∞®" then
                   vacation_width = vacation_width / 2
                 elsif vacation[:status] == "Ïò§ÌõÑÎ∞òÏ∞®" then
                   vacation_left_margin = cell_width / 2
                   vacation_width = vacation_width / 2
                 end
             %>
              <div class="highlight-column" style="left: <%= vacation_left_margin + ((date - start_date).to_i * cell_width) %>px; top: <%=cell_height + 1 %>px; width: <%= vacation_width %>px; background-color: rgba(0, 0, 0, 0.1);"></div>
            <% end %>

          </span>
        </div>
      <% end %>

      <!-- Ïò§Îäò ÎÇ†Ïßú ÌëúÏãúÏÑ† -->
      <div class="today-column" style="left: <%= (today_index * cell_width) %>px; top: <%=cell_height + 1 %>px;"></div>
      <div class="today-column" style="left: <%= (today_index * cell_width) + cell_width %>px; top: <%=cell_height + 1 %>px;"></div>
      <% if defined?(due_date) && due_date %>
        <div class="blocked-grid" style="left: <%= (due_date_index * cell_width) %>px; top: <%=cell_height + 1 %>px; width: <%= cell_width * ( ( end_date - due_date ).to_i )  %>px;"></div>
      <% end %>

      <% if date_marks.any? then %>
        <% date_marks.each_with_index do |data, index|
          _value = data[:name]
          _date = data[:date]
          %>
          <% mark_index = ( _date - start_date ).to_i + 1 %>
            <div class="mark-text" style="left: <%= 3 + (mark_index * cell_width) %>px; top: <%= index * cell_height + cell_height * 2.2 %>px;"><%= _value %></div>
            <div class="mark-column" style="left: <%= (mark_index * cell_width) %>px;top: <%=cell_height + 1 %>px"></div>
        <% end %>
      <% end %>

      <% _issues.each_with_index do |_issue, index| %>
        <%
          issue = _issue[:issue]
          depth = _issue[:depth]
          show_no_due_date_warning = _issue[:show_no_due_date_warning]
        %>     

        <div class="task-row mouseover-<%=gantt_container_id%>">
          <%
            issue_expected_start_date = issue.start_date ? issue.start_date.to_date : -Date::Infinity.new
            issue_expected_due_date = issue.due_date ? issue.due_date.to_date : Date::Infinity.new

            issue_begin_date = issue.begin_time ? issue.begin_time.to_date : nil
            issue_end_date = issue.end_time ? issue.end_time.to_date : Date.today

            issue_progress_status_history = if show_status_history then
                                                  issue.status_history.map{ |datetime, status_id|
                                                    status = IssueStatus.find_by(id: status_id)
                                                    [ datetime.to_date, status ? status.name : '?' ]
                                                   }.to_h
                                              else
                                                  {}
                                              end
          %>

          <%
            show_line = !Tracker.is_exception?( issue.tracker_id ) && ( ( issue.due_date && issue.due_date >= start_date ) || ( issue.start_date && issue.due_date.nil? ) || ( issue.start_date && issue.start_date >= start_date && issue.start_date <= end_date ) )
            show_line_before = ( issue.start_date && issue.start_date >= start_date )
            show_line_after = ( issue.due_date && issue.due_date <= end_date )
            line_start_date = if issue.start_date && issue.start_date < start_date then
                                start_date
                              else
                                issue.start_date
                              end
            line_end_date = if issue.due_date && issue.due_date >= start_date then
                              issue.due_date
                            else
                              end_date
                            end

            if line_start_date.nil? && line_end_date
              line_start_date = issue_begin_date && !IssueStatus.is_implemented?( issue.status_id ) ? issue_begin_date : line_end_date
            end

            line_width = line_start_date ? ( [ line_end_date, end_date ].min - line_start_date + 1 ).to_i * cell_width : cell_width

            tooltip_begin_date = [ issue_begin_date, line_start_date ].compact.min
            tooltip_end_date = [ issue_end_date, line_end_date ].compact.max
          %>
          
          <% (start_date..end_date).each do |date| %>
            <% has_tooltip = tooltip_begin_date && tooltip_end_date && ( ( date >= tooltip_begin_date && date <= tooltip_end_date) || date == line_start_date || date == line_end_date ) %>
            <% has_bar_here = (date == issue_begin_date) || ( issue_begin_date && date == start_date && issue_begin_date < start_date && issue_end_date >= start_date ) %>
            <div class="task-cell<%= show_no_due_date_warning ? ' n' : '' %>" style="height: <%=cell_height%>px; position: relative;" id="issue-<%= issue.id %>">
              <!-- ÏûëÏóÖÏôÑÎ£å or ÏûëÏóÖÏ§ë Ïù¥Ïäà -->
              <% if has_bar_here then%>
                <%
                  #debug[:date] = date.strftime( '%Y-%m-%d' )

                  bar_width = if issue_begin_date != issue_end_date then
                                [1,  ( issue_end_date - date + 1 ).to_i ].max * cell_width
                              else
                                if issue.end_time.nil?
                                  cell_width
                                else
                                  if ( issue.end_time - issue.begin_time ) >= 4.hour then
                                    cell_width
                                  elsif ( issue.end_time - issue.begin_time ) >= 1.hour then
                                    ( cell_width * 0.5 ).to_i
                                  else
                                    3
                                  end
                                end
                              end
                %>
                <% if !Tracker.is_exception?( issue.tracker_id ) then %>
                  <div class="task-bar<%= IssueStatus.is_implemented?( issue.status_id ) ? ' completed' : '' %><%= IssueStatus.is_in_review?( issue.status_id ) ? ' confirm' : '' %>" style="width: <%= bar_width %>px; height: <%=cell_height-4%>px; position: absolute; left: 0; z-index: 1;" data-issue-tooltip="<%= issue.id %>">
                    <% if IssueStatus.is_in_progress?( issue.status_id ) %>
                      <div class="task-bar-progress<%= IssueStatus.is_in_review?( issue.status_id ) ? ' confirm' : '' %>" style="width: <%= issue.done_ratio %>%;"></div>
                    <% end %>
                    <%# paused Íµ¨Í∞Ñ Ïò§Î≤ÑÎ†àÏù¥ %>
                    <% (paused_periods_map[issue.id] || []).each do |period| %>
                      <%
                        p_start = [period[:entered_at], date].max
                        p_end   = [period[:exited_at] || Date.today, issue_end_date].min
                        next if p_start > p_end || p_start > issue_end_date || p_end < date
                        left_px  = (p_start - date).to_i * cell_width
                        width_px = (p_end - p_start + 1).to_i * cell_width
                      %>
                      <div class="task-bar-paused" style="left: <%= left_px %>px; width: <%= width_px %>px;"></div>
                    <% end %>
                  </div>
                  <div class="task-tooltip-hit" data-issue-tooltip="<%= issue.id %>" style="position: absolute; left: 0; top: 0; width: <%= (show_line && date == line_start_date && line_width > bar_width) ? line_width : bar_width %>px; height: <%= cell_height %>px; z-index: 50;"></div>
                <% end %>
              <% end %>

              <% if issue.tip && !virtual_ids.include?(issue.id) && date == [ ( issue.due_date ? issue.due_date : Date.today - 100.years ), ( issue.end_time ? issue.end_time.to_date : Date.today - 100.years ), ( issue.end_time.nil? && issue.begin_time ? Date.today : Date.today - 100.years ) ].max %>
                <div class="gantt-tip-label" style="left: <%= cell_width + 2 %>px;"><%=issue.tip%></div>
              <% end %>

              <% if show_status_history && date < issue_end_date && issue_progress_status_history[date] && ( issue_begin_date == nil || issue_begin_date < date ) %>
                <div class="gantt-status-label" style="left: 2px;"><%=issue_progress_status_history[date]%></div>
              <% end %>

              <!-- ÏòàÏ†ï Ïù¥Ïäà -->
              <% if show_line && date == line_start_date %>
                <div class="arrow-line<%= show_line_before ? ' show-before' : '' %> <%= show_line_after ? ' show-after' : '' %>" style="width: <%=line_width %>px; top: <%= cell_height -3 %>px;<% if defined?(virtual_ids) && virtual_ids.include?(issue.id) %> background-color: #fa0;<% end %>" data-issue-tooltip="<%= issue.id %>"></div>
                <% unless has_bar_here %>
                  <div class="task-tooltip-hit" data-issue-tooltip="<%= issue.id %>" style="position: absolute; left: 0; top: 0; width: <%= line_width %>px; height: <%= cell_height %>px; z-index: 50;"></div>
                <% end %>
              <% end %>

            </div>
          <% end %>
        </div>
      <% end %>

    </div>
  </div>
</div>

<%# end %>

<script>
  $(document).ready(function() {
    var wrapperId = '<%= gantt_container_id %>';
    var cellWidth = <%= cell_width %>;
    var cellHeight = <%= cell_height %>;

    // Ïò§Îäò ÎÇ†ÏßúÎ°ú Í∞ÑÌä∏ Ïä§ÌÅ¨Î°§
    var ganttEl = document.getElementById(wrapperId);
    var startDate = new Date("<%= start_date.strftime( '%Y-%m-%d' ) %>");
    var daysFromStart = (new Date() - startDate) / (1000 * 60 * 60 * 24);
    ganttEl.scrollLeft = (daysFromStart - 25) * cellWidth;

    // Ï∫êÏã±
    var $wrapper = $('.mouseover-wrapper-' + wrapperId);
    var cursorEl = $wrapper.find('[class*="cursor-container-"]')[0];
    var $taskNameElements = $wrapper.find('.gantt-info-container .task-name');
    var headerHeight = $taskNameElements.first().outerHeight() || <%= cell_height * 2 %>;
    var wrapperOffsetTop = null;

    // Ìñâ ÌïòÏù¥ÎùºÏù¥Ìä∏ - Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ
    $wrapper.on('mouseenter', '.mouseover-' + wrapperId, function() {
      var rows = $wrapper.find('.mouseover-' + wrapperId);
      var rowIndex = rows.index(this);

      // Ï¢åÏ∏° Ï†ïÎ≥¥ ÏòÅÏó≠Í≥º Ïö∞Ï∏° Í∞ÑÌä∏ Ï∞®Ìä∏ ÏòÅÏó≠Ïùò ÌñâÏùÑ Íµ¨Î∂Ñ
      if (rowIndex >= rows.length / 2) rowIndex = rowIndex - rows.length / 2;

      // ÌòÑÏû¨ Í∞ÑÌä∏Ï∞®Ìä∏ ÎÇ¥Ïùò ÏöîÏÜåÎì§Îßå ÏÑ†ÌÉù
      if ($taskNameElements.length > rowIndex + 1) { // +1ÏùÄ Ìó§Îçî Ï†úÏô∏
        var targetElement = $taskNameElements[rowIndex + 1];
        if (wrapperOffsetTop === null) wrapperOffsetTop = $wrapper.offset().top;
        var rowTop = $(targetElement).offset().top - wrapperOffsetTop;
        cursorEl.style.top = rowTop + 'px';
        cursorEl.style.height = cellHeight + 'px';
        cursorEl.style.display = 'block';
        return;
      }

      // fallback
      var rowTop = headerHeight + (rowIndex * cellHeight);
      cursorEl.style.top = rowTop + 'px';
      cursorEl.style.height = cellHeight + 'px';
      cursorEl.style.display = 'block';
    });

    $wrapper.on('mouseleave', function() {
      cursorEl.style.display = 'none';
      wrapperOffsetTop = null; // lazy Ï∫êÏã± Î¶¨ÏÖã
    });

  // Ìà¥ÌåÅ Í∏∞Îä•
  //setupTooltip();

});
</script>