<h1>일감을 자동배치할 대상을 선택해 주세요 </h1>
<span style="color: #999;">추정 작업 시간이 기재되어 있어야 일감 자동 배치가 가능합니다.</span>
<br><br>
<%
  excluded_user_ids = TxBaseHelper.config_arr('e_users')
  users = User.active
    .where.not(id: excluded_user_ids)
    .distinct #.select{ |u| (u.group_ids & excluded_group_ids).empty? }

  groups = {}

  excluded_group_ids = TxBaseHelper.config_arr('e_group') || []
  all_groups = Group.all.select{ |group| !excluded_group_ids.include?(group.id) }

  all_groups.each do |group|
    # @users의 순서를 유지하면서 해당 그룹의 사용자만 필터링
    groups[ group ] = users.select { |user| group.users.map(&:id).include?(user.id) }
  end
%>

<!-- 그룹 탭 리스트 -->
<div class="tabs">
  <ul>
    <% groups.each { |group, users| %>
      <li><%= link_to(group.name, "#group-#{group.id}", class: (params[:group_id] == group.id.to_s ? 'selected' : '')) %></li>
    <% } %>
  </ul>
</div>

<% groups.each { |group, users| %>
  <h2 id="group-<%= group.id %>"><%= group.name %></h2>
  <table class="list">
    <thead>
      <tr>
        <th>사용자명</th>
        <th>일정 확정 일감</th>
        <th>일정 미확정 일감</th>
        <th>추정 작업 시간 기재된 일감</th>
        <th>액션</th>
      </tr>
    </thead>
    <tbody>
             <% users.each { |user| info = RedmineTxMilestoneHelper.analyze_issues( Issue.where( assigned_to_id: user.id ).where( status_id: ( IssueStatus.in_progress_ids + IssueStatus.new_ids ).uniq ) ) %>
         <tr class="<%= cycle('odd', 'even') %>">
           <td><%= link_to_principal(user) %></td>          
           <td>
             <% if info[:fixed_issues].count == 0 %>
               <span style="color: red; font-weight: bold;"><%= info[:fixed_issues].count %></span>
             <% else %>
               <%= info[:fixed_issues].count %>
             <% end %>
           </td>
           <td>
             <% if info[:other_issues].count >= 10 %>
               <span style="color: red; font-weight: bold;"><%= info[:other_issues].count %></span>
             <% else %>
               <%= info[:other_issues].count %>
             <% end %>
           </td>
           <td>
             <% if info[:candidate_issues].count == 0 %>
               <span style="color: #999;"><%= info[:candidate_issues].count %></span>
             <% else %>
               <%= info[:candidate_issues].count %>
             <% end %>
           </td>
           <td>
             <% if info[:candidate_issues].count > 0 %>
               <%= link_to("자동배치", "tetris/users/#{user.id}", class: "button button-small") %>
             <% else %>
               <span class="button button-small disabled" style="color: #999; cursor: not-allowed;">자동배치</span>
             <% end %>
           </td>
         </tr>
      <% } %>
    </tbody>
  </table>
  <br>
<% } %>