<style>
/* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í„°ë§ˆì´ì§• */
.roadmap-timeline::-webkit-scrollbar,
.roadmap-sidebar::-webkit-scrollbar,
.timeline-body::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

.roadmap-timeline::-webkit-scrollbar-track,
.roadmap-sidebar::-webkit-scrollbar-track,
.timeline-body::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.roadmap-timeline::-webkit-scrollbar-thumb,
.roadmap-sidebar::-webkit-scrollbar-thumb,
.timeline-body::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 4px;
}

.roadmap-timeline::-webkit-scrollbar-thumb:hover,
.roadmap-sidebar::-webkit-scrollbar-thumb:hover,
.timeline-body::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* Firefox ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
.roadmap-timeline,
.roadmap-sidebar,
.timeline-body {
  scrollbar-color: #c1c1c1 #f1f1f1;
}

.roadmap-container {
  display: flex;
  border: 1px solid #ddd;
  background: #fff;
  height: calc(100vh - 200px); /* ë¸Œë¼ìš°ì € ë†’ì´ì—ì„œ ì—¬ë°±ì„ ëº€ ê³ ì • ë†’ì´ */
  min-height: 600px; /* ìµœì†Œ ë†’ì´ ì„¤ì • */
  overflow: hidden; /* ì»¨í…Œì´ë„ˆ ìì²´ì˜ ìŠ¤í¬ë¡¤ ë°©ì§€ */
}

.roadmap-sidebar {
  width: 300px;
  min-width: 300px;
  background: #f8f9fa;
  border-right: 1px solid #ddd;
  overflow: hidden; /* ì‚¬ì´ë“œë°” ìì²´ëŠ” ìŠ¤í¬ë¡¤ ì—†ìŒ */
  height: 100%; /* ì»¨í…Œì´ë„ˆ ë†’ì´ì— ë§ì¶¤ */
  display: flex;
  flex-direction: column;
}

.sidebar-content {
  flex: 1;
  overflow-y: auto; /* ì‚¬ì´ë“œë°” ë‚´ìš© ë¶€ë¶„ë§Œ ìŠ¤í¬ë¡¤ */
  overflow-x: hidden;
}

.roadmap-timeline {
  flex: 1;
  overflow-x: auto; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš© */
  overflow-y: auto; /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš© */
  height: 100%; /* ì»¨í…Œì´ë„ˆ ë†’ì´ì— ë§ì¶¤ */
  display: flex;
  flex-direction: column;
}

.roadmap-timeline-inner {
  min-width: 1500px;
  height: 100%; /* íƒ€ì„ë¼ì¸ ë†’ì´ì— ë§ì¶¤ */
  display: flex;
  flex-direction: column;
}

/* í—¤ë” ìŠ¤íƒ€ì¼ */
.timeline-header {
  height: 80px;
  border-bottom: 1px solid #ddd;
  background: #fff;
  position: sticky;
  top: 0;
  z-index: 10;
  flex-shrink: 0; /* í—¤ë” ë†’ì´ ê³ ì • */
  min-width: 1500px; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ê³¼ í•¨ê»˜ ì›€ì§ì´ë„ë¡ */
}

.month-header {
  display: flex;
  height: 40px;
  border-bottom: 1px solid #ccc;
}

.day-header {
  display: flex;
  height: 40px;
}

.month-cell, .day-cell {
  border-right: 1px solid #eee;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  background: #f8f9fa;
}

.day-cell {
    color: #bbbbbb;
    border-bottom: 1px solid #ccc;
}

/* ì£¼ë§ ë‚ ì§œ ìƒ‰ìƒ */
.day-cell.saturday {
    color: #33bbff; /* í† ìš”ì¼ - íŒŒë€ìƒ‰ */
}

.day-cell.sunday {
    color: #ff8888; /* ì¼ìš”ì¼ - ë¹¨ê°„ìƒ‰ */
    border-right: 2px solid #ddd;
}

.month-cell {
  border-left: 1px solid #ccc;
  border-right: 1px solid #ccc;
  background: #e9ecef;
  font-size: 14px;
}

.day-cell:first-child {
  border-left: 1px solid #ccc;
}

.day-cell:last-child {
  border-right: 1px solid #ccc;
}

/* ì¹´í…Œê³ ë¦¬ í† ê¸€ì„ ìœ„í•œ ìˆ¨ê¹€ í´ë˜ìŠ¤ */
.timeline-row.hidden,
.project-item.hidden {
  display: none !important;
}

/* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
.sidebar-header {
  height: 80px; /* íƒ€ì„ë¼ì¸ í—¤ë”ì™€ ë™ì¼í•œ ë†’ì´ */
  border-bottom: 1px solid #ddd;
  display: flex;
  align-items: center;
  justify-content: space-between; /* ì œëª©ê³¼ ë²„íŠ¼ì„ ì–‘ìª½ ëì— ë°°ì¹˜ */
  padding: 0 15px;
  font-weight: bold;
  background: #e9ecef;
  flex-shrink: 0; /* í—¤ë” ë†’ì´ ê³ ì • */
  position: sticky;
  top: 0;
  z-index: 11; /* íƒ€ì„ë¼ì¸ í—¤ë”ë³´ë‹¤ ë†’ê²Œ ì„¤ì • */
}

.sidebar-title {
  flex: 1;
}

.add-category-btn {
  width: 32px;
  height: 32px;
  border: none;
  border-radius: 6px;
  background: #28a745;
  color: white;
  font-size: 18px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  margin-left: 10px;
}

.add-category-btn:hover {
  background: #218838;
  transform: scale(1.05);
}

.add-category-btn:active {
  transform: scale(0.95);
}

/* ì¹´í…Œê³ ë¦¬ í—¤ë” - ì¸ë¼ì¸ í¸ì§‘ ì§€ì› */
.category-header {
  background: #d1ecf1;
  padding: 8px 15px;
  font-weight: bold;
  font-size: 11px;
  color: #0c5460;
  border-bottom: 1px solid #bee5eb;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-sizing: border-box;
  position: relative;
}

.category-left {
  display: flex;
  align-items: center;
  flex: 1;
}

.category-toggle-btn {
  width: 14px;
  height: 14px;
  border: none;
  background: transparent;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  color: #0c5460;
  margin-right: 8px;
  padding: 0;
  line-height: 1;
}

.category-toggle-btn.collapsed {
  transform: rotate(-90deg);
}

.category-title {
  cursor: pointer;
  flex: 1;
}

/* ì¹´í…Œê³ ë¦¬ í¸ì§‘ í¼ - ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
.category-edit-form {
  display: none;
  flex: 1;
  margin-left: 22px; /* í† ê¸€ ë²„íŠ¼ ê³µê°„ë§Œí¼ */
}

.category-edit-input {
  width: 100%;
  border: 1px solid #007cba;
  background: white;
  padding: 2px 6px;
  font-size: 11px;
  font-weight: bold;
  color: #0c5460;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  outline: none;
  border-radius: 2px;
}

.category-edit-input:focus {
  border-color: #005a8b;
  box-shadow: 0 0 3px rgba(0, 124, 186, 0.3);
}

/* ì¹´í…Œê³ ë¦¬ ì•¡ì…˜ ë²„íŠ¼ë“¤ */
.category-actions {
  display: flex;
  gap: 4px;
  margin-left: 8px;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.category-header:hover .category-actions {
  opacity: 1;
}

/* í¸ì§‘ ëª¨ë“œì¼ ë•ŒëŠ” í•­ìƒ í‘œì‹œí•˜ì§€ ì•ŠìŒ */
.category-header.editing .category-actions {
  display: none !important;
}

/* í¸ì§‘ ì•¡ì…˜ ë²„íŠ¼ë“¤ - í¸ì§‘ ëª¨ë“œì—ì„œë§Œ í‘œì‹œ */
.category-edit-actions {
  display: none;
  gap: 4px;
  margin-left: 8px;
}

.category-header.editing .category-edit-actions {
  display: flex;
}

.category-btn {
  width: 20px;
  height: 20px;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  transition: all 0.2s;
  opacity: 0.7;
}

.category-btn:hover {
  opacity: 1;
  transform: scale(1.1);
}

.add-event-btn {
  background: #17a2b8;
  color: white;
  font-size: 14px;
  font-weight: bold;
}

.edit-category-btn {
  background: #ffc107;
  color: #212529;
}

.color-category-btn {
  background: #6f42c1;
  color: white;
}

.delete-category-btn {
  background: #dc3545;
  color: white;
}

.save-category-btn {
  background: #28a745;
  color: white;
}

.cancel-category-btn {
  background: #6c757d;
  color: white;
}

/* í”„ë¡œì íŠ¸ ì•„ì´í…œ ìŠ¤íƒ€ì¼ - íƒ€ì„ë¼ì¸ê³¼ ë†’ì´ ë§ì¶¤ */
.project-item {
  height: 50px; /* íƒ€ì„ë¼ì¸ í–‰ê³¼ ë™ì¼í•œ ë†’ì´ */
  border-bottom: 1px solid #eee; /* êµ¬ë¶„ì„  ì¶”ê°€ */
  display: flex;
  align-items: center;
  padding: 0 15px;
  cursor: pointer;
  box-sizing: border-box;
  background: #fff; /* ë°°ê²½ìƒ‰ ëª…ì‹œ */
  position: relative;
}

.project-item:hover {
  background: #f0f0f0;
}

.event-content {
  flex: 1;
}

.project-name {
  font-size: 14px;
  color: #333;
  font-weight: 500;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.project-info {
  font-size: 11px;
  color: #666;
  margin-top: 2px;
}

/* ì´ë²¤íŠ¸ í¸ì§‘ í¼ */
.event-edit-form {
  display: none;
  flex: 1;
  margin-right: 8px;
}

.event-edit-input {
  width: 100%;
  padding: 4px 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 13px;
  resize: vertical;
  min-height: 20px;
  font-family: inherit;
  line-height: 1.2;
}

/* ì´ë²¤íŠ¸ ì•¡ì…˜ ë²„íŠ¼ë“¤ */
.event-actions {
  display: flex;
  gap: 4px;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.project-item:hover .event-actions {
  opacity: 1;
}

.event-edit-actions {
  display: none;
  gap: 4px;
}

.event-btn {
  width: 20px;
  height: 20px;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  transition: all 0.2s;
  opacity: 0.7;
}

.event-btn:hover {
  opacity: 1;
  transform: scale(1.1);
}

.edit-event-btn {
  background: #ffc107;
  color: #212529;
}

.delete-event-btn {
  background: #dc3545;
  color: white;
}

.save-event-btn {
  background: #28a745;
  color: white;
}

.cancel-event-btn {
  background: #6c757d;
  color: white;
}

/* ì´ë²¤íŠ¸ í¸ì§‘ ëª¨ë“œ */
.project-item.editing .event-content {
  display: none;
}

.project-item.editing .event-edit-form {
  display: flex;
}

.project-item.editing .event-actions {
  display: none;
}

.project-item.editing .event-edit-actions {
  display: flex;
}

/* ì´ë²¤íŠ¸ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìŠ¤íƒ€ì¼ */
.project-item.dragging {
  opacity: 0.5;
  z-index: 1000;
  background: #e3f2fd;
  border: 2px dashed #2196f3;
  cursor: move;
}

.category-header.drop-zone {
  background: #e8f5e8 !important;
  border: 2px dashed #28a745 !important;
  color: #155724 !important;
}

.category-header.drop-zone::after {
  content: "ì—¬ê¸°ì— ë“œë¡­í•˜ì„¸ìš”";
  position: absolute;
  right: 15px;
  font-size: 12px;
  color: #28a745;
  font-weight: normal;
}

.category-header.drop-zone-hover {
  background: #d4edda !important;
  border: 2px solid #28a745 !important;
  color: #155724 !important;
  box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
}

/* ì´ë²¤íŠ¸ ì•„ì´í…œ ë“œë¡­ ì¡´ ìŠ¤íƒ€ì¼ */
.project-item.drop-zone {
  background: #fff3cd !important;
  border: 2px dashed #ffc107 !important;
  color: #856404 !important;
}

.project-item.drop-zone-hover {
  background: #ffeaa7 !important;
  border: 2px solid #ffc107 !important;
  color: #856404 !important;
  box-shadow: 0 2px 4px rgba(255, 193, 7, 0.2);
}

.project-item.drop-zone::after {
  content: "ì—¬ê¸°ì— ìˆœì„œ ë³€ê²½";
  position: absolute;
  right: 15px;
  font-size: 11px;
  color: #ffc107;
  font-weight: normal;
}

.project-item.drag-helper {
  position: absolute;
  z-index: 1001;
  background: #fff;
  border: 1px solid #ddd;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  border-radius: 4px;
  padding: 8px 12px;
  font-size: 12px;
  color: #333;
  pointer-events: none;
}

/* ì¹´í…Œê³ ë¦¬ ë“œë˜ê·¸ ìŠ¤íƒ€ì¼ */
.category-header.dragging {
  opacity: 0.5;
}

.category-header.drag-helper {
  position: absolute;
  z-index: 1001;
  background: #d1ecf1;
  border: 1px solid #bee5eb;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  border-radius: 4px;
  padding: 8px 15px;
  font-size: 11px;
  font-weight: bold;
  color: #0c5460;
  pointer-events: none;
}

.category-header.category-drop-zone {
  position: relative;
}

.category-header.category-drop-zone-hover {
  background: #b8daff !important;
  border: 2px solid #0056b3 !important;
  color: #004085 !important;
  box-shadow: 0 2px 4px rgba(0, 86, 179, 0.2);
}

/* ì¹´í…Œê³ ë¦¬ ë“œë¡­ ìœ„ì¹˜ í‘œì‹œ */
.category-header.drop-before::before {
  content: "";
  position: absolute;
  top: -2px;
  left: 0;
  right: 0;
  height: 3px;
  background: #0056b3;
  z-index: 1000;
}

.category-header.drop-after::after {
  content: "";
  position: absolute;
  bottom: -2px;
  left: 0;
  right: 0;
  height: 3px;
  background: #0056b3;
  z-index: 1000;
}

/* ì¹´í…Œê³ ë¦¬ íƒ€ì´í‹€ ë“œë˜ê·¸ ì»¤ì„œ */
.category-title {
  cursor: move;
}

/* íƒ€ì„ë¼ì¸ ë°”ë”” */
.timeline-body {
  position: relative;
  flex: 1; /* í—¤ë”ë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ê³µê°„ ì°¨ì§€ */
  overflow-y: auto; /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš© */
  overflow-x: hidden; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ì€ ìƒìœ„ ì»¨í…Œì´ë„ˆì—ì„œ ì²˜ë¦¬ */
  min-width: 1500px; /* ìµœì†Œ ë„ˆë¹„ ì„¤ì • */
}

/* ì¹´í…Œê³ ë¦¬ í–‰ ìŠ¤íƒ€ì¼ - ì‚¬ì´ë“œë°”ì™€ ë†’ì´ ë§ì¶¤ */
.timeline-row.category-row {
  height: 30px; /* ì‚¬ì´ë“œë°” ì¹´í…Œê³ ë¦¬ í—¤ë”ì™€ ë™ì¼í•œ ë†’ì´ */
  background-color: #f5f5f5;
  border-bottom: 1px solid #bee5eb; /* ì¹´í…Œê³ ë¦¬ í—¤ë”ì™€ ë™ì¼í•œ êµ¬ë¶„ì„  */
  box-sizing: border-box;
}

.timeline-row.category-row .timeline-grid {
  background-color: transparent;
}

.timeline-row {
  height: 50px; /* ì‚¬ì´ë“œë°” í”„ë¡œì íŠ¸ ì•„ì´í…œê³¼ ë™ì¼í•œ ë†’ì´ */
  border-bottom: 1px solid #eee; /* êµ¬ë¶„ì„  ì¶”ê°€ */
  position: relative;
  box-sizing: border-box;
  z-index: 300;
  pointer-events: auto; /* ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ í™œì„±í™” - ì…€ í´ë¦­ì„ ìœ„í•´ */
  overflow: visible; /* absolute ìš”ì†Œë“¤ì´ ë³´ì´ë„ë¡ */
}

.timeline-grid {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  pointer-events: auto; /* ê·¸ë¦¬ë“œ í´ë¦­ ì´ë²¤íŠ¸ í™œì„±í™” */
}

.timeline-cell {
  border-right: 1px solid #f0f0f0;
  height: 100%;
  pointer-events: auto; /* ì…€ í´ë¦­ ì´ë²¤íŠ¸ í™œì„±í™” */
}

.timeline-cell:first-child {
  border-left: 1px solid #ccc;
}

.timeline-cell:last-child {
  border-right: 1px solid #ccc;
}

/* ìŠ¤ì¼€ì¤„ ì¶”ê°€ ê°€ëŠ¥í•œ ì…€ ìŠ¤íƒ€ì¼ */
.schedule-add-target {
  cursor: pointer;
  transition: background-color 0.2s;
  pointer-events: auto; /* í´ë¦­ ì´ë²¤íŠ¸ í™œì„±í™” */
}

.schedule-add-target:hover {
  background-color: rgba(23, 162, 184, 0.1);
  border-color: rgba(23, 162, 184, 0.3);
}

/* í”„ë¡œì íŠ¸ ë°” */
.project-bar {
  position: absolute !important; /* ê°•ì œë¡œ absolute positioning ì ìš© */
  height: 46px;
  top: 2px !important; /* ê°•ì œë¡œ ê°™ì€ ìœ„ì¹˜ì— ë°°ì¹˜ */
  border-radius: 4px;
  padding: 0 8px;
  color: white;
  font-size: 12px;
  font-weight: bold;
  cursor: move; /* ë“œë˜ê·¸ ê°€ëŠ¥í•¨ì„ í‘œì‹œ */
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  transition: all 0.2s;
  user-select: none; /* í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
  pointer-events: auto; /* ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ í™œì„±í™” ë³´ì¥ */
  z-index: 200; /* ì…€ë³´ë‹¤ ë†’ì€ z-indexë¡œ ì„¤ì • */
  line-height: 1.2; /* ì¤„ë°”ê¿ˆ ì§€ì›ì„ ìœ„í•œ line-height ì¡°ì • */
  white-space: pre-wrap; /* ì¤„ë°”ê¿ˆ í—ˆìš© */
  overflow: hidden; /* ë„˜ì¹˜ëŠ” í…ìŠ¤íŠ¸ ìˆ¨ê¹€ */
  text-overflow: ellipsis; /* ë„˜ì¹˜ëŠ” í…ìŠ¤íŠ¸ë¥¼ ... ìœ¼ë¡œ í‘œì‹œ */
  float: none !important; /* float ì†ì„± ì œê±° */
  display: flex !important; /* flexboxë¡œ ë³€ê²½í•˜ì—¬ ì¤‘ì•™ ì •ë ¬ */
  align-items: center; /* ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ */
  justify-content: flex-start; /* ì¢Œì¸¡ ì •ë ¬ */
  word-wrap: break-word; /* ê¸´ ë‹¨ì–´ ì¤„ë°”ê¿ˆ */
  text-align: left; /* í…ìŠ¤íŠ¸ ì¢Œì¸¡ ì •ë ¬ */
}

.project-bar-text {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: pre-wrap;
  word-wrap: break-word;
  line-height: 1.2;
}

.project-bar:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  z-index: 9999 !important; /* í˜¸ë²„ ì‹œ ìµœìƒìœ„ë¡œ ì˜¬ë¼ì˜´ */
}

.project-bar.ui-draggable-dragging {
  z-index: 10000 !important; /* ë“œë˜ê·¸ ì¤‘ ìµœìƒìœ„ */
  opacity: 0.8;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}

/* ë‚ ì§œ ë¯¸ì • í”„ë¡œì íŠ¸ ìŠ¤íƒ€ì¼ */
.project-bar-placeholder {
  height: 100%;
  opacity: 0.3;
}

/* í”„ë¡œì íŠ¸ ìƒíƒœë³„ ìƒ‰ìƒ */
.status-planning { background-color: #6c757d; }
.status-in-progress { background-color: #28a745; }
.status-review { background-color: #ffc107; color: #000; }
.status-completed { background-color: #dc3545; }
.status-on-hold { background-color: #6f42c1; }

/* ì»¤ìŠ¤í…€ ìƒ‰ìƒì´ ì ìš©ëœ í”„ë¡œì íŠ¸ ë°” */
.project-bar.custom-color {
  /* ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë¡œ background-colorê°€ ì„¤ì •ë¨ */
  color: white;
}

/* ì»¤ìŠ¤í…€ ìƒ‰ìƒ ë°”ì˜ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ìë™ ì¡°ì • */
.project-bar.custom-color.light-background {
  color: #333;
}

/* ì˜¤ëŠ˜ í‘œì‹œ */
.today-line {
  position: absolute;
  top: -50px;
  height: calc(100% + 50px); /* ë™ì ìœ¼ë¡œ ëŠ˜ì–´ë‚˜ëŠ” íƒ€ì„ë¼ì¸ ë†’ì´ì— ë§ì¶¤ */
  width: 2px;
  background-image: linear-gradient(to bottom, #ff4757 50%, transparent 50%);
  background-size: 2px 8px;
  background-repeat: repeat-y;
  z-index: 555;
  pointer-events: none;
}

.today-marker {
  position: absolute;
  top: -8px;
  left: -6px;
  width: 14px;
  height: 14px;
  background-color: #ff4757;
  border-radius: 50%;
}

/* ìŠ¤ì¼€ì¤„ ì¶”ê°€ íŒì—… */
.schedule-popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1002;
  display: none;
  align-items: center;
  justify-content: center;
}

.schedule-popup-overlay.show {
  display: flex;
}

.schedule-popup {
  background: white;
  border-radius: 12px;
  padding: 24px;
  min-width: 500px;
  max-width: 600px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  animation: popupFadeIn 0.3s ease-out;
  max-height: 90vh;
  overflow-y: auto;
}

.schedule-popup-header {
  font-size: 20px;
  font-weight: bold;
  margin-bottom: 20px;
  color: #333;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 2px solid #e9ecef;
  padding-bottom: 12px;
}

.schedule-popup-icon {
  font-size: 24px;
}

.schedule-event-info {
  margin-left: auto;
  text-align: right;
  font-size: 14px;
  color: #666;
}

.schedule-event-name {
  display: block;
  font-weight: bold;
  color: #333;
}

.schedule-category-name {
  display: block;
  font-size: 12px;
  color: #888;
}

.schedule-form {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.form-row {
  display: flex;
  gap: 12px;
}

.form-group-half {
  flex: 1;
}

.duration-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.duration-btn {
  padding: 4px 8px;
  border: 2px solid #17a2b8;
  background: white;
  color: #17a2b8;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s;
  flex: 1;
  min-width: 80px;
  height: 30px;
}

.duration-btn:hover {
  background: #17a2b8;
  color: white;
  transform: translateY(-1px);
}

.duration-btn:active {
  transform: translateY(0);
}

/* ì‚­ì œ í™•ì¸ íŒì—… */
.delete-confirm-popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1001;
  display: none;
  align-items: center;
  justify-content: center;
}

.delete-confirm-popup {
  background: white;
  border-radius: 8px;
  padding: 24px;
  min-width: 400px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  animation: popupFadeIn 0.2s ease-out;
}

.delete-confirm-header {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 16px;
  color: #dc3545;
  display: flex;
  align-items: center;
  gap: 8px;
}

.delete-confirm-icon {
  font-size: 24px;
}

.delete-confirm-message {
  margin-bottom: 20px;
  color: #333;
  line-height: 1.5;
}

.delete-confirm-category {
  font-weight: bold;
  color: #dc3545;
  background: #f8d7da;
  padding: 4px 8px;
  border-radius: 4px;
  display: inline-block;
}

.delete-confirm-buttons {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

/* ê°€ë¡œ ìŠ¤í¬ë¡¤ë°”ë§Œ í‘œì‹œ */
.roadmap-timeline::-webkit-scrollbar {
  height: 12px;
}

.roadmap-timeline::-webkit-scrollbar-track {
  background: #f1f1f1;
}

.roadmap-timeline::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 6px;
}

/* ì „ì²´ í˜ì´ì§€ ìŠ¤í¬ë¡¤ ì œì–´ */
body.roadmap-view {
  overflow-x: hidden; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
  overflow-y: auto; /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ì€ í˜ì´ì§€ ì „ì²´ì—ì„œë§Œ */
}

/* ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ìŠ¤íƒ€ì¼ */
.project-bar .ui-resizable-handle {
  position: absolute;
  background: rgba(0, 0, 0, 0.1);
  transition: background-color 0.2s;
}

.project-bar .ui-resizable-w {
  left: -2px;
  top: 0;
  bottom: 0;
  width: 4px;
  cursor: w-resize;
}

.project-bar .ui-resizable-e {
  right: -2px;
  top: 0;
  bottom: 0;
  width: 4px;
  cursor: e-resize;
}

.project-bar:hover .ui-resizable-handle,
.project-bar.ui-resizable-resizing .ui-resizable-handle {
  background: rgba(0, 0, 0, 0.3);
}

.project-bar.ui-resizable-resizing {
  opacity: 0.8;
  z-index: 10000 !important; /* ë¦¬ì‚¬ì´ì¦ˆ ì¤‘ ìµœìƒìœ„ */
}

/* ë‚ ì§œ êµ¬ë¶„ì„  ìŠ¤íƒ€ì¼ */
.date-grid-lines {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 300;
  pointer-events: none;
}

.date-grid-line {
  position: absolute;
  top: 0;
  height: 100%; /* ë™ì ìœ¼ë¡œ ëŠ˜ì–´ë‚˜ëŠ” íƒ€ì„ë¼ì¸ ë†’ì´ì— ë§ì¶¤ */
  width: 0px;
  background-color: #eee;
  border-left: 1px solid #eee;
}

.monday-line {
  width: 1px;
}

/* ê¸°ì¡´ timeline-cell border ì œê±° */
.timeline-cell {
  border-right: none;
  position: relative;
  z-index: 50;
}

.timeline-grid {
  position: relative;
  z-index: 50;
}



/* ì¹´í…Œê³ ë¦¬ ì¶”ê°€ íŒì—… */
.category-popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  display: none;
  align-items: center;
  justify-content: center;
}

.category-popup {
  background: white;
  border-radius: 8px;
  padding: 24px;
  min-width: 400px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  animation: popupFadeIn 0.2s ease-out;
}

@keyframes popupFadeIn {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.popup-header {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 16px;
  color: #333;
}

.popup-form {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.form-label {
  font-weight: bold;
  color: #555;
  font-size: 14px;
}

.form-input {
  padding: 10px 12px;
  border: 2px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
  transition: border-color 0.2s;
}

.form-input:focus {
  outline: none;
  border-color: #28a745;
}

.popup-buttons {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  margin-top: 8px;
}

.popup-btn {
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s;
}

.popup-btn-primary {
  background: #28a745;
}

.popup-btn-primary:hover {
  background: #218838;
}

.popup-btn-secondary {
  background: #6c757d;
  color: white;
}

.popup-btn-secondary:hover {
  background: #5a6268;
}

.popup-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* ì´ë²¤íŠ¸ ì¶”ê°€ íŒì—… - ì¤‘ì•™ ì •ë ¬ ìˆ˜ì • */
.event-popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1002;
  display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
  align-items: center;
  justify-content: center;
}

.event-popup-overlay.show {
  display: flex; /* í‘œì‹œí•  ë•Œ flexë¡œ ë³€ê²½ */
}

.event-popup {
  background: white;
  border-radius: 8px;
  padding: 24px;
  min-width: 500px;
  max-width: 600px;
  max-height: 90vh; /* í™”ë©´ ë†’ì´ì˜ 90% ì œí•œ */
  overflow-y: auto; /* ë‚´ìš©ì´ ë§ì„ ê²½ìš° ìŠ¤í¬ë¡¤ */
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  animation: popupFadeIn 0.2s ease-out;
  position: relative; /* ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ ê¸°ì¤€ì  */
}



.event-popup-header {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 16px;
  color: #333;
  display: flex;
  align-items: center;
  gap: 8px;
}

.event-popup-icon {
  font-size: 20px;
  color: #17a2b8;
}

.event-category-name {
  color: #17a2b8;
  background: #d1ecf1;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.event-form {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.form-row {
  display: flex;
  gap: 16px;
}

.form-row .form-group {
  flex: 1;
}

.date-input {
  padding: 8px 10px;
  border: 2px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
  transition: border-color 0.2s;
}

.date-input:focus {
  outline: none;
  border-color: #17a2b8;
}

.status-select {
  padding: 8px 10px;
  border: 2px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
  background: white;
  transition: border-color 0.2s;
}

.status-select:focus {
  outline: none;
  border-color: #17a2b8;
}

/* ìŠ¤ì¼€ì¤„ í¸ì§‘ íŒì—… */
.schedule-edit-popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1003;
  display: none;
  align-items: center;
  justify-content: center;
}

.schedule-edit-popup-overlay.show {
  display: flex;
}

.schedule-edit-popup {
  background: white;
  border-radius: 8px;
  padding: 24px;
  min-width: 450px;
  max-width: 500px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  animation: popupFadeIn 0.2s ease-out;
}

.schedule-edit-header {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 16px;
  color: #333;
  display: flex;
  align-items: center;
  gap: 8px;
}

.schedule-edit-icon {
  font-size: 20px;
  color: #ffc107;
}

.schedule-edit-info {
  margin-bottom: 20px;
  padding: 12px;
  background: #f8f9fa;
  border-radius: 4px;
  border-left: 4px solid #ffc107;
}

.schedule-edit-event-name {
  font-weight: bold;
  color: #333;
  margin-bottom: 4px;
}

.schedule-edit-category-name {
  color: #6c757d;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.schedule-edit-form {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.schedule-edit-buttons {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  margin-top: 8px;
}

.schedule-edit-btn {
  padding: 4px 16px;
  border: none;
  border-radius: 4px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  height: 30px;
}

.schedule-cancel-btn {
  background: #6c757d;
  color: white;
}

.schedule-cancel-btn:hover {
  background: #5a6268;
}

.schedule-save-btn {
  background: #28a745;
  border: 1px solid #666666;
  color: black;
}

.schedule-save-btn:hover {
  background: #218838;
}

.schedule-delete-btn {
  background: #dc3545;
  color: white;
}

.schedule-delete-btn:hover {
  background: #c82333;
}

/* JSON ê´€ë¦¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.json-controls {
  position: fixed;
  bottom: 20px;
  right: 20px;
  display: flex;
  flex-direction: row;
  gap: 10px;
  z-index: 1000;
}

.json-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 6px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  justify-content: center;
}

.json-export-btn {
  background: linear-gradient(135deg, #28a745, #20c997);
  color: white;
}

.json-export-btn:hover {
  background: linear-gradient(135deg, #218838, #1ea085);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.json-import-btn {
  background: linear-gradient(135deg, #007bff, #6f42c1);
  color: white;
}

.json-import-btn:hover {
  background: linear-gradient(135deg, #0056b3, #5a2d91);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.json-load-btn {
  background: linear-gradient(135deg, #17a2b8, #20c997);
  color: white;
}

.json-load-btn:hover {
  background: linear-gradient(135deg, #138496, #1ea085);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.json-save-btn {
  background: linear-gradient(135deg, #fd7e14, #e83e8c);
  color: white;
}

.json-save-btn:hover {
  background: linear-gradient(135deg, #e8650e, #d91a72);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.json-xlsx-btn {
  background: linear-gradient(135deg, #28a745, #6f42c1);
  color: white;
}

.json-xlsx-btn:hover {
  background: linear-gradient(135deg, #218838, #5a2d91);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.json-png-btn {
  background: linear-gradient(135deg, #ff6b6b, #ffa726);
  color: white;
}

.json-png-btn:hover {
  background: linear-gradient(135deg, #ff5252, #ff9800);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.json-btn-icon {
  font-size: 16px;
}

.json-btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* ìƒ‰ìƒ í‘œì‹œ UI */
.schedule-color-display {
  display: flex;
  align-items: center;
  gap: 12px;
}

.color-preview {
  display: inline-block;
  width: 32px;
  height: 32px;
  border-radius: 4px;
  border: 1px solid #ddd;
  cursor: pointer;
}

.color-select-btn {
  padding: 6px 12px;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
  cursor: pointer;
  font-size: 13px;
  transition: all 0.2s;
}

.color-select-btn:hover {
  background: #f8f9fa;
  border-color: #007bff;
  color: #007bff;
}

.reset-color-btn {
  padding: 6px 12px;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
  cursor: pointer;
  font-size: 13px;
  color: #666;
  transition: all 0.2s;
}

.reset-color-btn:hover {
  background: #f8f9fa;
  border-color: #007bff;
  color: #007bff;
}

/* ìƒ‰ìƒ ì„ íƒ íŒì—… ìŠ¤íƒ€ì¼ */
.color-picker-popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1004;
  display: none;
  align-items: center;
  justify-content: center;
}

.color-picker-popup-overlay.show {
  display: flex;
}

.color-picker-popup {
  background: white;
  border-radius: 12px;
  padding: 24px;
  min-width: 500px;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  animation: popupFadeIn 0.3s ease-out;
}

.color-picker-header {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 20px;
  color: #333;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 2px solid #e9ecef;
  padding-bottom: 12px;
}

.color-picker-icon {
  font-size: 24px;
}

.color-picker-category-info {
  margin-left: auto;
  text-align: right;
  font-size: 16px;
  color: #333;
}

.color-picker-category-name {
  display: block;
  font-weight: bold;
  color: #333;
  background: #d1ecf1;
  padding: 4px 12px;
  border-radius: 6px;
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.color-picker-content {
  margin-bottom: 20px;
}

.color-preset-section,
.color-custom-section,
.color-preview-section {
  margin-bottom: 24px;
}

.color-preset-section h4,
.color-custom-section h4,
.color-preview-section h4 {
  margin: 0 0 12px 0;
  font-size: 16px;
  color: #333;
  border-bottom: 1px solid #eee;
  padding-bottom: 6px;
}

.color-preset-grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 8px;
}

.color-preset-item {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  border: 3px solid transparent;
  position: relative;
}

.color-preset-item:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.color-preset-item.selected {
  border-color: #007bff;
  transform: scale(1.1);
}

.color-preset-item.selected::after {
  content: 'âœ“';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  text-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
  font-weight: bold;
  font-size: 16px;
}

.color-custom-input {
  display: flex;
  align-items: center;
  gap: 12px;
}

.color-custom-input input[type="color"] {
  width: 60px;
  height: 40px;
  border: 2px solid #ddd;
  border-radius: 8px;
  cursor: pointer;
  background: none;
}

.color-custom-input label {
  font-weight: 500;
  color: #555;
}

.color-preview-bar {
  height: 46px;
  border-radius: 4px;
  padding: 0 12px;
  color: white;
  font-size: 14px;
  font-weight: bold;
  display: flex;
  align-items: center;
  background-color: #6c757d;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  transition: background-color 0.3s ease;
}

.color-picker-buttons {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  border-top: 1px solid #eee;
  padding-top: 16px;
}
</style>

<%
# ë‚ ì§œ ë²”ìœ„ ê³„ì‚° (ì´ì „ 3ê°œì›”ë¶€í„° ì•ìœ¼ë¡œ 12ê°œì›”)
start_date = Date.today.beginning_of_month - 3.months
end_date = Date.today.beginning_of_month + 16.months

# ì›”ë³„ ì •ë³´ ìƒì„±
months = []
current_month = start_date
while current_month <= end_date
  months << {
    date: current_month,
    name: current_month.strftime("%mì›”"),
    year: current_month.year,
    days: current_month.end_of_month.day
  }
  current_month = current_month.next_month
end

# ì¼ë³„ ì •ë³´ ìƒì„±
days = []
months.each do |month|
  (1..month[:days]).each do |day_num|
    day_date = Date.new(month[:year], month[:date].month, day_num)
    days << {
      date: day_date,
      day: day_num,
      month: month[:date].month,
      year: month[:year]
    }
  end
end

# ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì „ë‹¬ë°›ì€ ë°ì´í„° ì‚¬ìš©
all_projects = @all_projects || []

# ê° ì…€ì˜ ë„ˆë¹„ ê³„ì‚° (ì¼ ë‹¨ìœ„)
cell_width = 18
total_width = days.length * cell_width

# ì˜¤ëŠ˜ ìœ„ì¹˜ ê³„ì‚°
today_position = (Date.today - start_date).to_i * cell_width
%>

<div class="roadmap-container">
  <!-- ì‚¬ì´ë“œë°” -->
  <div class="roadmap-sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">í”„ë¡œì íŠ¸ ë¡œë“œë§µ</div>
      <button class="add-category-btn" id="addCategoryBtn" title="ì¹´í…Œê³ ë¦¬ ì¶”ê°€">
        +
      </button>
    </div>
    
    <div class="sidebar-content">
    <% all_projects.each_with_index do |category_group, category_index| %>
      <!-- ì¹´í…Œê³ ë¦¬ í—¤ë” -->
      <div class="category-header" data-category-index="<%= category_index %>">
        <div class="category-left">
          <button class="category-toggle-btn" title="ì ‘ê¸°/í¼ì¹˜ê¸°">â–¼</button>
          <div class="category-title"><%= category_group[:category] %></div>
        </div>
        <form class="category-edit-form">
          <input type="text" class="category-edit-input" value="<%= category_group[:category] %>">
        </form>
        <div class="category-actions">
          <button class="category-btn add-event-btn" title="ì´ë²¤íŠ¸ ì¶”ê°€">+</button>
          <button class="category-btn edit-category-btn" title="í¸ì§‘">âœï¸</button>
          <button class="category-btn color-category-btn" title="ìƒ‰ìƒ ë³€ê²½">ğŸ¨</button>
          <button class="category-btn delete-category-btn" title="ì‚­ì œ">ğŸ—‘ï¸</button>
        </div>
        <div class="category-edit-actions">
          <button class="category-btn save-category-btn" title="ì €ì¥">âœ“</button>
          <button class="category-btn cancel-category-btn" title="ì·¨ì†Œ">âœ•</button>
        </div>
      </div>
      
      <!-- ì¹´í…Œê³ ë¦¬ ë‚´ ì´ë²¤íŠ¸ë“¤ -->
      <% category_group[:events].each do |event| %>
        <div class="project-item" data-category-index="<%= category_index %>">
          <div class="event-content">
            <div class="project-name"><%= raw(event[:name].gsub(/\n/, '<br>')) %></div>
            <div class="project-info">
              <%= event[:schedules].size %>ê°œ ìŠ¤ì¼€ì¤„
            </div>
          </div>
          <form class="event-edit-form">
            <textarea class="event-edit-input"><%= event[:name] %></textarea>
          </form>
          <div class="event-actions">
            <button class="event-btn edit-event-btn" title="í¸ì§‘">âœï¸</button>
            <button class="event-btn delete-event-btn" title="ì‚­ì œ">ğŸ—‘ï¸</button>
          </div>
          <div class="event-edit-actions">
            <button class="event-btn save-event-btn" title="ì €ì¥">âœ“</button>
            <button class="event-btn cancel-event-btn" title="ì·¨ì†Œ">âœ•</button>
          </div>
        </div>
      <% end %>
    <% end %>
    </div>
  </div>

  <!-- íƒ€ì„ë¼ì¸ -->
  <div class="roadmap-timeline">
    <div class="roadmap-timeline-inner" style="width: <%= total_width %>px;">
      <!-- í—¤ë” -->
      <div class="timeline-header">
        <!-- ì›” í—¤ë” -->
        <div class="month-header">
          <% months.each do |month| %>
            <div class="month-cell" style="width: <%= cell_width * month[:days] %>px;">
              <%= month[:year] %>ë…„ <%= month[:name] %>
            </div>
          <% end %>
        </div>
        
        <!-- ì¼ í—¤ë” -->
        <div class="day-header">
          <% days.each_with_index do |day, index| %>
            <%
              # ìš”ì¼ í™•ì¸ (0: ì¼ìš”ì¼, 6: í† ìš”ì¼)
              wday = day[:date].wday
              weekend_class = case wday
                when 0 then 'sunday'     # ì¼ìš”ì¼
                when 6 then 'saturday'   # í† ìš”ì¼
                else ''
                end
            %>
            <div class="day-cell <%= weekend_class %>" style="width: <%= cell_width %>px;">
              <%= day[:day] %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- ë°”ë”” -->
      <div class="timeline-body">
        <!-- ë‚ ì§œ êµ¬ë¶„ì„  -->
        <div class="date-grid-lines">
          <% days.each_with_index do |day, index| %>
            <%
              # ì›”ìš”ì¼ì¸ì§€ í™•ì¸ (1: ì›”ìš”ì¼)
              monday_class = day[:date].wday == 1 ? 'monday-line' : ''
            %>
            <div class="date-grid-line <%= monday_class %>" style="left: <%= index * cell_width %>px;"></div>
          <% end %>
        </div>

        <!-- ì˜¤ëŠ˜ í‘œì‹œ -->
        <% if today_position >= 0 && today_position <= total_width %>
          <div class="today-line" style="left: <%= today_position %>px;">
            <div class="today-marker"></div>
          </div>
        <% end %>

        <!-- ê·¸ë¦¬ë“œì™€ í”„ë¡œì íŠ¸ ë°” -->
        <% all_projects.each do |category_group| %>
          <!-- ì¹´í…Œê³ ë¦¬ í—¤ë” (íƒ€ì„ë¼ì¸ ì˜ì—­ì—ì„œëŠ” ë¹ˆ í–‰ìœ¼ë¡œ í‘œì‹œ) -->
          <div class="timeline-row category-row">
            <div class="timeline-grid">
              <% days.each do |day| %>
                <div class="timeline-cell" style="width: <%= cell_width %>px;"></div>
              <% end %>
            </div>
          </div>
          
          <!-- ì¹´í…Œê³ ë¦¬ ë‚´ í”„ë¡œì íŠ¸ë“¤ -->
          <% category_group[:events].each_with_index do |project, index| %>
            <!-- DEBUG: ì´ë²¤íŠ¸ ì •ë³´ ì¶œë ¥ -->
            <!-- ì´ë²¤íŠ¸: <%= project[:name] %>, ìŠ¤ì¼€ì¤„ ìˆ˜: <%= project[:schedules].size %> -->
            <div class="timeline-row" data-event-name="<%= project[:name] %>" data-category-name="<%= category_group[:category] %>">
              <!-- ë°°ê²½ ê·¸ë¦¬ë“œ -->
              <div class="timeline-grid">
                <% days.each_with_index do |day, day_index| %>
                  <div class="timeline-cell schedule-add-target" 
                       style="width: <%= cell_width %>px;" 
                       data-date="<%= day[:date].strftime('%Y-%m-%d') %>"
                       data-day-index="<%= day_index %>"></div>
                <% end %>
              </div>

              <!-- í•´ë‹¹ ì´ë²¤íŠ¸ì˜ ëª¨ë“  ìŠ¤ì¼€ì¤„ ë°”ë“¤ -->
              <% project[:schedules].each_with_index do |schedule, schedule_index| %>
                <!-- DEBUG: ìŠ¤ì¼€ì¤„ ì •ë³´ - <%= schedule[:name] %> (ì¸ë±ìŠ¤: <%= schedule_index %>) -->
                <% if schedule[:start_date] && schedule[:end_date] %>
                  <%
                    project_start_days = (schedule[:start_date] - start_date).to_i
                    project_duration_days = (schedule[:end_date] - schedule[:start_date]).to_i  # ì¢…ë£Œì¼ ë¯¸í¬í•¨ ë°©ì‹
                    bar_left = project_start_days * cell_width
                    bar_width = project_duration_days * cell_width
                    
                    # ìµœì†Œ ë„ˆë¹„ëŠ” ì´ì œ í•„ìš”ì—†ìŒ (1ì¼ = cell_widthê°€ ìµœì†Œ)
                    # bar_width = [bar_width, 20].max
                    
                    # ê° ìŠ¤ì¼€ì¤„ì— ê³ ìœ í•œ z-index ë¶€ì—¬ (ì—­ìˆœìœ¼ë¡œ í•˜ì—¬ ë‚˜ì¤‘ ìŠ¤ì¼€ì¤„ì´ ìœ„ì— ì˜¤ë„ë¡)
                    z_index = 100 + (project[:schedules].length - schedule_index)
                %>
                
                <% if bar_left >= -bar_width && bar_left <= total_width %>
                  <%
                    # ì¹´í…Œê³ ë¦¬ ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì ìš©
                    custom_color = category_group[:customColor]
                    color_style = custom_color ? "background-color: #{custom_color};" : ""
                  %>
                    <div class="project-bar status-<%= schedule[:status] %>" 
                         style="position: absolute; top: 2px; left: <%= [0, bar_left].max %>px; width: <%= [bar_width, total_width - [0, bar_left].max].min %>px; z-index: <%= z_index %>; <%= color_style %>"
                         title="<%= schedule[:name] %> (<%= schedule[:start_date].strftime('%Y-%m-%d') %> ~ <%= schedule[:end_date].strftime('%Y-%m-%d') %>)"
                         data-project-id="<%= schedule[:version]&.id %>"
                         data-schedule-index="<%= schedule_index %>">
                      <span class="project-bar-text"><%= raw(truncate(schedule[:name], length: 20).gsub(/\n/, '<br>')) %></span>
                  </div>
                <% end %>
                <% end %>
              <% end %>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- ì¹´í…Œê³ ë¦¬ ì¶”ê°€ íŒì—… -->
<div class="category-popup-overlay" id="categoryPopup">
  <div class="category-popup">
    <div class="popup-header">ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</div>
    <form class="popup-form" id="categoryForm">
      <div class="form-group">
        <label class="form-label" for="categoryName">ì¹´í…Œê³ ë¦¬ ì´ë¦„</label>
        <input type="text" class="form-input" id="categoryName" placeholder="ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="50" required>
      </div>
      <div class="popup-buttons">
        <button type="button" class="popup-btn popup-btn-secondary" id="cancelBtn">ì·¨ì†Œ</button>
        <button type="submit" class="popup-btn popup-btn-primary" id="saveBtn">ì¶”ê°€</button>
      </div>
    </form>
  </div>
</div>

<!-- ì´ë²¤íŠ¸ ì¶”ê°€ íŒì—… -->
<div class="event-popup-overlay" id="eventPopup">
  <div class="event-popup">
    <div class="event-popup-header">
      <span class="event-popup-icon">ğŸ“…</span>
      ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€
      <span class="event-category-name" id="eventCategoryName"></span>
    </div>
    <form class="event-form" id="eventForm">
      <div class="form-group">
        <label class="form-label" for="eventName">ì´ë²¤íŠ¸ ì´ë¦„</label>
        <input type="text" class="form-input" id="eventName" placeholder="ì´ë²¤íŠ¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="100" required>
      </div>
      
      <div class="popup-buttons">
        <button type="button" class="popup-btn popup-btn-secondary" id="cancelEventBtn">ì·¨ì†Œ</button>
        <button type="submit" class="popup-btn popup-btn-primary" id="saveEventBtn">ì¶”ê°€</button>
      </div>
    </form>
  </div>
</div>

<!-- ìŠ¤ì¼€ì¤„ ì¶”ê°€ íŒì—… -->
<div class="schedule-popup-overlay" id="schedulePopup">
  <div class="schedule-popup">
    <div class="schedule-popup-header">
      <span class="schedule-popup-icon">ğŸ“‹</span>
      ìƒˆ ìŠ¤ì¼€ì¤„ ì¶”ê°€
      <div class="schedule-event-info">
        <span class="schedule-event-name" id="scheduleEventName"></span>
        <span class="schedule-category-name" id="scheduleCategoryName"></span>
      </div>
    </div>
    <form class="schedule-form" id="scheduleForm">
        <div class="form-group">
        <label class="form-label" for="scheduleName">ìŠ¤ì¼€ì¤„ ì´ë¦„</label>
        <textarea class="form-input" id="scheduleName" placeholder="ìŠ¤ì¼€ì¤„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="100" required rows="3"></textarea>
        </div>
      
      <div class="form-row">
        <div class="form-group form-group-half">
          <label class="form-label" for="scheduleStartDate">ì‹œì‘ì¼</label>
          <input type="date" class="form-input" id="scheduleStartDate" required>
        </div>
        <div class="form-group form-group-half">
          <label class="form-label" for="scheduleEndDate">ì¢…ë£Œì¼</label>
          <input type="date" class="form-input" id="scheduleEndDate" required>
        </div>
      </div>
      
        <div class="form-group">
        <label class="form-label">ê¸°ê°„ ì„¤ì • (í¸ì˜ ê¸°ëŠ¥)</label>
        <div class="duration-buttons">
          <button type="button" class="duration-btn" data-weeks="1">1ì£¼ì¼</button>
          <button type="button" class="duration-btn" data-weeks="2">2ì£¼ì¼</button>
          <button type="button" class="duration-btn" data-weeks="3">3ì£¼ì¼</button>
          <button type="button" class="duration-btn" data-weeks="4">4ì£¼ì¼</button>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="scheduleStatus">ìƒíƒœ</label>
        <select class="form-input" id="scheduleStatus" required>
          <option value="planning">ê³„íšì¤‘</option>
          <option value="in-progress">ì§„í–‰ì¤‘</option>
          <option value="review">ê²€í† ì¤‘</option>
          <option value="completed">ì™„ë£Œ</option>
          <option value="on-hold">ë³´ë¥˜</option>
        </select>
      </div>
      
      <div class="popup-buttons">
        <button type="button" class="popup-btn popup-btn-secondary" id="cancelScheduleBtn">ì·¨ì†Œ</button>
        <button type="submit" class="popup-btn popup-btn-primary" id="saveScheduleBtn">ì¶”ê°€</button>
      </div>
    </form>
  </div>
</div>

<!-- ì‚­ì œ í™•ì¸ íŒì—… -->
<div class="delete-confirm-popup-overlay" id="deleteConfirmPopup">
  <div class="delete-confirm-popup">
    <div class="delete-confirm-header">
      <span class="delete-confirm-icon">âš ï¸</span>
      ì¹´í…Œê³ ë¦¬ ì‚­ì œ í™•ì¸
    </div>
    <div class="delete-confirm-message">
      ì •ë§ë¡œ <span class="delete-confirm-category" id="deleteCategoryName"></span> ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?
      <br><br>
      <strong>ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë©°, ì¹´í…Œê³ ë¦¬ ë‚´ì˜ ëª¨ë“  í”„ë¡œì íŠ¸ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.</strong>
    </div>
    <div class="delete-confirm-buttons">
      <button type="button" class="popup-btn popup-btn-secondary" id="cancelDeleteBtn">ì·¨ì†Œ</button>
      <button type="button" class="popup-btn popup-btn-primary" id="confirmDeleteBtn" style="background: #dc3545;">ì‚­ì œ</button>
    </div>
  </div>
</div>

<!-- ìŠ¤ì¼€ì¤„ í¸ì§‘ íŒì—… -->
<div class="schedule-edit-popup-overlay" id="scheduleEditPopup">
  <div class="schedule-edit-popup">
    <div class="schedule-edit-header">
      <span class="schedule-edit-icon">âœï¸</span>
      ìŠ¤ì¼€ì¤„ í¸ì§‘
    </div>
    
    <div class="schedule-edit-info">
      <div class="schedule-edit-event-name" id="scheduleEditEventName"></div>
      <div class="schedule-edit-category-name" id="scheduleEditCategoryName"></div>
    </div>
    
    <form class="schedule-edit-form" id="scheduleEditForm">
      <div class="form-group">
        <label class="form-label" for="scheduleEditName">ìŠ¤ì¼€ì¤„ ì´ë¦„</label>
        <textarea class="form-input" id="scheduleEditName" placeholder="ìŠ¤ì¼€ì¤„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="100" required rows="3"></textarea>
      </div>
      
      <div class="form-row">
        <div class="form-group form-group-half">
          <label class="form-label" for="scheduleEditStartDate">ì‹œì‘ì¼</label>
          <input type="date" class="form-input" id="scheduleEditStartDate" required>
        </div>
        <div class="form-group form-group-half">
          <label class="form-label" for="scheduleEditEndDate">ì¢…ë£Œì¼</label>
          <input type="date" class="form-input" id="scheduleEditEndDate" required>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="scheduleEditStatus">ìƒíƒœ</label>
        <select class="form-input" id="scheduleEditStatus" required>
          <option value="planning">ê³„íšì¤‘</option>
          <option value="in-progress">ì§„í–‰ì¤‘</option>
          <option value="review">ê²€í† ì¤‘</option>
          <option value="completed">ì™„ë£Œ</option>
          <option value="on-hold">ë³´ë¥˜</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">ìƒ‰ìƒ ì„¤ì •</label>
        <div class="schedule-color-display">
          <span id="scheduleColorPreview" class="color-preview" style="background-color: #6c757d;"></span>
          <button type="button" class="color-select-btn" id="scheduleColorSelectBtn">ìƒ‰ìƒ ì„ íƒ</button>
          <button type="button" class="reset-color-btn" id="resetScheduleColorBtn" title="ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒìœ¼ë¡œ ì´ˆê¸°í™”">ğŸ”„ ì´ˆê¸°í™”</button>
        </div>
      </div>
      
      <div class="schedule-edit-buttons">
        <button type="button" class="schedule-edit-btn schedule-cancel-btn" id="scheduleEditCancelBtn">ì·¨ì†Œ</button>
        <button type="button" class="schedule-edit-btn schedule-delete-btn" id="scheduleEditDeleteBtn">ì‚­ì œ</button>
        <button type="submit" class="schedule-edit-btn schedule-save-btn" id="scheduleEditSaveBtn">ì €ì¥</button>
      </div>
    </form>
  </div>
</div>

<!-- ìƒ‰ìƒ ì„ íƒ íŒì—… -->
<div class="color-picker-popup-overlay" id="colorPickerPopup">
  <div class="color-picker-popup">
    <div class="color-picker-header">
      <span class="color-picker-icon">ğŸ¨</span>
      <span id="colorPickerTitle">ìƒ‰ìƒ ì„ íƒ</span>
      <div class="color-picker-category-info">
        <span class="color-picker-category-name" id="colorPickerTargetName"></span>
      </div>
    </div>
    
    <div class="color-picker-content">
      <div class="color-preset-section">
        <h4>ê¸°ë³¸ ìƒ‰ìƒ</h4>
        <div class="color-preset-grid">
          <div class="color-preset-item" data-color="#6c757d" style="background-color: #6c757d;" title="íšŒìƒ‰ (ê¸°ë³¸)"></div>
          <div class="color-preset-item" data-color="#28a745" style="background-color: #28a745;" title="ì´ˆë¡ìƒ‰"></div>
          <div class="color-preset-item" data-color="#007bff" style="background-color: #007bff;" title="íŒŒë€ìƒ‰"></div>
          <div class="color-preset-item" data-color="#dc3545" style="background-color: #dc3545;" title="ë¹¨ê°„ìƒ‰"></div>
          <div class="color-preset-item" data-color="#ffc107" style="background-color: #ffc107;" title="ë…¸ë€ìƒ‰"></div>
          <div class="color-preset-item" data-color="#6f42c1" style="background-color: #6f42c1;" title="ë³´ë¼ìƒ‰"></div>
          <div class="color-preset-item" data-color="#20c997" style="background-color: #20c997;" title="ì²­ë¡ìƒ‰"></div>
          <div class="color-preset-item" data-color="#fd7e14" style="background-color: #fd7e14;" title="ì£¼í™©ìƒ‰"></div>
          <div class="color-preset-item" data-color="#e83e8c" style="background-color: #e83e8c;" title="ë¶„í™ìƒ‰"></div>
          <div class="color-preset-item" data-color="#17a2b8" style="background-color: #17a2b8;" title="ì‹œì•ˆìƒ‰"></div>
          <div class="color-preset-item" data-color="#6610f2" style="background-color: #6610f2;" title="ì¸ë””ê³ "></div>
          <div class="color-preset-item" data-color="#343a40" style="background-color: #343a40;" title="ì§„íšŒìƒ‰"></div>
        </div>
      </div>
      
      <div class="color-custom-section">
        <h4>ì‚¬ìš©ì ì§€ì • ìƒ‰ìƒ</h4>
        <div class="color-custom-input">
          <input type="color" id="customColorPicker" value="#6c757d">
          <label for="customColorPicker">ìƒ‰ìƒ ì„ íƒ</label>
        </div>
      </div>
      
      <div class="color-preview-section">
        <h4>ë¯¸ë¦¬ë³´ê¸°</h4>
        <div class="color-preview-bar" id="colorPreviewBar">
          <span>ìƒ˜í”Œ ìŠ¤ì¼€ì¤„</span>
        </div>
      </div>
    </div>
    
    <div class="color-picker-buttons">
      <button type="button" class="popup-btn popup-btn-secondary" id="cancelColorBtn">ì·¨ì†Œ</button>
      <button type="button" class="popup-btn popup-btn-primary" id="applyColorBtn">ì ìš©</button>
    </div>
  </div>
</div>

<!-- JSON ê´€ë¦¬ ë²„íŠ¼ë“¤ -->
<div class="json-controls">
  <button type="button" class="json-btn json-export-btn" id="exportJsonBtn">
    <span class="json-btn-icon">ğŸ“¤</span>
    Export
  </button>
  <button type="button" class="json-btn json-import-btn" id="importJsonBtn">
    <span class="json-btn-icon">ğŸ“¥</span>
    Import
  </button>
  <button type="button" class="json-btn json-load-btn" id="loadJsonBtn">
    <span class="json-btn-icon">ğŸ”„</span>
    Load
  </button>
  <button type="button" class="json-btn json-save-btn" id="saveJsonBtn">
    <span class="json-btn-icon">ğŸ’¾</span>
    Save
  </button>
  <button type="button" class="json-btn json-xlsx-btn" id="exportXlsxBtn">
    <span class="json-btn-icon">ğŸ“Š</span>
    XLSX
  </button>
  <button type="button" class="json-btn json-png-btn" id="exportPngBtn">
    <span class="json-btn-icon">ğŸ–¼ï¸</span>
    PNG
  </button>
  <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
</div>

<!-- jQuery UI ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ -->
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<!-- ExcelJS ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ (ìƒ‰ìƒ ì§€ì›) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>

<!-- html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
// ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ì´ˆê¸° ë¡œë“œë§µ ë°ì´í„°
<% 
  initial_data = @all_projects.map { |project| 
    {
      name: project[:category],
      customColor: project[:customColor]
    }
  }
%>
window.initialRoadmapData = {
  categories: <%= raw initial_data.to_json %>
};

$(document).ready(function() {
  
  // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì •ë³´ ì´ˆê¸°í™” (ìƒ‰ìƒ ë³€ê²½ ê¸°ëŠ¥ì„ ìœ„í•´)
  var categoryColors = {};
  <% @all_projects.each do |category_group| %>
    <% if category_group[:customColor] %>
      categoryColors['<%= category_group[:category] %>'] = '<%= category_group[:customColor] %>';
    <% end %>
  <% end %>
  
  // bodyì— í´ë˜ìŠ¤ ì¶”ê°€ë¡œ ì „ì²´ í˜ì´ì§€ ìŠ¤í¬ë¡¤ ì œì–´
  $('body').addClass('roadmap-view');
  
  // ì˜¤ëŠ˜ ë‚ ì§œ ìœ„ì¹˜ë¡œ ìŠ¤í¬ë¡¤
  var todayPosition = <%= today_position %>;
  var timelineContainer = $('.roadmap-timeline');
  var containerWidth = timelineContainer.width();
  
  // ì˜¤ëŠ˜ì´ í™”ë©´ ì¤‘ì•™ì— ì˜¤ë„ë¡ ìŠ¤í¬ë¡¤
  var scrollLeft = Math.max(0, todayPosition - containerWidth * 0.2 );
  timelineContainer.scrollLeft(scrollLeft);

  // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ì¹´í…Œê³ ë¦¬ ì •ë³´ ì €ì¥
  var currentEditingCategory = null;
  
  // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ìŠ¤ì¼€ì¤„ ì •ë³´ ì €ì¥
  var currentEditingSchedule = null;
  
  // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ìŠ¤ì¼€ì¤„ ë°” ì •ë³´ ì €ì¥ (ìš°í´ë¦­ í¸ì§‘ìš©)
  var currentEditingScheduleBar = null;
  
  // í˜„ì¬ ìƒ‰ìƒ ë³€ê²½ ì¤‘ì¸ ëŒ€ìƒ ì •ë³´ ì €ì¥
  var currentColorEditingTarget = null;
  
  // ìŠ¤ì¼€ì¤„ë³„ ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì €ì¥ ê°ì²´
  var scheduleColors = {};
  

  
  // í˜„ì¬ ì„ íƒëœ ìƒ‰ìƒ
  var selectedColor = '#6c757d';
  
  // ë“œë˜ê·¸ ê°ì§€ë¥¼ ìœ„í•œ ë³€ìˆ˜
  var dragThreshold = 5; // 5px ì´ìƒ ì›€ì§ì´ë©´ ë“œë˜ê·¸ë¡œ ê°„ì£¼

  // íƒ€ì„ë¼ì¸ì˜ ëª¨ë“  ë¼ì¸ ë†’ì´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateLineHeight() {
    var timelineBody = $('.timeline-body');
    
    if (timelineBody.length > 0) {
      var timelineHeight = timelineBody[0].scrollHeight; // ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì „ì²´ ë†’ì´
      
      // today-line ë†’ì´ ì—…ë°ì´íŠ¸
      var todayLine = $('.today-line');
      if (todayLine.length > 0) {
        var todayNewHeight = timelineHeight + 50; // top: -50px ë³´ì •
        todayLine.css('height', todayNewHeight + 'px');
      }
      
      // date-grid-line ë†’ì´ ì—…ë°ì´íŠ¸
      var dateGridLines = $('.date-grid-line');
      if (dateGridLines.length > 0) {
        dateGridLines.css('height', timelineHeight + 'px');
      }
    }
  }

  // ìŠ¤í¬ë¡¤ ë™ê¸°í™” ê¸°ëŠ¥ (ê°œì„ ëœ ë²„ì „)
  var isScrollSyncing = false; // ë¬´í•œ ë£¨í”„ ë°©ì§€ í”Œë˜ê·¸
  var syncAnimationFrame = null; // ì• ë‹ˆë©”ì´ì…˜ í”„ë ˆì„ ID
  var lastSyncTime = 0; // ë§ˆì§€ë§‰ ë™ê¸°í™” ì‹œê°„
  
  // ìŠ¤í¬ë¡¤ ë™ê¸°í™” í•¨ìˆ˜
  function syncScroll(sourceElement, targetElement, scrollTop) {
    if (syncAnimationFrame) {
      cancelAnimationFrame(syncAnimationFrame);
    }
    
    syncAnimationFrame = requestAnimationFrame(function() {
      if (!isScrollSyncing) {
        isScrollSyncing = true;
        lastSyncTime = Date.now();
        
        // íƒ€ê²Ÿ ìš”ì†Œì˜ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì„¤ì •
        targetElement.scrollTop(scrollTop);
        
        // ë” ì§§ì€ ë”œë ˆì´ë¡œ í”Œë˜ê·¸ í•´ì œ
        setTimeout(function() {
          isScrollSyncing = false;
        }, 5);
      }
      syncAnimationFrame = null;
    });
  }
  
  // ì‚¬ì´ë“œë°”ì™€ íƒ€ì„ë¼ì¸ ìŠ¤í¬ë¡¤ ë™ê¸°í™”
  $('.sidebar-content').on('scroll', function() {
    var currentTime = Date.now();
    // ë„ˆë¬´ ë¹ ë¥¸ ì—°ì† ì´ë²¤íŠ¸ëŠ” ë§ˆì§€ë§‰ ê²ƒë§Œ ì²˜ë¦¬
    if (currentTime - lastSyncTime > 2) {
      var scrollTop = $(this).scrollTop();
      syncScroll($(this), $('.timeline-body'), scrollTop);
    }
  });
  
  $('.timeline-body').on('scroll', function() {
    var currentTime = Date.now();
    // ë„ˆë¬´ ë¹ ë¥¸ ì—°ì† ì´ë²¤íŠ¸ëŠ” ë§ˆì§€ë§‰ ê²ƒë§Œ ì²˜ë¦¬
    if (currentTime - lastSyncTime > 2) {
      var scrollTop = $(this).scrollTop();
      syncScroll($(this), $('.sidebar-content'), scrollTop);
    }
  });

  // ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $('.add-category-btn').click(function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    var categoryName = prompt('ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
    if (categoryName && categoryName.trim() !== '') {
      addNewCategory(categoryName.trim());
    }
  });

  // ì´ë²¤íŠ¸ ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (íŒì—… ì‚¬ìš©)
  $(document).on('click', '.add-event-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    var categoryHeader = $(this).closest('.category-header');
    var categoryIndex = categoryHeader.data('category-index');
    var categoryName = categoryHeader.find('.category-title').text().trim();
    
    // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ì¹´í…Œê³ ë¦¬ ì •ë³´ ì €ì¥
    currentEditingCategory = {
      index: categoryIndex,
      name: categoryName
    };
    
    // íŒì—…ì— ì¹´í…Œê³ ë¦¬ ì´ë¦„ í‘œì‹œ
    $('#eventCategoryName').text(categoryName);
    
    // ê¸°ë³¸ê°’ ì„¤ì •
    $('#eventName').val('');
    
    // íŒì—… í‘œì‹œ (ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•´ í´ë˜ìŠ¤ ì‚¬ìš©)
    $('#eventPopup').addClass('show');
    
    // í¬ì»¤ìŠ¤ ì„¤ì • (ì•½ê°„ì˜ ë”œë ˆì´ í›„)
    setTimeout(function() {
      $('#eventName').focus();
    }, 100);
  });

  // ì´ë²¤íŠ¸ íŒì—… ì·¨ì†Œ ë²„íŠ¼
  $('#cancelEventBtn').click(function(e) {
    e.preventDefault();
    hideEventPopup();
  });

  // ì´ë²¤íŠ¸ íŒì—… ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
  $('#eventPopup').click(function(e) {
    if (e.target === this) {
      hideEventPopup();
    }
  });

  // ì´ë²¤íŠ¸ íŒì—… ìˆ¨ê¸°ê¸° í•¨ìˆ˜
  function hideEventPopup() {
    $('#eventPopup').removeClass('show');
    currentEditingCategory = null;
  }

  // ë§ˆìš°ìŠ¤ ë‹¤ìš´ ì´ë²¤íŠ¸ - ì‹œì‘ ìœ„ì¹˜ ì €ì¥ (íƒ€ì„ë¼ì¸ í–‰ì—ì„œ ì²˜ë¦¬)
  $(document).on('mousedown', '.timeline-row', function(e) {
    // í”„ë¡œì íŠ¸ ë°” í´ë¦­ì€ ë¬´ì‹œ
    if ($(e.target).hasClass('project-bar') || $(e.target).closest('.project-bar').length > 0) {
      return;
    }
    
    var downTime = Date.now();
    $(this).data('mousedown-x', e.clientX);
    $(this).data('mousedown-y', e.clientY);
    $(this).data('mousedown-time', downTime);
  });

  // ë§ˆìš°ìŠ¤ ì—… ì´ë²¤íŠ¸ - ì¢…ë£Œ ìœ„ì¹˜ ì €ì¥ (íƒ€ì„ë¼ì¸ í–‰ì—ì„œ ì²˜ë¦¬)
  $(document).on('mouseup', '.timeline-row', function(e) {
    // í”„ë¡œì íŠ¸ ë°” í´ë¦­ì€ ë¬´ì‹œ
    if ($(e.target).hasClass('project-bar') || $(e.target).closest('.project-bar').length > 0) {
      return;
    }
    
    $(this).data('mouseup-x', e.clientX);
    $(this).data('mouseup-y', e.clientY);
  });

  // íƒ€ì„ë¼ì¸ í–‰ ì „ì²´ì—ì„œ ë¹ˆ ì˜ì—­ í´ë¦­ ê°ì§€
  $(document).on('click', '.timeline-row', function(e) {
    // í´ë¦­ëœ ìš”ì†Œê°€ í”„ë¡œì íŠ¸ ë°”ì´ê±°ë‚˜ í”„ë¡œì íŠ¸ ë°”ì˜ ìì‹ ìš”ì†Œì¸ ê²½ìš° ë¬´ì‹œ
    if ($(e.target).hasClass('project-bar') || $(e.target).closest('.project-bar').length > 0) {
      return;
    }
    
    // í´ë¦­ ìœ„ì¹˜ì—ì„œ í•´ë‹¹í•˜ëŠ” ì…€ ì°¾ê¸°
    var clickedCell = null;
    var clickX = e.offsetX || e.originalEvent.layerX;
    
    // í´ë¦­ëœ ìš”ì†Œê°€ timeline-cellì¸ì§€ í™•ì¸
    if ($(e.target).hasClass('timeline-cell')) {
      clickedCell = $(e.target);
    } else if ($(e.target).closest('.timeline-cell').length > 0) {
      clickedCell = $(e.target).closest('.timeline-cell');
    } else {
      // í´ë¦­ ìœ„ì¹˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì…€ ì°¾ê¸°
      var timelineRow = $(this);
      var cells = timelineRow.find('.timeline-cell');
      var cellWidth = <%= cell_width %>;
      var cellIndex = Math.floor(clickX / cellWidth);
      
      if (cellIndex >= 0 && cellIndex < cells.length) {
        clickedCell = cells.eq(cellIndex);
      }
    }
    
    if (!clickedCell || !clickedCell.hasClass('schedule-add-target')) {
      return;
    }
    
    // ì‹œê°„ ë° ê±°ë¦¬ ì œí•œ í™•ì¸ (íƒ€ì„ë¼ì¸ í–‰ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°)
    var downX = $(this).data('mousedown-x');
    var downY = $(this).data('mousedown-y');
    var upX = $(this).data('mouseup-x');
    var upY = $(this).data('mouseup-y');
    var downTime = $(this).data('mousedown-time');
    
    // ì‹œê°„ ì œí•œ í™•ì¸ (0.2ì´ˆ = 200ms)
    var currentTime = Date.now();
    var timeDiff = downTime ? (currentTime - downTime) : 0;
    
    if (timeDiff > 200) {
      return;
    }
    
    // ê±°ë¦¬ ì œí•œ í™•ì¸
    if (downX !== undefined && downY !== undefined && upX !== undefined && upY !== undefined) {
      var deltaX = Math.abs(upX - downX);
      var deltaY = Math.abs(upY - downY);
      
      if (deltaX > dragThreshold || deltaY > dragThreshold) {
        return;
      }
    }
    
    e.preventDefault();
    e.stopPropagation();
    
    var timelineRow = $(this);
    var clickedDate = clickedCell.data('date');
    var eventName = timelineRow.data('event-name');
    var categoryName = timelineRow.data('category-name');
    
    // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ìŠ¤ì¼€ì¤„ ì •ë³´ ì €ì¥
    currentEditingSchedule = {
      eventName: eventName,
      categoryName: categoryName,
      clickedDate: clickedDate,
      timelineRow: timelineRow
    };
    
    // íŒì—…ì— ì •ë³´ ì„¤ì •
    $('#scheduleEventName').text(eventName);
    $('#scheduleCategoryName').text('(' + categoryName + ')');
    
    // í¼ ì´ˆê¸°í™”
    $('#scheduleName').val('');
    $('#scheduleStartDate').val(clickedDate);
    
    // ì¢…ë£Œì¼ì„ ì‹œì‘ì¼ë¡œë¶€í„° 1ì£¼ì¼ ë’¤ë¡œ ì„¤ì •
    var startDateObj = new Date(clickedDate);
    var endDateObj = new Date(startDateObj);
    endDateObj.setDate(endDateObj.getDate() + 6); // 1ì£¼ì¼ ë’¤
    var endDateString = endDateObj.toISOString().split('T')[0];
    $('#scheduleEndDate').val(endDateString);
    
    $('#scheduleStatus').val('planning');
    
    // íŒì—… í‘œì‹œ
    $('#schedulePopup').addClass('show');
    
    // í¬ì»¤ìŠ¤ ì„¤ì •
    setTimeout(function() {
      $('#scheduleName').focus();
    }, 100);
  });

  // ìŠ¤ì¼€ì¤„ íŒì—… ì·¨ì†Œ ë²„íŠ¼
  $('#cancelScheduleBtn').click(function(e) {
    e.preventDefault();
    hideSchedulePopup();
  });

  // ìŠ¤ì¼€ì¤„ íŒì—… ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
  $('#schedulePopup').click(function(e) {
    if (e.target === this) {
      hideSchedulePopup();
    }
  });

  // ìŠ¤ì¼€ì¤„ íŒì—… ìˆ¨ê¸°ê¸° í•¨ìˆ˜
  function hideSchedulePopup() {
    $('#schedulePopup').removeClass('show');
    currentEditingSchedule = null;
  }

  // ê¸°ê°„ ì„¤ì • ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $(document).on('click', '.duration-btn', function(e) {
    e.preventDefault();
    
    var weeks = parseInt($(this).data('weeks'));
    var startDate = $('#scheduleStartDate').val();
    
    if (startDate) {
      var startDateObj = new Date(startDate);
      var endDateObj = new Date(startDateObj);
      endDateObj.setDate(endDateObj.getDate() + (weeks * 7) - 1);
      
      var endDateString = endDateObj.toISOString().split('T')[0];
      $('#scheduleEndDate').val(endDateString);
      
      // ë²„íŠ¼ ì‹œê°ì  í”¼ë“œë°±
      $(this).css('transform', 'scale(0.95)');
      setTimeout(() => {
        $(this).css('transform', '');
      }, 150);
    } else {
      alert('ë¨¼ì € ì‹œì‘ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    }
  });

  // ì‹œì‘ì¼ ë³€ê²½ì‹œ ìë™ìœ¼ë¡œ ì¢…ë£Œì¼ì„ 1ì£¼ì¼ ë’¤ë¡œ ì„¤ì • (ì¢…ë£Œì¼ ë¯¸í¬í•¨ ë°©ì‹)
  $('#scheduleStartDate').change(function() {
    var startDate = $(this).val();
    if (startDate) {
      var startDateObj = new Date(startDate);
      var endDateObj = new Date(startDateObj);
      endDateObj.setDate(endDateObj.getDate() + 7); // 1ì£¼ì¼ ë’¤ (ì¢…ë£Œì¼ ë¯¸í¬í•¨ ë°©ì‹)
      
      var endDateString = endDateObj.toISOString().split('T')[0];
      $('#scheduleEndDate').val(endDateString);
      

    }
  });

  // ìŠ¤ì¼€ì¤„ í¼ ì œì¶œ ì²˜ë¦¬
  $('#scheduleForm').submit(function(e) {
    e.preventDefault();
    
    if (!currentEditingSchedule) {
      console.error('í¸ì§‘ ì¤‘ì¸ ìŠ¤ì¼€ì¤„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    var scheduleName = $('#scheduleName').val().trim();
    var startDate = $('#scheduleStartDate').val();
    var endDate = $('#scheduleEndDate').val();
    var status = $('#scheduleStatus').val();
    
    if (!scheduleName || !startDate || !endDate) {
      alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    // ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬
    if (new Date(startDate) > new Date(endDate)) {
      alert('ì‹œì‘ì¼ì€ ì¢…ë£Œì¼ë³´ë‹¤ ëŠ¦ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    

    
    // ìƒˆ ìŠ¤ì¼€ì¤„ ë°” ì¶”ê°€
    addNewSchedule(currentEditingSchedule, {
      name: scheduleName,
      start_date: parseLocalDate(startDate),
      end_date: parseLocalDate(endDate),
      status: status
    });
    
    // íŒì—… ë‹«ê¸°
    hideSchedulePopup();
  });

  // ì´ë²¤íŠ¸ í¼ ì œì¶œ ì²˜ë¦¬
  $('#eventForm').submit(function(e) {
    e.preventDefault();
    
    var eventName = $('#eventName').val().trim();
    
    if (!eventName) {
      alert('ì´ë²¤íŠ¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      $('#eventName').focus();
      return;
    }
    
    if (!currentEditingCategory) {
      alert('ì¹´í…Œê³ ë¦¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    // ìƒˆ ì´ë²¤íŠ¸ ë°ì´í„° ìƒì„± (ìŠ¤ì¼€ì¤„ ì •ë³´ ì—†ì´)
    var eventData = {
      name: eventName
    };
    
    // ì´ë²¤íŠ¸ ì¶”ê°€
    addNewEvent(currentEditingCategory.index, eventData);
    
    // íŒì—… ë‹«ê¸°
    hideEventPopup();
    

  });



  // ìƒ‰ìƒ íŒì—… ê´€ë ¨ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤
  
  // ê¸°ë³¸ ìƒ‰ìƒ ì„ íƒ í´ë¦­ ì´ë²¤íŠ¸
  $(document).on('click', '.color-preset-item', function(e) {
    e.preventDefault();
    var color = $(this).data('color');
    selectedColor = color;
    updateColorSelection(color);
    $('#customColorPicker').val(color);
  });
  
  // ì‚¬ìš©ì ì§€ì • ìƒ‰ìƒ ë³€ê²½ ì´ë²¤íŠ¸
  $('#customColorPicker').on('input', function(e) {
    var color = $(this).val();
    selectedColor = color;
    updateColorSelection(color);
  });
  
  // ìƒ‰ìƒ ì ìš© ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $('#applyColorBtn').click(function(e) {
    e.preventDefault();
    
    if (!currentColorEditingTarget) {
      console.error('ìƒ‰ìƒ ë³€ê²½ ì¤‘ì¸ ëŒ€ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    if (currentColorEditingTarget.type === 'category') {
      // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì €ì¥
      categoryColors[currentColorEditingTarget.categoryName] = selectedColor;
      
      // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ëª¨ë“  ì´ë²¤íŠ¸ë“¤ì˜ ìŠ¤ì¼€ì¤„ ë°” ìƒ‰ìƒ ì—…ë°ì´íŠ¸
      updateCategoryScheduleColors(currentColorEditingTarget.categoryName, selectedColor);
    } else if (currentColorEditingTarget.type === 'schedule') {
      // ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ ì €ì¥
      var scheduleKey = currentColorEditingTarget.scheduleKey;
      var categoryColor = getCategoryColor(currentColorEditingTarget.categoryName);
      
      // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒê³¼ ê°™ìœ¼ë©´ ê°œë³„ ìƒ‰ìƒ ì œê±°
      if (selectedColor === categoryColor) {
        delete scheduleColors[scheduleKey];
      } else {
        scheduleColors[scheduleKey] = selectedColor;
      }
      
      // ìƒ‰ìƒ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
      $('#scheduleColorPreview').css('background-color', selectedColor);
      
      // ìŠ¤ì¼€ì¤„ í¸ì§‘ ìƒ‰ìƒ ê°’ ì €ì¥
      if (currentColorEditingTarget.colorValue) {
        currentColorEditingTarget.colorValue = selectedColor;
      }
    }
    
    // íŒì—… ë‹«ê¸°
    hideColorPickerPopup();
  });
  
  // ìƒ‰ìƒ ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $('#cancelColorBtn').click(function(e) {
    e.preventDefault();
    hideColorPickerPopup();
  });
  
  // ìƒ‰ìƒ íŒì—… ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
  $('#colorPickerPopup').click(function(e) {
    if (e.target === this) {
      hideColorPickerPopup();
    }
  });

  // ESC í‚¤ë¡œ íŒì—… ë‹«ê¸°
  $(document).keydown(function(e) {
    if (e.key === 'Escape') {
      if ($('#scheduleEditPopup').hasClass('show')) {
        hideScheduleEditPopup();
      } else if ($('#schedulePopup').hasClass('show')) {
        hideSchedulePopup();
      } else if ($('#eventPopup').hasClass('show')) {
        hideEventPopup();
      } else if ($('#colorPickerPopup').hasClass('show')) {
        hideColorPickerPopup();
      }
    }
  });

  // ì¹´í…Œê³ ë¦¬ í¸ì§‘ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ì¸ë¼ì¸ í¸ì§‘ ëª¨ë“œë¡œ ë³€ê²½)
  $(document).on('click', '.edit-category-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();

    
    var categoryHeader = $(this).closest('.category-header');
    enterEditMode(categoryHeader);
  });

  // ì¹´í…Œê³ ë¦¬ í¸ì§‘ ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $(document).on('click', '.save-category-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();

    
    var categoryHeader = $(this).closest('.category-header');
    saveCategory(categoryHeader);
  });

  // ì¹´í…Œê³ ë¦¬ í¸ì§‘ ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $(document).on('click', '.cancel-category-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();

    
    var categoryHeader = $(this).closest('.category-header');
    cancelEditMode(categoryHeader);
  });

  // ì´ë²¤íŠ¸ í¸ì§‘ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $(document).on('click', '.edit-event-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();

    
    var eventItem = $(this).closest('.project-item');
    enterEventEditMode(eventItem);
  });

  // ì´ë²¤íŠ¸ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $(document).on('click', '.delete-event-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();

    
    var eventItem = $(this).closest('.project-item');
    var eventName = eventItem.find('.project-name').text().trim();
    
    if (confirm('ì •ë§ë¡œ "' + eventName + '" ì´ë²¤íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë©°, ì´ë²¤íŠ¸ ë‚´ì˜ ëª¨ë“  ìŠ¤ì¼€ì¤„ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) {
      deleteEvent(eventItem);
    }
  });

  // ì´ë²¤íŠ¸ í¸ì§‘ ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $(document).on('click', '.save-event-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();

    
    var eventItem = $(this).closest('.project-item');
    saveEvent(eventItem);
  });

  // ì´ë²¤íŠ¸ í¸ì§‘ ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $(document).on('click', '.cancel-event-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();

    
    var eventItem = $(this).closest('.project-item');
    cancelEventEditMode(eventItem);
  });

  // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ë³€ê²½ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $(document).on('click', '.color-category-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();
    console.log('ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ë³€ê²½ ë²„íŠ¼ í´ë¦­ë¨');
    
    var categoryHeader = $(this).closest('.category-header');
    var categoryIndex = categoryHeader.data('category-index');
    var categoryName = categoryHeader.find('.category-title').text().trim();
    
    // í˜„ì¬ ìƒ‰ìƒ ë³€ê²½ ì¤‘ì¸ ëŒ€ìƒ ì •ë³´ ì €ì¥
    currentColorEditingTarget = {
      type: 'category',
      categoryName: categoryName,
      categoryIndex: categoryIndex,
      categoryHeader: categoryHeader
    };
    
    // íŒì—… íƒ€ì´í‹€ê³¼ ëŒ€ìƒ ì´ë¦„ ì„¤ì •
    $('#colorPickerTitle').text('ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì„ íƒ');
    $('#colorPickerTargetName').text(categoryName);
    
    // í˜„ì¬ ì¹´í…Œê³ ë¦¬ì˜ ìƒ‰ìƒ ë¶ˆëŸ¬ì˜¤ê¸°
    var currentColor = categoryColors[categoryName] || '#6c757d';
    selectedColor = currentColor;
    
    // ìƒ‰ìƒ ì„ íƒ UI ì—…ë°ì´íŠ¸
    updateColorSelection(currentColor);
    
    // íŒì—… í‘œì‹œ
    $('#colorPickerPopup').addClass('show');
  });

  // ì¹´í…Œê³ ë¦¬ í¸ì§‘ ì…ë ¥ í•„ë“œì—ì„œ Enter/Escape í‚¤ ì²˜ë¦¬
  $(document).on('keydown', '.category-edit-input', function(e) {
    var categoryHeader = $(this).closest('.category-header');
    
    if (e.key === 'Enter') {
      e.preventDefault();
      saveCategory(categoryHeader);
    } else if (e.key === 'Escape') {
      e.preventDefault();
      cancelEditMode(categoryHeader);
    }
  });

  // ì´ë²¤íŠ¸ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ ì´ˆê¸°í™”
  initializeEventDragAndDrop();
  
  // ì¹´í…Œê³ ë¦¬ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ ì´ˆê¸°í™”
  initializeCategoryDragAndDrop();

  // ì´ë²¤íŠ¸ í¸ì§‘ ì…ë ¥ í•„ë“œì—ì„œ Enter/Escape í‚¤ ì²˜ë¦¬
  $(document).on('keydown', '.event-edit-input', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      var eventItem = $(this).closest('.project-item');
      saveEvent(eventItem);
    } else if (e.key === 'Escape') {
      e.preventDefault();
      var eventItem = $(this).closest('.project-item');
      cancelEventEditMode(eventItem);
    }
  });

  // ì¹´í…Œê³ ë¦¬ í¸ì§‘ ëª¨ë“œ ì§„ì…
  function enterEditMode(categoryHeader) {
    console.log('í¸ì§‘ ëª¨ë“œ ì§„ì…');
    
    var categoryTitle = categoryHeader.find('.category-title');
    var editForm = categoryHeader.find('.category-edit-form');
    var editInput = categoryHeader.find('.category-edit-input');
    
    // í˜„ì¬ ì œëª©ì„ ì…ë ¥ í•„ë“œì— ì„¤ì •
    editInput.val(categoryTitle.text().trim());
    
    // í¸ì§‘ ëª¨ë“œ í´ë˜ìŠ¤ ì¶”ê°€
    categoryHeader.addClass('editing');
    
    // ì œëª© ìˆ¨ê¸°ê³  í¸ì§‘ í¼ í‘œì‹œ
    categoryTitle.hide();
    editForm.show();
    
    // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
    editInput.focus().select();
  }

  // ì¹´í…Œê³ ë¦¬ í¸ì§‘ ì €ì¥
  function saveCategory(categoryHeader) {
    console.log('ì¹´í…Œê³ ë¦¬ ì €ì¥');
    
    var categoryTitle = categoryHeader.find('.category-title');
    var editForm = categoryHeader.find('.category-edit-form');
    var editInput = categoryHeader.find('.category-edit-input');
    
    var newName = editInput.val().trim();
    
    if (newName === '') {
      alert('ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
      editInput.focus();
      return;
    }
    
    // ì œëª© ì—…ë°ì´íŠ¸
    categoryTitle.text(newName);
    
    // í¸ì§‘ ëª¨ë“œ ì¢…ë£Œ
    exitEditMode(categoryHeader);
    
    console.log('ì¹´í…Œê³ ë¦¬ ì´ë¦„ ì €ì¥ë¨:', newName);
  }

  // ì¹´í…Œê³ ë¦¬ í¸ì§‘ ì·¨ì†Œ
  function cancelEditMode(categoryHeader) {
    console.log('ì¹´í…Œê³ ë¦¬ í¸ì§‘ ì·¨ì†Œ');
    exitEditMode(categoryHeader);
  }

  // í¸ì§‘ ëª¨ë“œ ì¢…ë£Œ
  function exitEditMode(categoryHeader) {
    var categoryTitle = categoryHeader.find('.category-title');
    var editForm = categoryHeader.find('.category-edit-form');
    
    // í¸ì§‘ ëª¨ë“œ í´ë˜ìŠ¤ ì œê±°
    categoryHeader.removeClass('editing');
    
    // í¸ì§‘ í¼ ìˆ¨ê¸°ê³  ì œëª© í‘œì‹œ
    editForm.hide();
    categoryTitle.show();
  }

  // ì¹´í…Œê³ ë¦¬ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  var deletingCategoryIndex = null;
  
  $(document).on('click', '.delete-category-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();
    console.log('ì¹´í…Œê³ ë¦¬ ì‚­ì œ ë²„íŠ¼ í´ë¦­ë¨');
    
    var categoryHeader = $(this).closest('.category-header');
    var categoryName = categoryHeader.find('.category-title').text().trim();
    deletingCategoryIndex = categoryHeader.data('category-index');
    
    if (confirm('"' + categoryName + '" ì¹´í…Œê³ ë¦¬ì™€ ëª¨ë“  í•˜ìœ„ ì´ë²¤íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      confirmCategoryDelete();
    } else {
      deletingCategoryIndex = null;
    }
  });

  // í† ê¸€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ë™ì  ìš”ì†Œ í¬í•¨)
  $(document).on('click', '.category-toggle-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    console.log('í† ê¸€ ë²„íŠ¼ í´ë¦­ë¨!');
    
    var categoryHeader = $(this).closest('.category-header');
    var categoryIndex = categoryHeader.data('category-index');
    var categoryName = categoryHeader.find('.category-title').text().trim();
    
    console.log('í´ë¦­ëœ ì¹´í…Œê³ ë¦¬:', categoryIndex, categoryName);
    
    var isCollapsed = categoryHeader.hasClass('category-collapsed');
    console.log('í˜„ì¬ ìƒíƒœ:', isCollapsed ? 'ì ‘í˜' : 'í¼ì¹¨');
    
    if (isCollapsed) {
      // í¼ì¹˜ê¸°
      console.log('í¼ì¹˜ê¸° ì‹œì‘');
      categoryHeader.removeClass('category-collapsed');
      $(this).removeClass('collapsed').text('â–¼');
      
      // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ í”„ë¡œì íŠ¸ë“¤ë§Œ í‘œì‹œ (JavaScriptë¡œ ì§ì ‘ ì œì–´)
      $('.project-item[data-category-index="' + categoryIndex + '"]').removeClass('hidden').show();
      console.log('í”„ë¡œì íŠ¸ ì•„ì´í…œë“¤ í‘œì‹œ ì™„ë£Œ');
      
      // íƒ€ì„ë¼ì¸ì—ì„œ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ í–‰ë“¤ í‘œì‹œ
      showTimelineRows(categoryIndex);
      
      // ë¼ì¸ ë†’ì´ ì—…ë°ì´íŠ¸ (í–‰ì´ ë‚˜íƒ€ë‚¨)
      setTimeout(function() {
        updateLineHeight();
      }, 50);
      
    } else {
      // ì ‘ê¸°
      console.log('ì ‘ê¸° ì‹œì‘');
      categoryHeader.addClass('category-collapsed');
      $(this).addClass('collapsed').text('â–¶');
      
      // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ í”„ë¡œì íŠ¸ë“¤ë§Œ ìˆ¨ê¸°ê¸° (JavaScriptë¡œ ì§ì ‘ ì œì–´)
      $('.project-item[data-category-index="' + categoryIndex + '"]').addClass('hidden');
      console.log('í”„ë¡œì íŠ¸ ì•„ì´í…œë“¤ ìˆ¨ê¸°ê¸° ì™„ë£Œ');
      
      // íƒ€ì„ë¼ì¸ì—ì„œ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ í–‰ë“¤ ìˆ¨ê¸°ê¸°
      hideTimelineRows(categoryIndex);
      
      // ë¼ì¸ ë†’ì´ ì—…ë°ì´íŠ¸ (í–‰ì´ ìˆ¨ê²¨ì§)
      setTimeout(function() {
        updateLineHeight();
      }, 50);
    }
  });

  // ì¹´í…Œê³ ë¦¬ ì‚­ì œ í™•ì¸ í•¨ìˆ˜ (ìˆ˜ì •ëœ ë²„ì „)
  function confirmCategoryDelete() {
    if (deletingCategoryIndex === null) return;
    
    var categoryHeader = $('.category-header[data-category-index="' + deletingCategoryIndex + '"]');
    var categoryName = categoryHeader.find('.category-title').text().trim();
    
    console.log('ì¹´í…Œê³ ë¦¬ ì‚­ì œ ì‹œì‘:', categoryName, 'ì¸ë±ìŠ¤:', deletingCategoryIndex);
    
    // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì •ë³´ ì‚­ì œ
    delete categoryColors[categoryName];
    
    // 1. íƒ€ì„ë¼ì¸ì—ì„œ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ í–‰ë“¤ ë¨¼ì € ì‚­ì œ (ì‚¬ì´ë“œë°” ë³€ê²½ ì „ì—)
    deleteTimelineRowsForCategory(deletingCategoryIndex);
    
    // 2. í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ëª¨ë“  í”„ë¡œì íŠ¸ ì•„ì´í…œ ì‚­ì œ (ì‚¬ì´ë“œë°”)
    var deletedProjectCount = $('.project-item[data-category-index="' + deletingCategoryIndex + '"]').length;
    $('.project-item[data-category-index="' + deletingCategoryIndex + '"]').remove();
    console.log('ì‚­ì œëœ í”„ë¡œì íŠ¸ ì•„ì´í…œ ìˆ˜:', deletedProjectCount);
    
    // 3. ì¹´í…Œê³ ë¦¬ í—¤ë” ì‚­ì œ (ì‚¬ì´ë“œë°”)
    categoryHeader.remove();
    
    console.log('ì¹´í…Œê³ ë¦¬ ì‚­ì œ ì™„ë£Œ:', categoryName);
    deletingCategoryIndex = null;
  }

  // íƒ€ì„ë¼ì¸ì—ì„œ ì¹´í…Œê³ ë¦¬ í–‰ë“¤ ì‚­ì œ (ê°œì„ ëœ ë²„ì „)
  function deleteTimelineRowsForCategory(categoryIndex) {
    console.log('íƒ€ì„ë¼ì¸ ì¹´í…Œê³ ë¦¬ í–‰ ì‚­ì œ ì‹œì‘:', categoryIndex);
    
    // ì¹´í…Œê³ ë¦¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    var categoryName = $('.category-header[data-category-index="' + categoryIndex + '"] .category-title').text().trim();
    console.log('ì‚­ì œí•  ì¹´í…Œê³ ë¦¬ ì´ë¦„:', categoryName);
    
    if (!categoryName) {
      console.log('ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ - ì‚­ì œ ì¤‘ë‹¨');
      return;
    }
    
    // 1. í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ëª¨ë“  ì´ë²¤íŠ¸ í–‰ ì‚­ì œ
    var eventRows = $('.timeline-row[data-category-name="' + categoryName + '"]');
    console.log('ì‚­ì œí•  ì´ë²¤íŠ¸ í–‰ ìˆ˜:', eventRows.length);
    eventRows.remove();
    
    // 2. í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì¹´í…Œê³ ë¦¬ í–‰ ì‚­ì œ
    // ì¹´í…Œê³ ë¦¬ í–‰ì€ category-row í´ë˜ìŠ¤ë¥¼ ê°€ì§€ë©°, ìˆœì„œëŒ€ë¡œ ë°°ì¹˜ë˜ì–´ ìˆìŒ
    var categoryRowIndex = 0;
    $('.category-header').each(function(index) {
      if ($(this).data('category-index') == categoryIndex) {
        categoryRowIndex = index;
        return false; // break
      }
    });
    
    var categoryRow = $('.timeline-row.category-row').eq(categoryRowIndex);
    if (categoryRow.length > 0) {
      console.log('ì¹´í…Œê³ ë¦¬ í–‰ ì‚­ì œ:', categoryRowIndex);
      categoryRow.remove();
    } else {
      console.log('ì¹´í…Œê³ ë¦¬ í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:', categoryRowIndex);
    }
    
    // ë¼ì¸ ë†’ì´ ì—…ë°ì´íŠ¸
    setTimeout(function() {
      updateLineHeight();
    }, 50);
    
    console.log('íƒ€ì„ë¼ì¸ ì¹´í…Œê³ ë¦¬ í–‰ ì‚­ì œ ì™„ë£Œ');
  }

  // ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€ í•¨ìˆ˜
  function addNewCategory(categoryName) {
    console.log('ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€:', categoryName);
    
    // ìƒˆ ì¹´í…Œê³ ë¦¬ ì¸ë±ìŠ¤ ê³„ì‚°
    var maxIndex = -1;
    $('.category-header').each(function() {
      var index = $(this).data('category-index');
      if (index > maxIndex) maxIndex = index;
    });
    var newCategoryIndex = maxIndex + 1;
    
    // ì‚¬ì´ë“œë°”ì— ìƒˆ ì¹´í…Œê³ ë¦¬ í—¤ë” ì¶”ê°€
    var newCategoryHtml = '<div class="category-header" data-category-index="' + newCategoryIndex + '">' +
      '<div class="category-left">' +
        '<button class="category-toggle-btn" type="button">â–¼</button>' +
        '<span class="category-title">' + categoryName + '</span>' +
      '</div>' +
      '<div class="category-actions">' +
        '<button class="category-btn add-event-btn" type="button" title="ì´ë²¤íŠ¸ ì¶”ê°€">+</button>' +
        '<button class="category-btn edit-category-btn" type="button" title="ì´ë¦„ ë³€ê²½">âœ</button>' +
        '<button class="category-btn color-category-btn" type="button" title="ìƒ‰ìƒ ë³€ê²½">ğŸ¨</button>' +
        '<button class="category-btn delete-category-btn" type="button" title="ì¹´í…Œê³ ë¦¬ ì‚­ì œ">Ã—</button>' +
      '</div>' +
    '</div>';
    
    $('.roadmap-sidebar').append(newCategoryHtml);
    
    // íƒ€ì„ë¼ì¸ì— ìƒˆ ì¹´í…Œê³ ë¦¬ í–‰ ì¶”ê°€
    var cellsHtml = '';
    <% days.each do |day| %>
      cellsHtml += '<div class="timeline-cell" style="width: <%= cell_width %>px;"></div>';
    <% end %>
    
    var newTimelineRowHtml = '<div class="timeline-row category-row">' +
      '<div class="timeline-grid">' + cellsHtml + '</div>' +
      '</div>';
    
    $('.timeline-body').append(newTimelineRowHtml);
    
    // ë¼ì¸ ë†’ì´ ì—…ë°ì´íŠ¸
    setTimeout(function() {
      updateLineHeight();
    }, 50);
    
    console.log('ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ì™„ë£Œ:', categoryName);
  }

  // íƒ€ì„ë¼ì¸ í–‰ë“¤ ìˆ¨ê¸°ê¸° í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „)
  function hideTimelineRows(categoryIndex) {
    console.log('íƒ€ì„ë¼ì¸ í–‰ ìˆ¨ê¸°ê¸° ì‹œì‘:', categoryIndex);
    
    // ì¹´í…Œê³ ë¦¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    var categoryName = $('.category-header[data-category-index="' + categoryIndex + '"] .category-title').text().trim();
    console.log('ì¹´í…Œê³ ë¦¬ ì´ë¦„:', categoryName);
    
    // ì¹´í…Œê³ ë¦¬ í–‰ì€ ìˆ¨ê¸°ì§€ ì•Šê³ , í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì´ë²¤íŠ¸ í–‰ë“¤ë§Œ ìˆ¨ê¸°ê¸°
    // (ì‚¬ì´ë“œë°”ì™€ ë™ì¼í•œ ë™ì‘: ì¹´í…Œê³ ë¦¬ í—¤ë”ëŠ” ë‚¨ì•„ìˆê³  ì´ë²¤íŠ¸ë“¤ë§Œ ìˆ¨ê¹€)
    $('.timeline-row[data-category-name="' + categoryName + '"]').addClass('hidden');
    console.log('ì¹´í…Œê³ ë¦¬', categoryName, 'ì˜ ëª¨ë“  ì´ë²¤íŠ¸ í–‰ ìˆ¨ê¹€ ì²˜ë¦¬ (ì¹´í…Œê³ ë¦¬ í–‰ì€ ìœ ì§€)');
    
    console.log('íƒ€ì„ë¼ì¸ í–‰ ìˆ¨ê¸°ê¸° ì™„ë£Œ');
  }

  // íƒ€ì„ë¼ì¸ í–‰ë“¤ í‘œì‹œ í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „)
  function showTimelineRows(categoryIndex) {
    console.log('íƒ€ì„ë¼ì¸ í–‰ í‘œì‹œ ì‹œì‘:', categoryIndex);
    
    // ì¹´í…Œê³ ë¦¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    var categoryName = $('.category-header[data-category-index="' + categoryIndex + '"] .category-title').text().trim();
    console.log('ì¹´í…Œê³ ë¦¬ ì´ë¦„:', categoryName);
    
    // ì¹´í…Œê³ ë¦¬ í–‰ì€ í•­ìƒ í‘œì‹œë˜ì–´ ìˆìœ¼ë¯€ë¡œ, í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì´ë²¤íŠ¸ í–‰ë“¤ë§Œ í‘œì‹œ
    // (ì‚¬ì´ë“œë°”ì™€ ë™ì¼í•œ ë™ì‘: ì¹´í…Œê³ ë¦¬ í—¤ë”ëŠ” ê³„ì† ë³´ì´ê³  ì´ë²¤íŠ¸ë“¤ë§Œ ë‚˜íƒ€ë‚¨)
    $('.timeline-row[data-category-name="' + categoryName + '"]').removeClass('hidden');
    console.log('ì¹´í…Œê³ ë¦¬', categoryName, 'ì˜ ëª¨ë“  ì´ë²¤íŠ¸ í–‰ í‘œì‹œ ì²˜ë¦¬ (ì¹´í…Œê³ ë¦¬ í–‰ì€ í•­ìƒ í‘œì‹œë¨)');
    
    console.log('íƒ€ì„ë¼ì¸ í–‰ í‘œì‹œ ì™„ë£Œ');
  }

  // ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€ í•¨ìˆ˜ (ê°œë³„ í–‰ ì¶”ê°€ ë°©ì‹)
  function addNewEvent(categoryIndex, eventData) {
    console.log('=== ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€ ì‹œì‘ ===');
    console.log('ì¹´í…Œê³ ë¦¬ ì¸ë±ìŠ¤:', categoryIndex);
    console.log('ì´ë²¤íŠ¸ ë°ì´í„°:', eventData);
    
    // 1. ì‚¬ì´ë“œë°”ì— í”„ë¡œì íŠ¸ ì•„ì´í…œ ì¶”ê°€
    var categoryProjects = $('.project-item[data-category-index="' + categoryIndex + '"]');
    var categoryHeader = $('.category-header[data-category-index="' + categoryIndex + '"]');
    
    var newProjectHtml = '<div class="project-item" data-category-index="' + categoryIndex + '">' +
      '<div class="event-content">' +
        '<div class="project-name">' + eventData.name.replace(/\n/g, '<br>') + '</div>' +
        '<div class="project-info">0ê°œ ìŠ¤ì¼€ì¤„</div>' +
      '</div>' +
      '<form class="event-edit-form">' +
        '<textarea class="event-edit-input">' + eventData.name + '</textarea>' +
      '</form>' +
      '<div class="event-actions">' +
        '<button class="event-btn edit-event-btn" title="í¸ì§‘">âœï¸</button>' +
        '<button class="event-btn delete-event-btn" title="ì‚­ì œ">ğŸ—‘ï¸</button>' +
      '</div>' +
      '<div class="event-edit-actions">' +
        '<button class="event-btn save-event-btn" title="ì €ì¥">âœ“</button>' +
        '<button class="event-btn cancel-event-btn" title="ì·¨ì†Œ">âœ•</button>' +
      '</div>' +
    '</div>';
    
    var newProjectElement;
    if (categoryProjects.length > 0) {
      categoryProjects.last().after(newProjectHtml);
      newProjectElement = categoryProjects.last().next();
      console.log('ê¸°ì¡´ í”„ë¡œì íŠ¸ ë’¤ì— ì¶”ê°€');
    } else {
      categoryHeader.after(newProjectHtml);
      newProjectElement = categoryHeader.next();
      console.log('ì¹´í…Œê³ ë¦¬ í—¤ë” ë’¤ì— ì¶”ê°€');
    }
    
    // 2. íƒ€ì„ë¼ì¸ì— í•´ë‹¹ í–‰ë§Œ ì¶”ê°€ (ê¸°ì¡´ í–‰ë“¤ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
    var cellsHtml = '';
    <% days.each_with_index do |day, index| %>
      cellsHtml += '<div class="timeline-cell schedule-add-target" style="width: <%= cell_width %>px;" data-date="<%= day[:date].strftime('%Y-%m-%d') %>"></div>';
    <% end %>
    
    var categoryName = $('.category-header[data-category-index="' + categoryIndex + '"] .category-title').text().trim();
    
    var newTimelineRowHtml = '<div class="timeline-row" data-event-name="' + eventData.name + '" data-category-name="' + categoryName + '">' +
      '<div class="timeline-grid">' + cellsHtml + '</div>' +
      '</div>';
    
    // íƒ€ì„ë¼ì¸ì—ì„œ ì˜¬ë°”ë¥¸ ìœ„ì¹˜ ì°¾ê¸°
    var timelineInsertPosition = findTimelineInsertPosition(categoryIndex, newProjectElement);
    var newTimelineRow;
    if (timelineInsertPosition.method === 'after') {
      timelineInsertPosition.element.after(newTimelineRowHtml);
      newTimelineRow = timelineInsertPosition.element.next();
    } else {
      timelineInsertPosition.element.before(newTimelineRowHtml);
      newTimelineRow = timelineInsertPosition.element.prev();
    }
    
    // ìƒˆë¡œ ì¶”ê°€ëœ í–‰ì˜ í”„ë¡œì íŠ¸ ë°”ë“¤ì— ëŒ€í•´ ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì ìš©
    initializeProjectBarDraggableForRow(newTimelineRow);
    
    // ì¹´í…Œê³ ë¦¬ê°€ ì ‘íŒ ìƒíƒœì¸ì§€ í™•ì¸í•˜ê³  í•„ìš”ì‹œ ìˆ¨ê¸°ê¸°
    var categoryHeader = $('.category-header[data-category-index="' + categoryIndex + '"]');
    if (categoryHeader.hasClass('category-collapsed')) {
      console.log('ì ‘íŒ ì¹´í…Œê³ ë¦¬ì— ì´ë²¤íŠ¸ ì¶”ê°€ë¨ - ìë™ìœ¼ë¡œ ìˆ¨ê¸°ê¸°');
      newProjectElement.addClass('hidden');
      newTimelineRow.addClass('hidden');
    }
    
    // ë¼ì¸ ë†’ì´ ì—…ë°ì´íŠ¸
    setTimeout(function() {
      updateLineHeight();
    }, 50);
    
    console.log('=== ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€ ì™„ë£Œ ===');
  }
  
  // íƒ€ì„ë¼ì¸ ì‚½ì… ìœ„ì¹˜ ì°¾ê¸° í•¨ìˆ˜
  function findTimelineInsertPosition(categoryIndex, newSidebarElement) {
    var timelineRows = $('.timeline-row');
    var sidebarElements = $('.roadmap-sidebar').children().not('.sidebar-header');
    var sidebarIndex = sidebarElements.index(newSidebarElement);
    var timelineIndex = 0;
    
    // ì‚¬ì´ë“œë°” ìˆœì„œì— ë§ëŠ” íƒ€ì„ë¼ì¸ ìœ„ì¹˜ ê³„ì‚°
    for (var i = 0; i < sidebarIndex; i++) {
      var element = sidebarElements.eq(i);
      if (element.hasClass('category-header') || element.hasClass('project-item')) {
        timelineIndex++;
      }
    }
    
    if (timelineIndex === 0) {
      // ì²« ë²ˆì§¸ ìœ„ì¹˜ì— ì‚½ì…
      return {
        method: 'before',
        element: timelineRows.first()
      };
    } else if (timelineIndex >= timelineRows.length) {
      // ë§ˆì§€ë§‰ ìœ„ì¹˜ì— ì‚½ì…
      return {
        method: 'after',
        element: timelineRows.last()
      };
    } else {
      // ì¤‘ê°„ ìœ„ì¹˜ì— ì‚½ì…
      return {
        method: 'before',
        element: timelineRows.eq(timelineIndex)
      };
    }
  }

  // íƒ€ì„ë¼ì¸ ì¬êµ¬ì„± í›„ í† ê¸€ ìƒíƒœ ë³µì›
  function rebuildTimelineFromSidebar() {
    console.log('=== íƒ€ì„ë¼ì¸ ì „ì²´ ì¬êµ¬ì„± ì‹œì‘ ===');
    
    // í˜„ì¬ ì ‘íŒ ì¹´í…Œê³ ë¦¬ë“¤ ê¸°ì–µ
    var collapsedCategories = [];
    $('.category-header.category-collapsed').each(function() {
      collapsedCategories.push($(this).data('category-index'));
    });
    console.log('ì ‘íŒ ì¹´í…Œê³ ë¦¬ë“¤:', collapsedCategories);
    
    // ê¸°ì¡´ íƒ€ì„ë¼ì¸ í–‰ë“¤ ì œê±° (ì˜¤ëŠ˜ í‘œì‹œì„  ì œì™¸)
    var todayLine = $('.today-line').detach();
    $('.timeline-row').remove();
    
    // íƒ€ì„ë¼ì¸ ì„¤ì •ê°’ë“¤
    var startDate = new Date(<%= start_date.to_time.to_i * 1000 %>);
    var cellWidth = <%= cell_width %>;
    var totalWidth = <%= total_width %>;
    
    // ì…€ í…œí”Œë¦¿ ìƒì„±
    var cellsHtml = '';
    <% days.each do |day| %>
      cellsHtml += '<div class="timeline-cell" style="width: <%= cell_width %>px;"></div>';
    <% end %>
    
    // ì‚¬ì´ë“œë°” êµ¬ì¡°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ íƒ€ì„ë¼ì¸ ì¬êµ¬ì„±
    $('.roadmap-sidebar').children().not('.sidebar-header').each(function() {
      if ($(this).hasClass('category-header')) {
        // ì¹´í…Œê³ ë¦¬ í–‰ ì¶”ê°€
        var categoryRowHtml = '<div class="timeline-row category-row">' +
          '<div class="timeline-grid">' + cellsHtml + '</div>' +
          '</div>';
        $('.timeline-body').append(categoryRowHtml);
        
        console.log('ì¹´í…Œê³ ë¦¬ í–‰ ì¶”ê°€:', $(this).find('.category-title').text());
        
      } else if ($(this).hasClass('project-item')) {
        // í”„ë¡œì íŠ¸ í–‰ ì¶”ê°€
        var projectName = $(this).find('.project-name').text().trim();
        
        // ë‹¤ì¤‘ ìŠ¤ì¼€ì¤„ êµ¬ì¡°ì—ì„œëŠ” ë¹ˆ í–‰ìœ¼ë¡œ ì‹œì‘ (ìŠ¤ì¼€ì¤„ ë°”ë“¤ì€ ë³„ë„ë¡œ ì¶”ê°€ë¨)
        var projectBarHtml = '';
        
        var projectRowHtml = '<div class="timeline-row">' +
          '<div class="timeline-grid">' + cellsHtml + '</div>' +
          projectBarHtml +
          '</div>';
        
        $('.timeline-body').append(projectRowHtml);
        console.log('í”„ë¡œì íŠ¸ í–‰ ì¶”ê°€:', projectName);
      }
    });
    
    // ì˜¤ëŠ˜ í‘œì‹œì„  ë³µì›
    if (todayLine.length > 0) {
      $('.timeline-body').append(todayLine);
    }
    
    // ì ‘íŒ ì¹´í…Œê³ ë¦¬ë“¤ ìƒíƒœ ë³µì›
    collapsedCategories.forEach(function(categoryIndex) {
      console.log('ì¹´í…Œê³ ë¦¬ í† ê¸€ ìƒíƒœ ë³µì›:', categoryIndex);
      
      // ì‚¬ì´ë“œë°” í† ê¸€ ìƒíƒœ ë³µì›
      var categoryHeader = $('.category-header[data-category-index="' + categoryIndex + '"]');
      if (categoryHeader.length > 0) {
        categoryHeader.addClass('category-collapsed');
        categoryHeader.find('.category-toggle-btn').addClass('collapsed').text('â–¶');
        $('.project-item[data-category-index="' + categoryIndex + '"]').addClass('hidden');
      }
      
      // íƒ€ì„ë¼ì¸ í† ê¸€ ìƒíƒœ ë³µì›
      hideTimelineRows(categoryIndex);
    });
    
    // ë¼ì¸ ë†’ì´ ì—…ë°ì´íŠ¸
    setTimeout(function() {
      updateLineHeight();
    }, 100);
    
    console.log('=== íƒ€ì„ë¼ì¸ ì „ì²´ ì¬êµ¬ì„± ì™„ë£Œ ===');
  }

  // íŠ¹ì • í–‰ì˜ í”„ë¡œì íŠ¸ ë°” ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì´ˆê¸°í™”
  function initializeProjectBarDraggableForRow($row) {
    if (!$row || $row.length === 0) return;
    
    var $projectBars = $row.find('.project-bar');
    console.log('ìƒˆ í–‰ì˜ í”„ë¡œì íŠ¸ ë°” ê°œìˆ˜:', $projectBars.length);
    
    // ê° í”„ë¡œì íŠ¸ ë°”ì— z-index ì¬ì„¤ì • (í˜¹ì‹œ ëˆ„ë½ëœ ê²½ìš°)
    $projectBars.each(function(index) {
      var $bar = $(this);
      if (!$bar.data('schedule-index')) {
        $bar.attr('data-schedule-index', index);
      }
      
      // z-indexê°€ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ì— ì—†ìœ¼ë©´ ì¶”ê°€
      var currentStyle = $bar.attr('style') || '';
      if (currentStyle.indexOf('z-index') === -1) {
        var zIndex = 101 + index;
        $bar.attr('style', currentStyle + '; z-index: ' + zIndex + ';');
      }
    });
    
    applyDraggableToElements($projectBars);
  }

  // í”„ë¡œì íŠ¸ ë°” ë“œë˜ê·¸ ë° ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì´ˆê¸°í™”
  function initializeProjectBarDraggable() {
    // ê¸°ì¡´ ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì œê±° (ì´ë¯¸ ì´ˆê¸°í™”ëœ ê²ƒë“¤ë§Œ)
    $('.project-bar').each(function() {
      if ($(this).hasClass('ui-draggable')) {
        $(this).draggable('destroy');
      }
      if ($(this).hasClass('ui-resizable')) {
        $(this).resizable('destroy');
      }
    });
    
    // ëª¨ë“  í”„ë¡œì íŠ¸ ë°”ì— ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì ìš©
    applyDraggableToElements($('.project-bar'));
  }

  // í”„ë¡œì íŠ¸ ë°” ìš”ì†Œë“¤ì— ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì ìš©
  function applyDraggableToElements($elements) {
    if (!$elements || $elements.length === 0) return;
    
    console.log('ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì ìš© ëŒ€ìƒ:', $elements.length, 'ê°œ ìš”ì†Œ');
    
    // ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì¶”ê°€ (ì–‘ìª½ ë ë“œë˜ê·¸ë¡œ í¬ê¸° ì¡°ì •)
    $elements.resizable({
      handles: 'e, w', // ë™ìª½(ìš°ì¸¡), ì„œìª½(ì¢Œì¸¡) í•¸ë“¤ë§Œ í™œì„±í™”
      grid: [<%= cell_width %>, 0], // ì¼ ë‹¨ìœ„ë¡œ ìŠ¤ëƒ…
      minWidth: <%= cell_width %>, // ìµœì†Œ 1ì¼ í¬ê¸°
      containment: '.timeline-body',
      start: function(event, ui) {
        $(this).addClass('ui-resizable-resizing');
        // ë¦¬ì‚¬ì´ì¦ˆ ì‹œì‘ ìœ„ì¹˜ì™€ í¬ê¸° ì €ì¥
        $(this).data('startLeft', ui.position.left);
        $(this).data('startWidth', ui.size.width);
      },
      resize: function(event, ui) {
        // ë¦¬ì‚¬ì´ì¦ˆ ì¤‘ ë‚ ì§œ ì—…ë°ì´íŠ¸
        updateProjectDatesFromResize($(this), ui.position.left, ui.size.width);
      },
      stop: function(event, ui) {
        $(this).removeClass('ui-resizable-resizing');
        
        // ìµœì¢… í¬ê¸°ì™€ ìœ„ì¹˜ì—ì„œì˜ ë‚ ì§œ ê³„ì‚° ë° ì—…ë°ì´íŠ¸
        var finalDates = calculateProjectDatesFromResize($(this), ui.position.left, ui.size.width);
        var projectId = $(this).data('project-id');
        
        console.log('í”„ë¡œì íŠ¸ ë¦¬ì‚¬ì´ì¦ˆ ì™„ë£Œ:', {
          id: projectId,
          startDate: finalDates.startDate,
          endDate: finalDates.endDate
        });
        
        // ì‚¬ì´ë“œë°”ì˜ í”„ë¡œì íŠ¸ ì •ë³´ë„ ì—…ë°ì´íŠ¸
        updateSidebarProjectInfo($(this), finalDates);
      }
    });
    
    // ë“œë˜ê·¸ ê¸°ëŠ¥ ì¶”ê°€ (ì¤‘ì•™ ë¶€ë¶„ ë“œë˜ê·¸ë¡œ ì´ë™)
    $elements.draggable({
      axis: 'x', // xì¶•ìœ¼ë¡œë§Œ ë“œë˜ê·¸ ê°€ëŠ¥
      grid: [<%= cell_width %>, 0], // ì¼ ë‹¨ìœ„ë¡œ ìŠ¤ëƒ…
      containment: '.timeline-body', // íƒ€ì„ë¼ì¸ ì˜ì—­ ë‚´ì—ì„œë§Œ ë“œë˜ê·¸ ê°€ëŠ¥
      cancel: '.ui-resizable-handle', // ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ì—ì„œëŠ” ë“œë˜ê·¸ ë¹„í™œì„±í™”
      start: function(event, ui) {
        $(this).addClass('ui-draggable-dragging');
        // ì‹œì‘ ìœ„ì¹˜ ì €ì¥
        $(this).data('startLeft', ui.position.left);
      },
      drag: function(event, ui) {
        // ë“œë˜ê·¸ ì¤‘ ìœ„ì¹˜ì— ë”°ë¥¸ ë‚ ì§œ ì—…ë°ì´íŠ¸
        updateProjectDates($(this), ui.position.left);
      },
      stop: function(event, ui) {
        $(this).removeClass('ui-draggable-dragging');
        
        // ìµœì¢… ìœ„ì¹˜ì—ì„œì˜ ë‚ ì§œ ê³„ì‚° ë° ì—…ë°ì´íŠ¸
        var finalDates = calculateProjectDates($(this), ui.position.left);
        var projectId = $(this).data('project-id');
        
        console.log('í”„ë¡œì íŠ¸ ì´ë™ ì™„ë£Œ:', {
          id: projectId,
          startDate: finalDates.startDate,
          endDate: finalDates.endDate
        });
        
        // ì‚¬ì´ë“œë°”ì˜ í”„ë¡œì íŠ¸ ì •ë³´ë„ ì—…ë°ì´íŠ¸
        updateSidebarProjectInfo($(this), finalDates);
      }
    });
  }

  // í”„ë¡œì íŠ¸ ë‚ ì§œ ê³„ì‚° í•¨ìˆ˜ (ë“œë˜ê·¸ìš©)
  function calculateProjectDates($projectBar, leftPosition) {
    var startDate = new Date(<%= start_date.to_time.to_i * 1000 %>);
    var cellWidth = <%= cell_width %>;
    var daysOffset = Math.floor(leftPosition / cellWidth); // ë°”ë‹¥í•¨ìˆ˜ë¡œ ì…€ ì‹œì‘ì  ê¸°ì¤€ ê³„ì‚°
    
    // ì‹œì‘ì¼ ê³„ì‚°
    var projectStartDate = new Date(startDate.getTime() + (daysOffset * 24 * 60 * 60 * 1000));
    
    // í”„ë¡œì íŠ¸ ê¸°ê°„ ê³„ì‚° (ë°”ì˜ ë„ˆë¹„ ê¸°ì¤€)
    var durationDays = Math.round($projectBar.width() / cellWidth); // ë„ˆë¹„ëŠ” ë°˜ì˜¬ë¦¼ ì‚¬ìš©
    var projectEndDate = new Date(projectStartDate.getTime() + (durationDays * 24 * 60 * 60 * 1000));  // ì¢…ë£Œì¼ ë¯¸í¬í•¨ ë°©ì‹
    
    return {
      startDate: projectStartDate,
      endDate: projectEndDate
    };
  }

  // í”„ë¡œì íŠ¸ ë‚ ì§œ ê³„ì‚° í•¨ìˆ˜ (ë¦¬ì‚¬ì´ì¦ˆìš©)
  function calculateProjectDatesFromResize($projectBar, leftPosition, width) {
    var startDate = new Date(<%= start_date.to_time.to_i * 1000 %>);
    var cellWidth = <%= cell_width %>;
    var daysOffset = Math.floor(leftPosition / cellWidth); // ë°”ë‹¥í•¨ìˆ˜ë¡œ ì…€ ì‹œì‘ì  ê¸°ì¤€ ê³„ì‚°
    
    // ì‹œì‘ì¼ ê³„ì‚°
    var projectStartDate = new Date(startDate.getTime() + (daysOffset * 24 * 60 * 60 * 1000));
    
    // í”„ë¡œì íŠ¸ ê¸°ê°„ ê³„ì‚° (ë¦¬ì‚¬ì´ì¦ˆëœ ë„ˆë¹„ ê¸°ì¤€)
    var durationDays = Math.round(width / cellWidth); // ë„ˆë¹„ëŠ” ë°˜ì˜¬ë¦¼ ì‚¬ìš©
    var projectEndDate = new Date(projectStartDate.getTime() + (durationDays * 24 * 60 * 60 * 1000));  // ì¢…ë£Œì¼ ë¯¸í¬í•¨ ë°©ì‹
    
    console.log('calculateProjectDatesFromResize', projectStartDate, projectEndDate);

    return {
      startDate: projectStartDate,
      endDate: projectEndDate
    };
  }

  // ë‚ ì§œë¥¼ í˜„ì§€ ì‹œê°„ëŒ€ ê¸°ì¤€ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
  function formatLocalDate(date) {
    var year = date.getFullYear();
    var month = ('0' + (date.getMonth() + 1)).slice(-2);
    var day = ('0' + date.getDate()).slice(-2);
    return year + '-' + month + '-' + day;
  }

  // YYYY-MM-DD ë¬¸ìì—´ì„ í˜„ì§€ ì‹œê°„ëŒ€ ê¸°ì¤€ Date ê°ì²´ë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
  function parseLocalDate(dateString) {
    var parts = dateString.split('-');
    if (parts.length !== 3) {
      return new Date(dateString); // fallback
    }
    // í˜„ì§€ ì‹œê°„ëŒ€ë¡œ íŒŒì‹± (UTCê°€ ì•„ë‹Œ)
    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
  }

  // ë“œë˜ê·¸ ì¤‘ ë‚ ì§œ í‘œì‹œ ì—…ë°ì´íŠ¸
  function updateProjectDates($projectBar, leftPosition) {
    var dates = calculateProjectDates($projectBar, leftPosition);
    
    // í˜„ì§€ ì‹œê°„ëŒ€ ê¸°ì¤€ìœ¼ë¡œ YYYY-MM-DD í˜•ì‹ ë³€í™˜
    var startDateStr = formatLocalDate(dates.startDate);
    var endDateStr = formatLocalDate(dates.endDate);
    
    $projectBar.attr('title', 
      $projectBar.text() + ' (' + startDateStr + ' ~ ' + endDateStr + ')'
    );
  }

  // ë¦¬ì‚¬ì´ì¦ˆ ì¤‘ ë‚ ì§œ í‘œì‹œ ì—…ë°ì´íŠ¸
  function updateProjectDatesFromResize($projectBar, leftPosition, width) {
    var dates = calculateProjectDatesFromResize($projectBar, leftPosition, width);
    
    // í˜„ì§€ ì‹œê°„ëŒ€ ê¸°ì¤€ìœ¼ë¡œ YYYY-MM-DD í˜•ì‹ ë³€í™˜
    var startDateStr = formatLocalDate(dates.startDate);
    var endDateStr = formatLocalDate(dates.endDate);
    
    $projectBar.attr('title', 
      $projectBar.text() + ' (' + startDateStr + ' ~ ' + endDateStr + ')'
    );
  }

  // ì‚¬ì´ë“œë°” í”„ë¡œì íŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸ (ìŠ¤ì¼€ì¤„ ê°œìˆ˜ë§Œ í‘œì‹œ)
  function updateSidebarProjectInfo($projectBar, dates) {
    var projectName = $projectBar.text().trim();
    
    // ì‚¬ì´ë“œë°”ì—ì„œ í•´ë‹¹ í”„ë¡œì íŠ¸ ì°¾ê¸°
    $('.project-item').each(function() {
      if ($(this).find('.project-name').text().trim() === projectName) {
        // í•´ë‹¹ ì´ë²¤íŠ¸ì˜ ìŠ¤ì¼€ì¤„ ê°œìˆ˜ ê³„ì‚°
        var categoryIndex = $(this).data('category-index');
        var categoryHeader = $('.category-header[data-category-index="' + categoryIndex + '"]');
        var categoryName = categoryHeader.find('.category-title').text().trim();
        var timelineRow = $('.timeline-row[data-event-name="' + projectName + '"][data-category-name="' + categoryName + '"]');
        var scheduleCount = timelineRow.find('.project-bar').length;
        
        $(this).find('.project-info').text(scheduleCount + 'ê°œ ìŠ¤ì¼€ì¤„');
        return false; // ì°¾ì•˜ìœ¼ë©´ ë°˜ë³µ ì¤‘ë‹¨
      }
    });
  }

  // íƒ€ì„ë¼ì¸ ì¬êµ¬ì„± í›„ ë“œë˜ê·¸ ê¸°ëŠ¥ ì¬ì´ˆê¸°í™”
  // ìƒˆë¡œìš´ ë‹¤ì¤‘ ìŠ¤ì¼€ì¤„ êµ¬ì¡°ì—ì„œëŠ” ì „ì²´ ì¬êµ¬ì„± ëŒ€ì‹  ê°œë³„ í–‰ ì¶”ê°€ ë°©ì‹ ì‚¬ìš©
  // var originalRebuildTimelineFromSidebar = rebuildTimelineFromSidebar;
  // rebuildTimelineFromSidebar = function() {
  //   originalRebuildTimelineFromSidebar.apply(this, arguments);
  //   initializeProjectBarDraggable();
  // };

  // ìƒˆ ìŠ¤ì¼€ì¤„ ì¶”ê°€ í•¨ìˆ˜
  function addNewSchedule(scheduleInfo, scheduleData) {
    console.log('=== ìƒˆ ìŠ¤ì¼€ì¤„ ì¶”ê°€ ì‹œì‘ ===');
    console.log('ìŠ¤ì¼€ì¤„ ì •ë³´:', scheduleInfo);
    console.log('ìŠ¤ì¼€ì¤„ ë°ì´í„°:', scheduleData);
    
    var timelineRow = scheduleInfo.timelineRow;
    
    // ë‚ ì§œ ê³„ì‚° - ì¢…ë£Œì¼ ë¯¸í¬í•¨ ë°©ì‹
    var startDate = new Date(<%= start_date.to_time.to_i * 1000 %>);
    var projectStartDays = Math.round((scheduleData.start_date - startDate) / (1000 * 60 * 60 * 24));
    var projectDurationDays = Math.round((scheduleData.end_date - scheduleData.start_date) / (1000 * 60 * 60 * 24));  // ì¢…ë£Œì¼ ë¯¸í¬í•¨
    var barLeft = projectStartDays * <%= cell_width %>;
    var barWidth = projectDurationDays * <%= cell_width %>;
    var totalWidth = <%= total_width %>;
    
    console.log('ë‚ ì§œ ê³„ì‚° ê²°ê³¼:', {
      projectStartDays: projectStartDays,
      projectDurationDays: projectDurationDays,
      barLeft: barLeft,
      barWidth: barWidth
    });
    
    // í‘œì‹œ ë²”ìœ„ ë‚´ì— ìˆëŠ”ì§€ í™•ì¸
    if (barLeft >= -barWidth && barLeft <= totalWidth) {
      // ê¸°ì¡´ ìŠ¤ì¼€ì¤„ ë°”ë“¤ì˜ z-index í™•ì¸
      var existingBars = timelineRow.find('.project-bar');
      var maxZIndex = 100;
      existingBars.each(function() {
        var currentZIndex = parseInt($(this).css('z-index')) || 100;
        if (currentZIndex > maxZIndex) {
          maxZIndex = currentZIndex;
        }
      });
      var newZIndex = maxZIndex + 1;
      
      // ìƒ‰ìƒ í™•ì¸ (ê°œë³„ ìƒ‰ìƒ > ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ)
      var scheduleKey = scheduleInfo.eventName + '_' + existingBars.length;
      var scheduleColor = scheduleColors[scheduleKey];
      var categoryColor = getCategoryColor(scheduleInfo.categoryName);
      var appliedColor = scheduleColor || categoryColor;
      
      var barClass = appliedColor ? 'project-bar custom-color' : 'project-bar status-' + scheduleData.status;
      var barStyle = 'position: absolute; top: 2px; left: ' + Math.max(0, barLeft) + 'px; width: ' + Math.min(barWidth, totalWidth - Math.max(0, barLeft)) + 'px; z-index: ' + newZIndex + ';';
      
      if (appliedColor) {
        barStyle += ' background-color: ' + appliedColor + ';';
      }
      
      // ìƒˆ ìŠ¤ì¼€ì¤„ ë°” ìƒì„±
      var newScheduleBarHtml = '<div class="' + barClass + '" ' +
        'style="' + barStyle + '" ' +
        'title="' + scheduleData.name + ' (' + formatLocalDate(scheduleData.start_date) + ' ~ ' + formatLocalDate(scheduleData.end_date) + ')" ' +
        'data-schedule-index="' + (existingBars.length) + '">' +
        '<span class="project-bar-text">' + (scheduleData.name.length > 20 ? scheduleData.name.substring(0, 20) + '...' : scheduleData.name).replace(/\n/g, '<br>') + '</span>' +
        '</div>';
      
      // íƒ€ì„ë¼ì¸ í–‰ì— ì¶”ê°€
      timelineRow.append(newScheduleBarHtml);
      
      // ìƒˆë¡œ ì¶”ê°€ëœ ë°”ì— ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì ìš©
      var newBar = timelineRow.find('.project-bar').last();
      applyDraggableToElements(newBar);
      
      console.log('ìƒˆ ìŠ¤ì¼€ì¤„ ë°” ì¶”ê°€ë¨');
      
      // ì‚¬ì´ë“œë°”ì˜ ìŠ¤ì¼€ì¤„ ê°œìˆ˜ ì—…ë°ì´íŠ¸
      updateEventScheduleCount(scheduleInfo.eventName, scheduleInfo.categoryName);
      
    } else {
      console.log('ìŠ¤ì¼€ì¤„ì´ í‘œì‹œ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¨');
    }
    
    console.log('=== ìƒˆ ìŠ¤ì¼€ì¤„ ì¶”ê°€ ì™„ë£Œ ===');
  }

  // ì´ë²¤íŠ¸ì˜ ìŠ¤ì¼€ì¤„ ê°œìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateEventScheduleCount(eventName, categoryName) {
    console.log('ìŠ¤ì¼€ì¤„ ê°œìˆ˜ ì—…ë°ì´íŠ¸:', eventName, categoryName);
    
    // í•´ë‹¹ ì´ë²¤íŠ¸ì˜ ì‚¬ì´ë“œë°” ì•„ì´í…œ ì°¾ê¸°
    $('.project-item').each(function() {
      var projectItem = $(this);
      var projectNameEl = projectItem.find('.project-name');
      var categoryIndex = projectItem.data('category-index');
      var categoryHeader = $('.category-header[data-category-index="' + categoryIndex + '"]');
      var currentCategoryName = categoryHeader.find('.category-title').text().trim();
      
      if (projectNameEl.text().trim() === eventName && currentCategoryName === categoryName) {
        // í•´ë‹¹ ì´ë²¤íŠ¸ì˜ íƒ€ì„ë¼ì¸ í–‰ ì°¾ê¸°
        var timelineRow = $('.timeline-row[data-event-name="' + eventName + '"][data-category-name="' + categoryName + '"]');
        var scheduleCount = timelineRow.find('.project-bar').length;
        
        // ìŠ¤ì¼€ì¤„ ì •ë³´ ì—…ë°ì´íŠ¸
        var projectInfo = projectItem.find('.project-info');
        projectInfo.text(scheduleCount + 'ê°œ ìŠ¤ì¼€ì¤„');
        
        console.log('ìŠ¤ì¼€ì¤„ ê°œìˆ˜ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', scheduleCount);
        return false; // ì°¾ì•˜ìœ¼ë¯€ë¡œ ë°˜ë³µ ì¢…ë£Œ
      }
    });
  }

  // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ë³µì› í•¨ìˆ˜ëŠ” ë” ì´ìƒ í•„ìš”í•˜ì§€ ì•ŠìŒ (ì„œë²„ì—ì„œ ì§ì ‘ ë Œë”ë§)

  // ì´ˆê¸° ë“œë˜ê·¸ ê¸°ëŠ¥ ì„¤ì •
    initializeProjectBarDraggable();
    
  // ì´ˆê¸° ë¼ì¸ ë†’ì´ ì„¤ì •
  setTimeout(function() {
    updateLineHeight();
  }, 100);

  // JSON ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $('#exportJsonBtn').click(function() {
    exportRoadmapData();
  });

  // JSON ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $('#importJsonBtn').click(function() {
    $('#jsonFileInput').click();
  });

  // JSON ì„œë²„ ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $('#loadJsonBtn').click(function() {
    loadRoadmapFromServer();
  });

  // JSON ì„œë²„ ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $('#saveJsonBtn').click(function() {
    saveRoadmapToServer();
  });

  // XLSX ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $('#exportXlsxBtn').click(function() {
    exportRoadmapToXlsx();
  });

  // PNG ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $('#exportPngBtn').click(function() {
    exportRoadmapToPng();
  });

  // íŒŒì¼ ì„ íƒ ì‹œ JSON ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤í–‰
  $('#jsonFileInput').change(function(e) {
    var file = e.target.files[0];
    if (file) {
      importRoadmapData(file);
    }
  });

  // JSON ë°ì´í„° ë‚´ë³´ë‚´ê¸° í•¨ìˆ˜
  function exportRoadmapData() {
    console.log('JSON ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì‹œì‘');
    
    var exportData = {
      metadata: {
        exportDate: new Date().toISOString(),
        version: "1.0",
        description: "Redmine ë¡œë“œë§µ ë°ì´í„°"
      },
      categories: []
    };
    
    // ì‚¬ì´ë“œë°”ì—ì„œ ì¹´í…Œê³ ë¦¬ì™€ ì´ë²¤íŠ¸ ë°ì´í„° ìˆ˜ì§‘
    $('.category-header').each(function() {
      var categoryHeader = $(this);
      var categoryIndex = categoryHeader.data('category-index');
      var categoryName = categoryHeader.find('.category-title').text().trim();
      
      var categoryData = {
        name: categoryName,
        index: categoryIndex,
        events: []
      };
      
      // ì¹´í…Œê³ ë¦¬ ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì •ë³´ ì¶”ê°€
      if (categoryColors[categoryName]) {
        categoryData.customColor = categoryColors[categoryName];
      }
      
      // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì´ë²¤íŠ¸ë“¤ ìˆ˜ì§‘
      $('.project-item[data-category-index="' + categoryIndex + '"]').each(function() {
        var projectItem = $(this);
        var eventName = projectItem.find('.project-name').text().trim();
        
        var eventData = {
          name: eventName,
          schedules: []
        };
        
        // í•´ë‹¹ ì´ë²¤íŠ¸ì˜ ìŠ¤ì¼€ì¤„ë“¤ ìˆ˜ì§‘ (íƒ€ì„ë¼ì¸ì—ì„œ)
        var timelineRow = $('.timeline-row[data-event-name="' + eventName + '"][data-category-name="' + categoryName + '"]');
        timelineRow.find('.project-bar').each(function() {
          var scheduleBar = $(this);
          var title = scheduleBar.attr('title') || '';
          var scheduleName = scheduleBar.text().trim();
          
          // titleì—ì„œ ë‚ ì§œ ì¶”ì¶œ ì‹œë„
          var dateMatch = title.match(/\((\d{4}-\d{2}-\d{2}) ~ (\d{4}-\d{2}-\d{2})\)/);
          var startDate = null;
          var endDate = null;
          
          if (dateMatch) {
            startDate = dateMatch[1];
            endDate = dateMatch[2];
          }
          
          // ìƒíƒœ í´ë˜ìŠ¤ì—ì„œ ìƒíƒœ ì¶”ì¶œ
          var statusClass = scheduleBar.attr('class');
          var status = 'planning'; // ê¸°ë³¸ê°’
          if (statusClass.includes('status-')) {
            var statusMatch = statusClass.match(/status-([a-z-]+)/);
            if (statusMatch) {
              status = statusMatch[1];
            }
          }
          
          var scheduleData = {
            name: scheduleName,
            startDate: startDate,
            endDate: endDate,
            status: status
          };
          
          // ê°œë³„ ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ ì •ë³´ ì¶”ê°€
          var scheduleKey = eventName + '_' + scheduleIndex;
          if (scheduleColors[scheduleKey]) {
            scheduleData.customColor = scheduleColors[scheduleKey];
          }
          
          eventData.schedules.push(scheduleData);
        });
        
        categoryData.events.push(eventData);
      });
      
      exportData.categories.push(categoryData);
    });
    
    // JSON íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
    var jsonString = JSON.stringify(exportData, null, 2);
    var blob = new Blob([jsonString], { type: 'application/json' });
    var url = URL.createObjectURL(blob);
    
    var downloadLink = document.createElement('a');
    downloadLink.href = url;
    downloadLink.download = 'roadmap_data_' + formatLocalDate(new Date()) + '.json';
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
    URL.revokeObjectURL(url);
    
    console.log('JSON ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ');
    alert('ë¡œë“œë§µ ë°ì´í„°ê°€ JSON íŒŒì¼ë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤.');
  }

  // JSON ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
  function importRoadmapData(file) {
    console.log('JSON ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘');
    
    var reader = new FileReader();
    reader.onload = function(e) {
      try {
        var importData = JSON.parse(e.target.result);
        
        // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
        if (!importData.categories || !Array.isArray(importData.categories)) {
          throw new Error('ì˜¬ë°”ë¥´ì§€ ì•Šì€ JSON í˜•ì‹ì…ë‹ˆë‹¤.');
        }
        
        // í™•ì¸ ëŒ€í™”ìƒì
        if (!confirm('í˜„ì¬ ë¡œë“œë§µ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ê³  ìƒˆ ë°ì´í„°ë¡œ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
          return;
        }
        
        // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ
        clearAllRoadmapData();
        
        // ìƒˆ ë°ì´í„° ì ìš©
        applyImportedData(importData);
        
        console.log('JSON ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ');
        alert('ë¡œë“œë§µ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤.');
        
      } catch (error) {
        console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', error);
        alert('JSON íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    };
    
    reader.readAsText(file);
  }

  // ëª¨ë“  ë¡œë“œë§µ ë°ì´í„° ì‚­ì œ í•¨ìˆ˜
  function clearAllRoadmapData() {
    console.log('ê¸°ì¡´ ë¡œë“œë§µ ë°ì´í„° ì‚­ì œ ì‹œì‘');
    
    // íƒ€ì„ë¼ì¸ í–‰ë“¤ ì‚­ì œ (ì˜¤ëŠ˜ í‘œì‹œì„  ì œì™¸)
    $('.timeline-row').remove();
    
    // ì‚¬ì´ë“œë°” ì¹´í…Œê³ ë¦¬ì™€ í”„ë¡œì íŠ¸ ì‚­ì œ
    $('.category-header, .project-item').remove();
    
    console.log('ê¸°ì¡´ ë¡œë“œë§µ ë°ì´í„° ì‚­ì œ ì™„ë£Œ');
  }

  // ë¶ˆëŸ¬ì˜¨ ë°ì´í„° ì ìš© í•¨ìˆ˜
  function applyImportedData(importData) {
    console.log('ë¶ˆëŸ¬ì˜¨ ë°ì´í„° ì ìš© ì‹œì‘');
    
    importData.categories.forEach(function(categoryData, categoryIndex) {
      // ì¹´í…Œê³ ë¦¬ ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì •ë³´ ë³µì›
      if (categoryData.customColor) {
        categoryColors[categoryData.name] = categoryData.customColor;
      }
      
      // ì¹´í…Œê³ ë¦¬ ì¶”ê°€
      var newCategoryHtml = '<div class="category-header" data-category-index="' + categoryIndex + '">' +
        '<div class="category-left">' +
          '<button class="category-toggle-btn" type="button">â–¼</button>' +
          '<span class="category-title">' + categoryData.name + '</span>' +
        '</div>' +
        '<div class="category-actions">' +
          '<button class="category-btn add-event-btn" type="button" title="ì´ë²¤íŠ¸ ì¶”ê°€">+</button>' +
          '<button class="category-btn edit-category-btn" type="button" title="ì´ë¦„ ë³€ê²½">âœ</button>' +
          '<button class="category-btn color-category-btn" type="button" title="ìƒ‰ìƒ ë³€ê²½">ğŸ¨</button>' +
          '<button class="category-btn delete-category-btn" type="button" title="ì¹´í…Œê³ ë¦¬ ì‚­ì œ">Ã—</button>' +
        '</div>' +
      '</div>';
      
      $('.roadmap-sidebar').append(newCategoryHtml);
      
      // íƒ€ì„ë¼ì¸ì— ì¹´í…Œê³ ë¦¬ í–‰ ì¶”ê°€
      var cellsHtml = '';
      <% days.each do |day| %>
        cellsHtml += '<div class="timeline-cell" style="width: <%= cell_width %>px;"></div>';
      <% end %>
      
      var categoryRowHtml = '<div class="timeline-row category-row">' +
        '<div class="timeline-grid">' + cellsHtml + '</div>' +
        '</div>';
      
      $('.timeline-body').append(categoryRowHtml);
      
              // ì´ë²¤íŠ¸ë“¤ ì¶”ê°€
        categoryData.events.forEach(function(eventData) {
          // ì‚¬ì´ë“œë°”ì— ì´ë²¤íŠ¸ ì¶”ê°€
          var eventHtml = '<div class="project-item" data-category-index="' + categoryIndex + '">' +
            '<div class="event-content">' +
              '<div class="project-name">' + eventData.name.replace(/\n/g, '<br>') + '</div>' +
              '<div class="project-info">' + eventData.schedules.length + 'ê°œ ìŠ¤ì¼€ì¤„</div>' +
            '</div>' +
            '<form class="event-edit-form">' +
              '<textarea class="event-edit-input">' + eventData.name + '</textarea>' +
            '</form>' +
            '<div class="event-actions">' +
              '<button class="event-btn edit-event-btn" title="í¸ì§‘">âœï¸</button>' +
              '<button class="event-btn delete-event-btn" title="ì‚­ì œ">ğŸ—‘ï¸</button>' +
            '</div>' +
            '<div class="event-edit-actions">' +
              '<button class="event-btn save-event-btn" title="ì €ì¥">âœ“</button>' +
              '<button class="event-btn cancel-event-btn" title="ì·¨ì†Œ">âœ•</button>' +
            '</div>' +
          '</div>';
          
          $('.roadmap-sidebar').append(eventHtml);
        
        // íƒ€ì„ë¼ì¸ì— ì´ë²¤íŠ¸ í–‰ ì¶”ê°€
        var eventRowHtml = '<div class="timeline-row" data-event-name="' + eventData.name + '" data-category-name="' + categoryData.name + '">' +
          '<div class="timeline-grid">' + cellsHtml + '</div>' +
          '</div>';
        
        $('.timeline-body').append(eventRowHtml);
        
        var timelineRow = $('.timeline-row').last();
        
        // ìŠ¤ì¼€ì¤„ë“¤ ì¶”ê°€
        eventData.schedules.forEach(function(scheduleData, scheduleIndex) {
          if (scheduleData.startDate && scheduleData.endDate) {
            var startDate = new Date(<%= start_date.to_time.to_i * 1000 %>);
            var scheduleStartDate = parseLocalDate(scheduleData.startDate);
            var scheduleEndDate = parseLocalDate(scheduleData.endDate);
            
            var projectStartDays = Math.round((scheduleStartDate - startDate) / (1000 * 60 * 60 * 24));
            var projectDurationDays = Math.round((scheduleEndDate - scheduleStartDate) / (1000 * 60 * 60 * 24));
            var barLeft = projectStartDays * <%= cell_width %>;
            var barWidth = projectDurationDays * <%= cell_width %>;
            var totalWidth = <%= total_width %>;
            
            // í‘œì‹œ ë²”ìœ„ ë‚´ì— ìˆëŠ” ê²½ìš°ë§Œ ë°” ìƒì„±
            if (barLeft >= -barWidth && barLeft <= totalWidth) {
              // ìƒ‰ìƒ í™•ì¸ (ê°œë³„ ìƒ‰ìƒ > ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ)
              var scheduleKey = eventData.name + '_' + scheduleIndex;
              var scheduleColor = scheduleData.customColor || scheduleColors[scheduleKey];
              var categoryColor = getCategoryColor(categoryData.name);
              var appliedColor = scheduleColor || categoryColor;
              
              var barClass = appliedColor ? 'project-bar custom-color' : 'project-bar status-' + scheduleData.status;
              var barStyle = 'position: absolute; top: 2px; left: ' + Math.max(0, barLeft) + 'px; width: ' + Math.min(barWidth, totalWidth - Math.max(0, barLeft)) + 'px; z-index: ' + (101 + scheduleIndex) + ';';
              
              if (appliedColor) {
                barStyle += ' background-color: ' + appliedColor + ';';
              }
              
              var scheduleBarHtml = '<div class="' + barClass + '" ' +
                'style="' + barStyle + '" ' +
                'title="' + scheduleData.name + ' (' + scheduleData.startDate + ' ~ ' + scheduleData.endDate + ')" ' +
                'data-schedule-index="' + scheduleIndex + '">' +
                '<span class="project-bar-text">' + (scheduleData.name.length > 20 ? scheduleData.name.substring(0, 20) + '...' : scheduleData.name).replace(/\n/g, '<br>') + '</span>' +
                '</div>';
              
              timelineRow.append(scheduleBarHtml);
            }
          }
        });
      });
    });
    
    // ë“œë˜ê·¸ ê¸°ëŠ¥ ì¬ì´ˆê¸°í™”
  initializeProjectBarDraggable();
    
         console.log('ë¶ˆëŸ¬ì˜¨ ë°ì´í„° ì ìš© ì™„ë£Œ');
   }

   // XLSX ë¡œë“œë§µ ë°ì´í„° ë‚´ë³´ë‚´ê¸° í•¨ìˆ˜ - ì‹¤ì œ ë Œë”ë§ê³¼ ë™ì¼í•˜ê²Œ êµ¬í˜„
   function exportRoadmapToXlsx() {
     console.log('XLSX ë¡œë“œë§µ ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì‹œì‘');
     
     var xlsxBtn = $('#exportXlsxBtn');
     var originalText = xlsxBtn.html();
     
     try {
       // ExcelJS ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í™•ì¸
       if (typeof ExcelJS === 'undefined') {
         throw new Error('ExcelJS ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
       }
       
       // ë°ì´í„° ìœ íš¨ì„± í™•ì¸
       var categoryCount = $('.category-header').length;
       var eventCount = $('.project-item').length;
       var scheduleCount = $('.project-bar').length;
       
       if (categoryCount === 0) {
         alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì¹´í…Œê³ ë¦¬ì™€ ì´ë²¤íŠ¸ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
         return;
       }
       
       // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
       xlsxBtn.html('<span class="json-btn-icon">â³</span>ë‚´ë³´ë‚´ëŠ” ì¤‘...');
       xlsxBtn.prop('disabled', true);
       
       // ë¹„ë™ê¸° ì²˜ë¦¬
       setTimeout(function() {
         try {
           // ìƒˆ ì›Œí¬ë¶ ìƒì„± (ExcelJS)
           var workbook = new ExcelJS.Workbook();
           
           // ë¡œë“œë§µ íƒ€ì„ë¼ì¸ ì‹œíŠ¸ ìƒì„±
           createRoadmapTimelineSheetExcelJS(workbook);
           
           // ìŠ¤ì¼€ì¤„ ë¦¬ìŠ¤íŠ¸ ì‹œíŠ¸ ìƒì„±
           createScheduleListSheetExcelJS(workbook);
           
           if (workbook.worksheets.length === 0) {
             throw new Error('ìƒì„±ëœ ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
           }
           
           // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
           var fileName = 'roadmap_' + formatLocalDate(new Date()) + '.xlsx';
           workbook.xlsx.writeBuffer().then(function(buffer) {
             var blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
             var url = URL.createObjectURL(blob);
             var a = document.createElement('a');
             a.href = url;
             a.download = fileName;
             a.click();
             URL.revokeObjectURL(url);
           });
           
           console.log('âœ… XLSX ë¡œë“œë§µ ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ');
           alert('ë¡œë“œë§µ ë°ì´í„°ê°€ Excel íŒŒì¼ë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤.');
           
           // ë²„íŠ¼ ìƒíƒœ ë³µì›
           xlsxBtn.html(originalText);
           xlsxBtn.prop('disabled', false);
           
         } catch (error) {
           console.error('XLSX ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
           alert('Excel íŒŒì¼ ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n\n' + error.message);
           
           // ë²„íŠ¼ ìƒíƒœ ë³µì›
           xlsxBtn.html(originalText);
           xlsxBtn.prop('disabled', false);
         }
       }, 100);
       
     } catch (error) {
       console.error('XLSX ë‚´ë³´ë‚´ê¸° ì´ˆê¸° ì˜¤ë¥˜:', error);
       alert('Excel íŒŒì¼ ë‚´ë³´ë‚´ê¸° ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n\n' + error.message);
       
       // ë²„íŠ¼ ìƒíƒœ ë³µì›
       xlsxBtn.html(originalText);
       xlsxBtn.prop('disabled', false);
     }
   }
   
   // ExcelJSìš© ë¡œë“œë§µ íƒ€ì„ë¼ì¸ ì‹œíŠ¸ ìƒì„± í•¨ìˆ˜
   function createRoadmapTimelineSheetExcelJS(workbook) {
     try {
       var cellWidth = <%= cell_width %>;
       var startDate = new Date(<%= start_date.to_time.to_i * 1000 %>);
       
       // ì›Œí¬ì‹œíŠ¸ ìƒì„±
       var worksheet = workbook.addWorksheet('ë¡œë“œë§µ íƒ€ì„ë¼ì¸');
       
       // ì›”ë³„ í—¤ë” ìƒì„±
       var months = [];
       $('.month-cell').each(function() {
         var monthText = $(this).text().trim();
         var monthWidth = parseInt($(this).css('width')) || 0;
         var monthDays = Math.round(monthWidth / cellWidth);
         
         if (monthText && monthDays > 0) {
           months.push({
             name: monthText,
             days: monthDays
           });
         }
       });
       
       // ì¼ë³„ í—¤ë” ìƒì„±
       var days = [];
       $('.day-cell').each(function() {
         var dayText = $(this).text().trim();
         if (dayText) {
           days.push(dayText);
         }
       });
       
       // ì²« ë²ˆì§¸ í–‰: ì›” í—¤ë”
       var monthRow = ['ì¹´í…Œê³ ë¦¬', 'ì´ë²¤íŠ¸'];
       var colIndex = 3; // ExcelJSëŠ” 1-based ì¸ë±ìŠ¤
       months.forEach(function(month) {
         monthRow.push(month.name);
         for (var i = 1; i < month.days; i++) {
           monthRow.push('');
         }
       });
       worksheet.addRow(monthRow);
       
       // ë‘ ë²ˆì§¸ í–‰: ì¼ í—¤ë”
       var dayRow = ['', ''];
       days.forEach(function(day) {
         dayRow.push(day);
       });
       worksheet.addRow(dayRow);
       
       // ì›” í—¤ë” ë³‘í•©
       var colIndex = 3;
       months.forEach(function(month) {
         if (month.days > 1) {
           worksheet.mergeCells(1, colIndex, 1, colIndex + month.days - 1);
         }
         colIndex += month.days;
       });
       
       // ë°ì´í„° í–‰ë“¤ ë° ìŠ¤ì¼€ì¤„ ë°” ìƒì„±
       var currentRowIndex = 3;
       
       $('.category-header').each(function() {
         var categoryHeader = $(this);
         var categoryIndex = categoryHeader.data('category-index');
         var categoryName = categoryHeader.find('.category-title').text().trim();
         
         // ì¹´í…Œê³ ë¦¬ í–‰ ì¶”ê°€
         var categoryRow = ['', ''];
         days.forEach(function() {
           categoryRow.push('');
         });
         categoryRow[0] = categoryName;
         worksheet.addRow(categoryRow);
         
         var categoryRowStart = currentRowIndex;
         currentRowIndex++;
         
         // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì´ë²¤íŠ¸ë“¤ ì²˜ë¦¬
         var eventRowsCount = 0;
         $('.project-item[data-category-index="' + categoryIndex + '"]').each(function() {
           var projectItem = $(this);
           var eventName = projectItem.find('.project-name').text().trim();
           
           // ì´ë²¤íŠ¸ í–‰ ì´ˆê¸°í™”
           var eventRow = ['', eventName];
           days.forEach(function() {
             eventRow.push('');
           });
           
           // í•´ë‹¹ ì´ë²¤íŠ¸ì˜ ìŠ¤ì¼€ì¤„ë“¤ ì²˜ë¦¬
           var timelineRow = $('.timeline-row[data-event-name="' + eventName + '"][data-category-name="' + categoryName + '"]');
           timelineRow.find('.project-bar').each(function(barIndex) {
             var scheduleBar = $(this);
             var scheduleName = scheduleBar.find('.project-bar-text').text().trim();
             var title = scheduleBar.attr('title') || '';
             
             // ìƒíƒœ ì •ë³´ ì¶”ì¶œ
             var statusClass = scheduleBar.attr('class') || '';
             var status = 'planning';
             if (statusClass.includes('status-completed')) status = 'completed';
             else if (statusClass.includes('status-in-progress')) status = 'in-progress';
             else if (statusClass.includes('status-review')) status = 'review';
             else if (statusClass.includes('status-on-hold')) status = 'on-hold';
             
             // titleì—ì„œ ì‹¤ì œ ë‚ ì§œ ë°ì´í„° ì¶”ì¶œ
             var dateMatch = title.match(/\((\d{4}-\d{2}-\d{2}) ~ (\d{4}-\d{2}-\d{2})\)/);
             if (dateMatch) {
               var scheduleStartDate = new Date(dateMatch[1]);
               var scheduleEndDate = new Date(dateMatch[2]);
               
               if (!isNaN(scheduleStartDate.getTime()) && !isNaN(scheduleEndDate.getTime())) {
                 var startDayIndex = Math.floor((scheduleStartDate - startDate) / (1000 * 60 * 60 * 24));
                 var endDayIndex = Math.floor((scheduleEndDate - startDate) / (1000 * 60 * 60 * 24));
                 
                 var excelStartCol = startDayIndex + 3; // ExcelJSëŠ” 1-based
                 var excelEndCol = endDayIndex + 3;
                 
                 if (excelStartCol >= 3 && excelStartCol <= eventRow.length) {
                   eventRow[excelStartCol - 1] = scheduleName; // 0-basedë¡œ ë³€í™˜
                   
                   // ìŠ¤ì¼€ì¤„ ë°” ë³‘í•© ë° ìŠ¤íƒ€ì¼ ì ìš©ì„ ìœ„í•œ ì •ë³´ ì €ì¥
                   // í•˜ë£¨ì§œë¦¬ ìŠ¤ì¼€ì¤„ë„ í¬í•¨í•˜ë„ë¡ >= ì¡°ê±´ ì‚¬ìš©
                   if (excelEndCol >= excelStartCol) {
                     // ê°œë³„ ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ í™•ì¸ (ê°œë³„ ìƒ‰ìƒ > ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ìš°ì„ ìˆœìœ„)
                     var scheduleIndex = scheduleBar.data('schedule-index') || barIndex;
                     var scheduleKey = eventName + '_' + scheduleIndex;
                     var scheduleColor = scheduleColors[scheduleKey];
                     var categoryColor = getCategoryColor(categoryName);
                     var finalColor = scheduleColor || categoryColor;
                     
                     console.log('Excel ë‚´ë³´ë‚´ê¸° - ì´ë²¤íŠ¸:', eventName, 'ìŠ¤ì¼€ì¤„:', scheduleName, 'ì¸ë±ìŠ¤:', scheduleIndex, 'ê°œë³„ìƒ‰ìƒ:', scheduleColor, 'ì¹´í…Œê³ ë¦¬ìƒ‰ìƒ:', categoryColor, 'ìµœì¢…ìƒ‰ìƒ:', finalColor);
                     
                     // ë³‘í•© ì •ë³´ë¥¼ ë°°ì—´ì— ì €ì¥ (ë‚˜ì¤‘ì— ì¼ê´„ ì²˜ë¦¬)
                     if (!worksheet.scheduleMerges) {
                       worksheet.scheduleMerges = [];
                     }
                     worksheet.scheduleMerges.push({
                       row: currentRowIndex,
                       startCol: excelStartCol,
                       endCol: excelEndCol,
                       status: status,
                       categoryColor: finalColor,
                       scheduleName: scheduleName,
                       isCustomColor: !!scheduleColor
                     });
                   }
                 }
               }
             }
           });
           
           worksheet.addRow(eventRow);
           eventRowsCount++;
           currentRowIndex++;
         });
         
         // ì¹´í…Œê³ ë¦¬ ë³‘í•©
         if (eventRowsCount > 0) {
           worksheet.mergeCells(categoryRowStart, 1, categoryRowStart + eventRowsCount, 1);
           
           // ì¹´í…Œê³ ë¦¬ ì…€ì— ìƒ‰ìƒ ì ìš©
           var categoryCell = worksheet.getCell(categoryRowStart, 1);
           var categoryColor = getCategoryColor(categoryName);
           
           if (categoryColor) {
             var fillColor = categoryColor.replace('#', 'FF'); // ARGB í˜•ì‹
             
             // í…ìŠ¤íŠ¸ ìƒ‰ìƒ ìë™ ì¡°ì •
             var rgb = categoryColor.replace('#', '');
             var r = parseInt(rgb.substr(0, 2), 16);
             var g = parseInt(rgb.substr(2, 2), 16);
             var b = parseInt(rgb.substr(4, 2), 16);
             var brightness = (r * 299 + g * 587 + b * 114) / 1000;
             var fontColor = brightness > 128 ? 'FF000000' : 'FFFFFFFF';
             
             categoryCell.fill = {
               type: 'pattern',
               pattern: 'solid',
               fgColor: { argb: fillColor }
             };
             
             categoryCell.font = {
               color: { argb: fontColor },
               bold: true,
               size: 11
             };
           } else {
             // ê¸°ë³¸ ìŠ¤íƒ€ì¼
             categoryCell.font = {
               bold: true,
               size: 11
             };
           }
           
           categoryCell.alignment = {
             horizontal: 'center',
             vertical: 'middle'
           };
         }
       });
       
       // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
       worksheet.getColumn(1).width = 20; // ì¹´í…Œê³ ë¦¬
       worksheet.getColumn(2).width = 25; // ì´ë²¤íŠ¸
       for (var i = 3; i <= days.length + 2; i++) {
         worksheet.getColumn(i).width = 2.8; // ì¼ë³„ ì»¬ëŸ¼ (30% ì¶•ì†Œ: 4 * 0.7 = 2.8)
       }
       
       // í—¤ë” ìŠ¤íƒ€ì¼ ì ìš©
       applyHeaderStyles(worksheet, days.length + 2);
       
       // í‹€ ê³ ì • ì„¤ì • (C3 ì…€ ê¸°ì¤€)
       worksheet.views = [
         {
           state: 'frozen',
           xSplit: 2,  // C ì»¬ëŸ¼ ê¸°ì¤€ (A=0, B=1, C=2)
           ySplit: 2,  // 3í–‰ ê¸°ì¤€ (0-basedì´ë¯€ë¡œ 2)
           topLeftCell: 'C3',
           activeCell: 'C3'
         }
       ];
       
       // ìŠ¤ì¼€ì¤„ ë°” ë³‘í•© ë° ìŠ¤íƒ€ì¼ ì ìš©
       if (worksheet.scheduleMerges && worksheet.scheduleMerges.length > 0) {
         console.log('ìŠ¤ì¼€ì¤„ ë°” ë³‘í•© ê°œìˆ˜:', worksheet.scheduleMerges.length);
         worksheet.scheduleMerges.forEach(function(merge) {
           try {
             // í•˜ë£¨ì§œë¦¬ ìŠ¤ì¼€ì¤„ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ë³‘í•© ì‹¤í–‰
             if (merge.startCol < merge.endCol) {
               worksheet.mergeCells(merge.row, merge.startCol, merge.row, merge.endCol);
               console.log('ë³‘í•© ì™„ë£Œ:', merge.scheduleName, 'í–‰:', merge.row, 'ì—´:', merge.startCol, '-', merge.endCol);
             } else {
               console.log('í•˜ë£¨ì§œë¦¬ ìŠ¤ì¼€ì¤„ (ë³‘í•© ì—†ìŒ):', merge.scheduleName, 'í–‰:', merge.row, 'ì—´:', merge.startCol);
             }
             
             // ìŠ¤íƒ€ì¼ì€ ëª¨ë“  ê²½ìš°ì— ì ìš©
             applyScheduleBarStyle(worksheet, merge.row, merge.startCol, merge.endCol, merge.status, merge.categoryColor);
             
           } catch (mergeError) {
             console.error('ë³‘í•© ì˜¤ë¥˜:', mergeError, merge);
           }
         });
       }
       
     } catch (error) {
       console.error('ExcelJS ë¡œë“œë§µ íƒ€ì„ë¼ì¸ ì‹œíŠ¸ ìƒì„± ì˜¤ë¥˜:', error);
     }
   }
   
   // ê¸°ì¡´ SheetJS í•¨ìˆ˜ (í˜¸í™˜ì„± ìœ ì§€)
   function createRoadmapTimelineSheet() {
     try {
       var cellWidth = <%= cell_width %>;
       var startDate = new Date(<%= start_date.to_time.to_i * 1000 %>);
       
       // ì›”ë³„ í—¤ë” ìƒì„±
       var months = [];
       $('.month-cell').each(function() {
         var monthText = $(this).text().trim();
         var monthWidth = parseInt($(this).css('width')) || 0;
         var monthDays = Math.round(monthWidth / cellWidth);
         
         if (monthText && monthDays > 0) {
           months.push({
             name: monthText,
             days: monthDays
           });
         }
       });
       
       // ì¼ë³„ í—¤ë” ìƒì„±
       var days = [];
       $('.day-cell').each(function() {
         var dayText = $(this).text().trim();
         if (dayText) {
           days.push(dayText);
         }
       });
       
       // ì›Œí¬ì‹œíŠ¸ ë°ì´í„° ë°°ì—´ ìƒì„±
       var wsData = [];
       
       // ì²« ë²ˆì§¸ í–‰: ì›” í—¤ë”
       var monthRow = ['ì¹´í…Œê³ ë¦¬', 'ì´ë²¤íŠ¸'];
       var colIndex = 2;
       months.forEach(function(month) {
         monthRow[colIndex] = month.name;
         for (var i = 1; i < month.days; i++) {
           monthRow[colIndex + i] = '';
         }
         colIndex += month.days;
       });
       wsData.push(monthRow);
       
       // ë‘ ë²ˆì§¸ í–‰: ì¼ í—¤ë”
       var dayRow = ['', ''];
       days.forEach(function(day) {
         dayRow.push(day);
       });
       wsData.push(dayRow);
       
       // ë°ì´í„° í–‰ë“¤ ìƒì„±
       var scheduleMerges = []; // ìŠ¤ì¼€ì¤„ ë°” ë³‘í•© ì •ë³´ ì €ì¥
       var currentRowIndex = 2; // í˜„ì¬ í–‰ ì¸ë±ìŠ¤ (í—¤ë” 2í–‰ ì´í›„ë¶€í„°)
       
       $('.category-header').each(function() {
         var categoryHeader = $(this);
         var categoryIndex = categoryHeader.data('category-index');
         var categoryName = categoryHeader.find('.category-title').text().trim();
         
         // ì¹´í…Œê³ ë¦¬ í–‰ ì¶”ê°€
         var categoryRow = new Array(dayRow.length).fill('');
         categoryRow[0] = categoryName;
         wsData.push(categoryRow);
         currentRowIndex++;
         
         // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì´ë²¤íŠ¸ë“¤ ì²˜ë¦¬
         $('.project-item[data-category-index="' + categoryIndex + '"]').each(function() {
           var projectItem = $(this);
           var eventName = projectItem.find('.project-name').text().trim();
           
           // ì´ë²¤íŠ¸ í–‰ ì´ˆê¸°í™”
           var eventRow = new Array(dayRow.length).fill('');
           eventRow[0] = '';
           eventRow[1] = eventName;
           
           // í•´ë‹¹ ì´ë²¤íŠ¸ì˜ ìŠ¤ì¼€ì¤„ë“¤ ì²˜ë¦¬
           var timelineRow = $('.timeline-row[data-event-name="' + eventName + '"][data-category-name="' + categoryName + '"]');
           timelineRow.find('.project-bar').each(function() {
             var scheduleBar = $(this);
             var scheduleName = scheduleBar.find('.project-bar-text').text().trim();
             var title = scheduleBar.attr('title') || '';
             
             // ìƒíƒœ ì •ë³´ ì¶”ì¶œ
             var statusClass = scheduleBar.attr('class') || '';
             var status = 'planning'; // ê¸°ë³¸ê°’
             if (statusClass.includes('status-completed')) status = 'completed';
             else if (statusClass.includes('status-in-progress')) status = 'in-progress';
             else if (statusClass.includes('status-review')) status = 'review';
             else if (statusClass.includes('status-on-hold')) status = 'on-hold';
             
             // titleì—ì„œ ì‹¤ì œ ë‚ ì§œ ë°ì´í„° ì¶”ì¶œ
             var dateMatch = title.match(/\((\d{4}-\d{2}-\d{2}) ~ (\d{4}-\d{2}-\d{2})\)/);
             if (dateMatch) {
               var scheduleStartDate = new Date(dateMatch[1]);
               var scheduleEndDate = new Date(dateMatch[2]);
               
               // ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬
               if (!isNaN(scheduleStartDate.getTime()) && !isNaN(scheduleEndDate.getTime())) {
                 // íƒ€ì„ë¼ì¸ ì‹œì‘ì¼ ê¸°ì¤€ìœ¼ë¡œ ì¼ìˆ˜ ê³„ì‚°
                 var startDayIndex = Math.floor((scheduleStartDate - startDate) / (1000 * 60 * 60 * 24));
                 var endDayIndex = Math.floor((scheduleEndDate - startDate) / (1000 * 60 * 60 * 24));
                 
                 // ì—‘ì…€ ì»¬ëŸ¼ ì¸ë±ìŠ¤ ê³„ì‚° (ì¹´í…Œê³ ë¦¬, ì´ë²¤íŠ¸ ì»¬ëŸ¼ ì œì™¸)
                 var excelStartCol = startDayIndex + 2;
                 var excelEndCol = endDayIndex + 2;
                 
                 // ìœ íš¨í•œ ë²”ìœ„ ë‚´ì— ìˆëŠ”ì§€ í™•ì¸
                 if (excelStartCol >= 2 && excelStartCol < eventRow.length) {
                   eventRow[excelStartCol] = scheduleName;
                   
                   // ë³‘í•© ì •ë³´ ì €ì¥ (2ê°œ ì´ìƒ ì…€ì„ ì°¨ì§€í•˜ëŠ” ê²½ìš°ë§Œ)
                   if (excelEndCol > excelStartCol && excelEndCol < eventRow.length) {
                     // ì¹´í…Œê³ ë¦¬ ì»¤ìŠ¤í…€ ìƒ‰ìƒ í™•ì¸
                     var categoryColor = getCategoryColor(categoryName);
                     
                     scheduleMerges.push({
                       s: { r: currentRowIndex, c: excelStartCol },
                       e: { r: currentRowIndex, c: excelEndCol },
                       status: status, // ìƒíƒœ ì •ë³´ë„ í•¨ê»˜ ì €ì¥
                       categoryColor: categoryColor // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì •ë³´ ì¶”ê°€
                     });
                   }
                 }
               }
             }
           });
           
           wsData.push(eventRow);
           currentRowIndex++;
         });
       });
       
       // ì›Œí¬ì‹œíŠ¸ ìƒì„±
       var ws = XLSX.utils.aoa_to_sheet(wsData);
       
       // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
       var colWidths = [
         { width: 20 }, // ì¹´í…Œê³ ë¦¬
         { width: 25 }  // ì´ë²¤íŠ¸
       ];
       
       // ì¼ë³„ ì»¬ëŸ¼ ë„ˆë¹„ ì¶”ê°€
       for (var i = 0; i < days.length; i++) {
         colWidths.push({ width: 4 });
       }
       ws['!cols'] = colWidths;
       
       // ë³‘í•© ì˜ì—­ ì„¤ì •
       var merges = [];
       
       // ì›” í—¤ë” ë³‘í•©
       var colIndex = 2;
       months.forEach(function(month) {
         if (month.days > 1) {
           merges.push({
             s: { r: 0, c: colIndex },
             e: { r: 0, c: colIndex + month.days - 1 }
           });
         }
         colIndex += month.days;
       });
       
       // ì¹´í…Œê³ ë¦¬ ë³‘í•© (ì¹´í…Œê³ ë¦¬ í–‰ì˜ ê²½ìš° ì²« ë²ˆì§¸ ì»¬ëŸ¼ í™•ì¥)
       var rowIndex = 2;
       $('.category-header').each(function() {
         var categoryHeader = $(this);
         var categoryIndex = categoryHeader.data('category-index');
         var eventCount = $('.project-item[data-category-index="' + categoryIndex + '"]').length;
         
         if (eventCount > 0) {
           merges.push({
             s: { r: rowIndex, c: 0 },
             e: { r: rowIndex + eventCount, c: 0 }
           });
         }
         
         rowIndex += eventCount + 1;
       });
       
       // ìŠ¤ì¼€ì¤„ ë°” ë³‘í•© ì •ë³´ ì¶”ê°€
       merges = merges.concat(scheduleMerges);
       
       ws['!merges'] = merges;
       
       // ìŠ¤íƒ€ì¼ ì ìš©
       applyTimelineStyles(ws, wsData, scheduleMerges);
       
       return ws;
       
     } catch (error) {
       console.error('ë¡œë“œë§µ íƒ€ì„ë¼ì¸ ì‹œíŠ¸ ìƒì„± ì˜¤ë¥˜:', error);
       return null;
     }
   }
   
   // ìŠ¤ì¼€ì¤„ ë¦¬ìŠ¤íŠ¸ ì‹œíŠ¸ ìƒì„± í•¨ìˆ˜
   function createScheduleListSheet() {
     try {
       var scheduleList = [];
       
       $('.category-header').each(function() {
         var categoryHeader = $(this);
         var categoryIndex = categoryHeader.data('category-index');
         var categoryName = categoryHeader.find('.category-title').text().trim();
         
         $('.project-item[data-category-index="' + categoryIndex + '"]').each(function() {
           var projectItem = $(this);
           var eventName = projectItem.find('.project-name').text().trim();
           
           var timelineRow = $('.timeline-row[data-event-name="' + eventName + '"][data-category-name="' + categoryName + '"]');
           var hasSchedules = false;
           
           timelineRow.find('.project-bar').each(function() {
             var scheduleBar = $(this);
             var title = scheduleBar.attr('title') || '';
             var scheduleName = scheduleBar.find('.project-bar-text').text().trim();
             
             // ë‚ ì§œ ì¶”ì¶œ
             var dateMatch = title.match(/\((\d{4}-\d{2}-\d{2}) ~ (\d{4}-\d{2}-\d{2})\)/);
             var startDate = '';
             var endDate = '';
             var duration = '';
             
             if (dateMatch) {
               startDate = dateMatch[1];
               endDate = dateMatch[2];
               
               var start = new Date(startDate);
               var end = new Date(endDate);
               if (!isNaN(start.getTime()) && !isNaN(end.getTime())) {
                 var diffTime = Math.abs(end - start);
                 var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                 duration = diffDays + 'ì¼';
               }
             }
             
             // ìƒíƒœ ì¶”ì¶œ
             var statusClass = scheduleBar.attr('class') || '';
             var status = 'ê³„íšì¤‘';
             if (statusClass.includes('status-completed')) status = 'ì™„ë£Œ';
             else if (statusClass.includes('status-in-progress')) status = 'ì§„í–‰ì¤‘';
             else if (statusClass.includes('status-review')) status = 'ê²€í† ì¤‘';
             else if (statusClass.includes('status-on-hold')) status = 'ë³´ë¥˜';
             
             scheduleList.push({
               'ì¹´í…Œê³ ë¦¬': categoryName,
               'ì´ë²¤íŠ¸': eventName,
               'ìŠ¤ì¼€ì¤„ëª…': scheduleName,
               'ì‹œì‘ì¼': startDate,
               'ì¢…ë£Œì¼': endDate,
               'ìƒíƒœ': status,
               'ê¸°ê°„': duration
             });
             
             hasSchedules = true;
           });
           
           if (!hasSchedules) {
             scheduleList.push({
               'ì¹´í…Œê³ ë¦¬': categoryName,
               'ì´ë²¤íŠ¸': eventName,
               'ìŠ¤ì¼€ì¤„ëª…': '(ìŠ¤ì¼€ì¤„ ì—†ìŒ)',
               'ì‹œì‘ì¼': '',
               'ì¢…ë£Œì¼': '',
               'ìƒíƒœ': '',
               'ê¸°ê°„': ''
             });
           }
         });
       });
       
       if (scheduleList.length === 0) {
         return null;
       }
       
       var ws = XLSX.utils.json_to_sheet(scheduleList);
       
       // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
       ws['!cols'] = [
         { width: 20 }, // ì¹´í…Œê³ ë¦¬
         { width: 25 }, // ì´ë²¤íŠ¸
         { width: 30 }, // ìŠ¤ì¼€ì¤„ëª…
         { width: 12 }, // ì‹œì‘ì¼
         { width: 12 }, // ì¢…ë£Œì¼
         { width: 10 }, // ìƒíƒœ
         { width: 8 }   // ê¸°ê°„
       ];
       
       return ws;
       
     } catch (error) {
       console.error('ìŠ¤ì¼€ì¤„ ë¦¬ìŠ¤íŠ¸ ì‹œíŠ¸ ìƒì„± ì˜¤ë¥˜:', error);
       return null;
     }
   }
   
   // íƒ€ì„ë¼ì¸ ìŠ¤íƒ€ì¼ ì ìš© í•¨ìˆ˜
   function applyTimelineStyles(ws, wsData, scheduleMerges) {
     try {
       // í—¤ë” ìŠ¤íƒ€ì¼ ì„¤ì •
       var headerStyle = {
         font: { bold: true },
         fill: { fgColor: { rgb: "E6E6E6" } },
         alignment: { horizontal: "center", vertical: "center" },
         border: {
           top: { style: "thin" },
           bottom: { style: "thin" },
           left: { style: "thin" },
           right: { style: "thin" }
         }
       };
       
       // ì¹´í…Œê³ ë¦¬ ìŠ¤íƒ€ì¼ ì„¤ì •
       var categoryStyle = {
         font: { bold: true },
         fill: { fgColor: { rgb: "F0F0F0" } },
         alignment: { horizontal: "left", vertical: "center" },
         border: {
           top: { style: "thin" },
           bottom: { style: "thin" },
           left: { style: "thin" },
           right: { style: "thin" }
         }
       };
       
       // ì´ë²¤íŠ¸ ìŠ¤íƒ€ì¼ ì„¤ì •
       var eventStyle = {
         alignment: { horizontal: "left", vertical: "center" },
         border: {
           top: { style: "thin" },
           bottom: { style: "thin" },
           left: { style: "thin" },
           right: { style: "thin" }
         }
       };
       
       // ìŠ¤ì¼€ì¤„ ë°” ìŠ¤íƒ€ì¼ ì„¤ì • (ìƒíƒœë³„ ìƒ‰ìƒ)
       var scheduleStyles = {
         'completed': { fill: { fgColor: { rgb: "28A745" } }, font: { color: { rgb: "FFFFFF" } } },
         'in-progress': { fill: { fgColor: { rgb: "007BFF" } }, font: { color: { rgb: "FFFFFF" } } },
         'review': { fill: { fgColor: { rgb: "FFC107" } }, font: { color: { rgb: "000000" } } },
         'on-hold': { fill: { fgColor: { rgb: "6C757D" } }, font: { color: { rgb: "FFFFFF" } } },
         'planning': { fill: { fgColor: { rgb: "DC3545" } }, font: { color: { rgb: "FFFFFF" } } }
       };
       
       // ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì ìš©
       for (var r = 0; r < wsData.length; r++) {
         for (var c = 0; c < wsData[r].length; c++) {
           var cellAddr = XLSX.utils.encode_cell({ r: r, c: c });
           
           if (!ws[cellAddr]) {
             ws[cellAddr] = { t: 's', v: '' };
           }
           
           // í—¤ë” í–‰ ìŠ¤íƒ€ì¼
           if (r < 2) {
             ws[cellAddr].s = headerStyle;
           }
           // ì¹´í…Œê³ ë¦¬ ì»¬ëŸ¼ ìŠ¤íƒ€ì¼
           else if (c === 0 && wsData[r][c]) {
             ws[cellAddr].s = categoryStyle;
           }
           // ì´ë²¤íŠ¸ ì»¬ëŸ¼ ìŠ¤íƒ€ì¼
           else if (c === 1) {
             ws[cellAddr].s = eventStyle;
           }
           // ê¸°ë³¸ ì…€ ìŠ¤íƒ€ì¼
           else {
             ws[cellAddr].s = {
               border: {
                 top: { style: "thin" },
                 bottom: { style: "thin" },
                 left: { style: "thin" },
                 right: { style: "thin" }
               }
             };
           }
         }
       }
       
       // ìŠ¤ì¼€ì¤„ ë°” ìŠ¤íƒ€ì¼ ì ìš© (ë³‘í•©ëœ ì˜ì—­)
       scheduleMerges.forEach(function(merge) {
         var status = merge.status || 'planning';
         var categoryColor = merge.categoryColor;
         var style = {};
         
         // ì¹´í…Œê³ ë¦¬ ì»¤ìŠ¤í…€ ìƒ‰ìƒì´ ìˆìœ¼ë©´ ìš°ì„  ì ìš©, ì—†ìœ¼ë©´ ìƒíƒœë³„ ìƒ‰ìƒ ì ìš©
         if (categoryColor) {
           // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì ìš©
           style.fill = { fgColor: { rgb: categoryColor.replace('#', '') } };
           
           // í…ìŠ¤íŠ¸ ìƒ‰ìƒ ìë™ ì¡°ì • (ë°ì€ ìƒ‰ìƒì´ë©´ ê²€ì€ ê¸€ì”¨, ì–´ë‘ìš´ ìƒ‰ìƒì´ë©´ í° ê¸€ì”¨)
           var rgb = categoryColor.replace('#', '');
           var r = parseInt(rgb.substr(0, 2), 16);
           var g = parseInt(rgb.substr(2, 2), 16);
           var b = parseInt(rgb.substr(4, 2), 16);
           var brightness = (r * 299 + g * 587 + b * 114) / 1000;
           
           if (brightness > 128) {
             style.font = { color: { rgb: "000000" } }; // ë°ì€ ë°°ê²½ì—ëŠ” ê²€ì€ ê¸€ì”¨
           } else {
             style.font = { color: { rgb: "FFFFFF" } }; // ì–´ë‘ìš´ ë°°ê²½ì—ëŠ” í° ê¸€ì”¨
           }
         } else {
           // ìƒíƒœë³„ ê¸°ë³¸ ìƒ‰ìƒ ì ìš©
           style = Object.assign({}, scheduleStyles[status]);
         }
         
         // í…Œë‘ë¦¬ ì¶”ê°€
         style.border = {
           top: { style: "thin" },
           bottom: { style: "thin" },
           left: { style: "thin" },
           right: { style: "thin" }
         };
         
         style.alignment = { horizontal: "center", vertical: "center" };
         
         // ë³‘í•© ì˜ì—­ì˜ ëª¨ë“  ì…€ì— ìŠ¤íƒ€ì¼ ì ìš©
         for (var r = merge.s.r; r <= merge.e.r; r++) {
           for (var c = merge.s.c; c <= merge.e.c; c++) {
             var cellAddr = XLSX.utils.encode_cell({ r: r, c: c });
             if (!ws[cellAddr]) {
               ws[cellAddr] = { t: 's', v: '' };
             }
             ws[cellAddr].s = style;
           }
         }
       });
       
     } catch (error) {
       console.error('íƒ€ì„ë¼ì¸ ìŠ¤íƒ€ì¼ ì ìš© ì˜¤ë¥˜:', error);
     }
   }
   
   // ExcelJSìš© ìŠ¤ì¼€ì¤„ ë¦¬ìŠ¤íŠ¸ ì‹œíŠ¸ ìƒì„± í•¨ìˆ˜
   function createScheduleListSheetExcelJS(workbook) {
     try {
       var worksheet = workbook.addWorksheet('ìŠ¤ì¼€ì¤„ ë¦¬ìŠ¤íŠ¸');
       
       // í—¤ë” í–‰ ì¶”ê°€
       var headerRow = worksheet.addRow(['ì¹´í…Œê³ ë¦¬', 'ì´ë²¤íŠ¸', 'ìŠ¤ì¼€ì¤„ëª…', 'ì‹œì‘ì¼', 'ì¢…ë£Œì¼', 'ìƒíƒœ', 'ê¸°ê°„']);
       
       // í—¤ë” ìŠ¤íƒ€ì¼ ì ìš©
       headerRow.eachCell(function(cell) {
         cell.font = { bold: true };
         cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE6E6E6' } };
         cell.alignment = { horizontal: 'center', vertical: 'middle' };
         cell.border = {
           top: { style: 'thin' },
           left: { style: 'thin' },
           bottom: { style: 'thin' },
           right: { style: 'thin' }
         };
       });
       
       // ë°ì´í„° í–‰ ì¶”ê°€
       $('.category-header').each(function() {
         var categoryHeader = $(this);
         var categoryIndex = categoryHeader.data('category-index');
         var categoryName = categoryHeader.find('.category-title').text().trim();
         
         $('.project-item[data-category-index="' + categoryIndex + '"]').each(function() {
           var projectItem = $(this);
           var eventName = projectItem.find('.project-name').text().trim();
           
           var timelineRow = $('.timeline-row[data-event-name="' + eventName + '"][data-category-name="' + categoryName + '"]');
           var hasSchedules = false;
           
           timelineRow.find('.project-bar').each(function() {
             var scheduleBar = $(this);
             var title = scheduleBar.attr('title') || '';
             var scheduleName = scheduleBar.find('.project-bar-text').text().trim();
             
             var dateMatch = title.match(/\((\d{4}-\d{2}-\d{2}) ~ (\d{4}-\d{2}-\d{2})\)/);
             var startDate = '';
             var endDate = '';
             var duration = '';
             
             if (dateMatch) {
               startDate = dateMatch[1];
               endDate = dateMatch[2];
               
               var start = new Date(startDate);
               var end = new Date(endDate);
               if (!isNaN(start.getTime()) && !isNaN(end.getTime())) {
                 var diffTime = Math.abs(end - start);
                 var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                 duration = diffDays + 'ì¼';
               }
             }
             
             var statusClass = scheduleBar.attr('class') || '';
             var status = 'ê³„íšì¤‘';
             if (statusClass.includes('status-completed')) status = 'ì™„ë£Œ';
             else if (statusClass.includes('status-in-progress')) status = 'ì§„í–‰ì¤‘';
             else if (statusClass.includes('status-review')) status = 'ê²€í† ì¤‘';
             else if (statusClass.includes('status-on-hold')) status = 'ë³´ë¥˜';
             
             var dataRow = worksheet.addRow([categoryName, eventName, scheduleName, startDate, endDate, status, duration]);
             
             // ë°ì´í„° í–‰ ìŠ¤íƒ€ì¼ ì ìš©
             dataRow.eachCell(function(cell) {
               cell.border = {
                 top: { style: 'thin' },
                 left: { style: 'thin' },
                 bottom: { style: 'thin' },
                 right: { style: 'thin' }
               };
               cell.alignment = { horizontal: 'left', vertical: 'middle' };
             });
             
             hasSchedules = true;
           });
           
           if (!hasSchedules) {
             var dataRow = worksheet.addRow([categoryName, eventName, '(ìŠ¤ì¼€ì¤„ ì—†ìŒ)', '', '', '', '']);
             dataRow.eachCell(function(cell) {
               cell.border = {
                 top: { style: 'thin' },
                 left: { style: 'thin' },
                 bottom: { style: 'thin' },
                 right: { style: 'thin' }
               };
               cell.alignment = { horizontal: 'left', vertical: 'middle' };
             });
           }
         });
       });
       
       // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
       worksheet.getColumn(1).width = 20; // ì¹´í…Œê³ ë¦¬
       worksheet.getColumn(2).width = 25; // ì´ë²¤íŠ¸
       worksheet.getColumn(3).width = 30; // ìŠ¤ì¼€ì¤„ëª…
       worksheet.getColumn(4).width = 12; // ì‹œì‘ì¼
       worksheet.getColumn(5).width = 12; // ì¢…ë£Œì¼
       worksheet.getColumn(6).width = 10; // ìƒíƒœ
       worksheet.getColumn(7).width = 8;  // ê¸°ê°„
       
     } catch (error) {
       console.error('ExcelJS ìŠ¤ì¼€ì¤„ ë¦¬ìŠ¤íŠ¸ ì‹œíŠ¸ ìƒì„± ì˜¤ë¥˜:', error);
     }
   }
   
   // ExcelJSìš© ìŠ¤ì¼€ì¤„ ë°” ìŠ¤íƒ€ì¼ ì ìš© í•¨ìˆ˜
   function applyScheduleBarStyle(worksheet, rowIndex, startCol, endCol, status, categoryColor) {
     try {
       // ì…€ ê°€ì ¸ì˜¤ê¸° (ë³‘í•©ì€ ì´ë¯¸ ì™„ë£Œë¨)
       var cell = worksheet.getCell(rowIndex, startCol);
       
       console.log('ìŠ¤íƒ€ì¼ ì ìš© ì‹œì‘:', 'í–‰:', rowIndex, 'ì—´:', startCol, 'ì¹´í…Œê³ ë¦¬ìƒ‰ìƒ:', categoryColor);
       
       // ìƒ‰ìƒ ê²°ì •
       var fillColor = '';
       var fontColor = 'FFFFFFFF'; // ê¸°ë³¸ í°ìƒ‰
       
       if (categoryColor) {
         // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ìš°ì„  ì ìš©
         fillColor = categoryColor.replace('#', 'FF'); // ARGB í˜•ì‹
         
         // í…ìŠ¤íŠ¸ ìƒ‰ìƒ ìë™ ì¡°ì •
         var rgb = categoryColor.replace('#', '');
         var r = parseInt(rgb.substr(0, 2), 16);
         var g = parseInt(rgb.substr(2, 2), 16);
         var b = parseInt(rgb.substr(4, 2), 16);
         var brightness = (r * 299 + g * 587 + b * 114) / 1000;
         
         if (brightness > 128) {
           fontColor = 'FF000000'; // ë°ì€ ë°°ê²½ì—ëŠ” ê²€ì€ ê¸€ì”¨
         }
       } else {
         // ìƒíƒœë³„ ê¸°ë³¸ ìƒ‰ìƒ
         switch(status) {
           case 'completed': fillColor = 'FF28A745'; break;
           case 'in-progress': fillColor = 'FF007BFF'; break;
           case 'review': fillColor = 'FFFFC107'; fontColor = 'FF000000'; break;
           case 'on-hold': fillColor = 'FF6C757D'; break;
           case 'planning': fillColor = 'FFDC3545'; break;
           default: fillColor = 'FFDC3545'; break;
         }
       }
       
       // ìŠ¤íƒ€ì¼ ì ìš©
       cell.fill = {
         type: 'pattern',
         pattern: 'solid',
         fgColor: { argb: fillColor }
       };
       
       cell.font = {
         color: { argb: fontColor },
         bold: true,
         size: 8
       };
       
       cell.alignment = {
         horizontal: 'center',
         vertical: 'middle',
         wrapText: true
       };
       
       cell.border = {
         top: { style: 'thin' },
         left: { style: 'thin' },
         bottom: { style: 'thin' },
         right: { style: 'thin' }
       };
       
       console.log('ìŠ¤íƒ€ì¼ ì ìš© ì™„ë£Œ:', 'ë°°ê²½ìƒ‰:', fillColor, 'ê¸€ììƒ‰:', fontColor);
       
     } catch (error) {
       console.error('ExcelJS ìŠ¤ì¼€ì¤„ ë°” ìŠ¤íƒ€ì¼ ì ìš© ì˜¤ë¥˜:', error);
     }
   }
   
   // ë‚ ì§œ ê°’ì—ì„œ ìš”ì¼ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜
   function getDayOfWeek(dayValue, colIndex) {
     try {
       var startDate = new Date(<%= start_date.to_time.to_i * 1000 %>);
       var dayNumber = parseInt(dayValue);
       
       if (isNaN(dayNumber)) {
         return -1; // ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œ
       }
       
       // ì»¬ëŸ¼ ì¸ë±ìŠ¤ë¡œë¶€í„° ë‚ ì§œ ê³„ì‚° (3ì—´ë¶€í„° ì‹œì‘)
       var daysFromStart = colIndex - 3;
       var currentDate = new Date(startDate);
       currentDate.setDate(startDate.getDate() + daysFromStart);
       
       return currentDate.getDay(); // 0: ì¼ìš”ì¼, 1: ì›”ìš”ì¼, ..., 6: í† ìš”ì¼
     } catch (error) {
       console.error('getDayOfWeek ì˜¤ë¥˜:', error);
       return -1;
     }
   }

   // ExcelJSìš© í—¤ë” ìŠ¤íƒ€ì¼ ì ìš© í•¨ìˆ˜
   function applyHeaderStyles(worksheet, columnCount) {
     try {
       // ì²« ë²ˆì§¸ í–‰ (ì›” í—¤ë”)
       for (var col = 1; col <= columnCount; col++) {
         var cell = worksheet.getCell(1, col);
         cell.font = { bold: true };
         cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE6E6E6' } };
         cell.alignment = { horizontal: 'center', vertical: 'middle' };
         
         // ë‚ ì§œ ì»¬ëŸ¼ì— ëŒ€í•´ ì›” êµ¬ë¶„ì„  í™•ì¸ (ë‘ ë²ˆì§¸ í–‰ì˜ ê°’ í™•ì¸)
         var isMonthBoundary = false;
         if (col >= 3) {
           var dayHeaderCell = worksheet.getCell(2, col);
           var dayValue = dayHeaderCell.value;
           if (dayValue && dayValue.toString() === '1') {
             isMonthBoundary = true;
           }
         }
         
         // ì›” êµ¬ë¶„ì„ ì€ 1ì¼ ì…€ì˜ ì™¼ìª½ë§Œ ê²€ì€ìƒ‰, ì˜¤ë¥¸ìª½ì€ íšŒìƒ‰
         if (isMonthBoundary) {
           cell.border = {
             top: { style: 'thin' },
             left: { style: 'thin' }, // 1ì¼ ì…€ì˜ ì™¼ìª½ì€ ê²€ì€ìƒ‰
             bottom: { style: 'thin' },
             right: { style: 'thin', color: { argb: 'FFD0D0D0' } } // 1ì¼ ì…€ì˜ ì˜¤ë¥¸ìª½ì€ íšŒìƒ‰
           };
         } else {
           cell.border = {
             top: { style: 'thin' },
             left: { style: 'thin', color: { argb: col >= 3 ? 'FFD0D0D0' : 'FF000000' } },
             bottom: { style: 'thin' },
             right: { style: 'thin', color: { argb: col >= 3 ? 'FFD0D0D0' : 'FF000000' } }
           };
         }
       }
       
       // ë‘ ë²ˆì§¸ í–‰ (ì¼ í—¤ë”) - ë³¼ë“œì²´ ì œê±° ë° ìš”ì¼ë³„ ìƒ‰ìƒ ì ìš©
       for (var col = 1; col <= columnCount; col++) {
         var cell = worksheet.getCell(2, col);
         var cellValue = cell.value;
         
         // ë³¼ë“œì²´ ì œê±°
         cell.font = { bold: false };
         
         // ìš”ì¼ë³„ ìƒ‰ìƒ ì ìš© (3ì—´ë¶€í„° ë‚ ì§œ ë°ì´í„°)
         if (col >= 3 && cellValue) {
           var dayValue = cellValue.toString();
           var dayOfWeek = getDayOfWeek(dayValue, col);
           
           if (dayOfWeek === 0) { // ì¼ìš”ì¼
             cell.font = { bold: false, color: { argb: 'FFFF0000' } }; // ë¹¨ê°„ìƒ‰
           } else if (dayOfWeek === 6) { // í† ìš”ì¼
             cell.font = { bold: false, color: { argb: 'FF0000FF' } }; // íŒŒë€ìƒ‰
           }
         }
         
         cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE6E6E6' } };
         cell.alignment = { horizontal: 'center', vertical: 'middle' };
         
         // ë‚ ì§œ ì»¬ëŸ¼ì— ëŒ€í•´ ì›” êµ¬ë¶„ì„  í™•ì¸
         var isMonthBoundary = false;
         if (col >= 3 && cellValue && cellValue.toString() === '1') {
           isMonthBoundary = true;
         }
         
         // ì›” êµ¬ë¶„ì„ ì€ 1ì¼ ì…€ì˜ ì™¼ìª½ë§Œ ê²€ì€ìƒ‰, ì˜¤ë¥¸ìª½ì€ íšŒìƒ‰
         if (isMonthBoundary) {
           cell.border = {
             top: { style: 'thin' },
             left: { style: 'thin' }, // 1ì¼ ì…€ì˜ ì™¼ìª½ì€ ê²€ì€ìƒ‰
             bottom: { style: 'thin' },
             right: { style: 'thin', color: { argb: 'FFD0D0D0' } } // 1ì¼ ì…€ì˜ ì˜¤ë¥¸ìª½ì€ íšŒìƒ‰
           };
         } else {
           cell.border = {
             top: { style: 'thin' },
             left: { style: 'thin', color: { argb: col >= 3 ? 'FFD0D0D0' : 'FF000000' } },
             bottom: { style: 'thin' },
             right: { style: 'thin', color: { argb: col >= 3 ? 'FFD0D0D0' : 'FF000000' } }
           };
         }
       }
       
       // ì¹´í…Œê³ ë¦¬ ë° ì´ë²¤íŠ¸ ì»¬ëŸ¼ ìŠ¤íƒ€ì¼
       var rowCount = worksheet.rowCount;
       var lastCategoryRow = -1;
       var isEventInCategoryAppeared = false;
       
       for (var row = 3; row <= rowCount; row++) {
         // ì¹´í…Œê³ ë¦¬ ì»¬ëŸ¼
         var categoryCell = worksheet.getCell(row, 1);
         if (categoryCell.value) {
           categoryCell.font = { bold: true };
           categoryCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F0F0' } };
           lastCategoryRow = row;
           isEventInCategoryAppeared = false;
         }
         categoryCell.alignment = { horizontal: 'left', vertical: 'middle' };
         categoryCell.border = {
           top: { style: 'thin' },
           left: { style: 'thin' },
           bottom: { style: 'thin' },
           right: { style: 'thin' }
         };
         
         // ì´ë²¤íŠ¸ ì»¬ëŸ¼
         var eventCell = worksheet.getCell(row, 2);
         eventCell.alignment = { horizontal: 'left', vertical: 'middle' };
         eventCell.border = {
           top: { style: 'thin' },
           left: { style: 'thin' },
           bottom: { style: 'thin' },
           right: { style: 'thin' }
         };
         
         // ì´ë²¤íŠ¸ í–‰ ì²˜ë¦¬
         var isSeparatorRow = false;
         if (eventCell.value && eventCell.value.toString().trim() !== '') {
           isEventInCategoryAppeared = true;
           // ì²« ë²ˆì§¸ ì´ë²¤íŠ¸ í–‰ - ë†’ì´ 2ë°°ë¡œ ìœ ì§€, ê¸°ë³¸ ë°°ê²½
           worksheet.getRow(row).height = 30; // ê¸°ë³¸ ë†’ì´ 15ì˜ 2ë°° 
         }
         else
         {
            if( !isEventInCategoryAppeared )
            {
              // êµ¬ë¶„ìš© í–‰ - ë†’ì´ 1/3ë¡œ ì¶•ì†Œ, íšŒìƒ‰ ë°°ê²½
              worksheet.getRow(row).height = 5; // ê¸°ë³¸ ë†’ì´ 15ì˜ 1/3
              eventCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD0D0D0' } }; // íšŒìƒ‰ ë°°ê²½
              isSeparatorRow = true;
              // êµ¬ë¶„ìš© í–‰ì¸ ê²½ìš° ì¹´í…Œê³ ë¦¬ ì…€ì—ë„ íšŒìƒ‰ ë°°ê²½ ì ìš©
              categoryCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD0D0D0' } };
            }
          }
         
         // ì¼ë³„ ì»¬ëŸ¼ë“¤
         for (var col = 3; col <= columnCount; col++) {
           var cell = worksheet.getCell(row, col);
           
           // ë‚ ì§œ ë°ì´í„°ì—ì„œ ì›” êµ¬ë¶„ì„  í™•ì¸
           var dayHeaderCell = worksheet.getCell(2, col);
           var dayValue = dayHeaderCell.value;
           var isMonthBoundary = false;
           
           // 1ì¼ì¸ ê²½ìš° ì›” êµ¬ë¶„ì„ ìœ¼ë¡œ ì²˜ë¦¬
           if (dayValue && dayValue.toString() === '1') {
             isMonthBoundary = true;
           }
           
           // ì›” êµ¬ë¶„ì„ ì€ 1ì¼ ì…€ì˜ ì™¼ìª½ë§Œ ê²€ì€ìƒ‰, ì˜¤ë¥¸ìª½ì€ íšŒìƒ‰
           if (isMonthBoundary) {
             cell.border = {
               top: { style: 'thin' },
               left: { style: 'thin' }, // 1ì¼ ì…€ì˜ ì™¼ìª½ì€ ê²€ì€ìƒ‰
               bottom: { style: 'thin' },
               right: { style: 'thin', color: { argb: 'FFD0D0D0' } } // 1ì¼ ì…€ì˜ ì˜¤ë¥¸ìª½ì€ íšŒìƒ‰
             };
           } else {
             cell.border = {
               top: { style: 'thin' },
               left: { style: 'thin', color: { argb: 'FFD0D0D0' } },
               bottom: { style: 'thin' },
               right: { style: 'thin', color: { argb: 'FFD0D0D0' } }
             };
           }
           
           // êµ¬ë¶„ìš© ì—´ì˜ ëª¨ë“  ì…€ì— íšŒìƒ‰ ë°°ê²½ ì ìš©
           if (isSeparatorRow) {
             cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD0D0D0' } };
           }
         }
       }
       
     } catch (error) {
       console.error('ExcelJS í—¤ë” ìŠ¤íƒ€ì¼ ì ìš© ì˜¤ë¥˜:', error);
     }
   }

   // PNG ë¡œë“œë§µ ì´ë¯¸ì§€ ë‚´ë³´ë‚´ê¸° í•¨ìˆ˜
   function exportRoadmapToPng() {
     console.log('PNG ë¡œë“œë§µ ì´ë¯¸ì§€ ë‚´ë³´ë‚´ê¸° ì‹œì‘');
     
     var pngBtn = $('#exportPngBtn');
     var originalText = pngBtn.html();
     
     try {
       // html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í™•ì¸
       if (typeof html2canvas === 'undefined') {
         throw new Error('html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
       }
       
       // ìº¡ì²˜í•  ìš”ì†Œ ì„ íƒ
       var roadmapContainer = $('.roadmap-container');
       
       if (roadmapContainer.length === 0) {
         throw new Error('ë¡œë“œë§µ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
       }
       
       // ì´ë²¤íŠ¸ê°€ ìˆëŠ” ì˜ì—­ë§Œ ìº¡ì²˜í•˜ê¸° ìœ„í•œ ê³„ì‚°
       var timelineElement = roadmapContainer.find('.roadmap-timeline')[0];
       var timelineBodyElement = roadmapContainer.find('.timeline-body')[0];
       
       // ëª¨ë“  í”„ë¡œì íŠ¸ ë°”ì˜ ìœ„ì¹˜ë¥¼ ë¶„ì„í•˜ì—¬ ì‹¤ì œ ì‚¬ìš© ì˜ì—­ ê³„ì‚°
       var projectBars = roadmapContainer.find('.project-bar');
       var cellWidth = <%= cell_width %>;
       var sidebarWidth = 300;
       var minLeft = Infinity;
       var maxRight = -Infinity;
       
       console.log('í”„ë¡œì íŠ¸ ë°” ê°œìˆ˜:', projectBars.length);
       
       if (projectBars.length > 0) {
         projectBars.each(function() {
           var $bar = $(this);
           // style ì†ì„±ì—ì„œ ì§ì ‘ left ê°’ íŒŒì‹± (ë” ì •í™•í•¨)
           var styleLeft = $bar.attr('style') || '';
           var leftMatch = styleLeft.match(/left:\s*(\d+)px/);
           var widthMatch = styleLeft.match(/width:\s*(\d+)px/);
           
           var barLeft = leftMatch ? parseInt(leftMatch[1]) : 0;
           var barWidth = widthMatch ? parseInt(widthMatch[1]) : 0;
           var barRight = barLeft + barWidth;
           
           console.log('í”„ë¡œì íŠ¸ ë°”:', $bar.find('.project-bar-text').text(), 'left:', barLeft, 'width:', barWidth);
           
           minLeft = Math.min(minLeft, barLeft);
           maxRight = Math.max(maxRight, barRight);
         });
         
         // ì—¬ë°± ì¶”ê°€ (ì¢Œìš° ê°ê° 2ì£¼ ì •ë„)
         var marginDays = 14;
         var marginWidth = marginDays * cellWidth;
         minLeft = Math.max(0, minLeft - marginWidth);
         maxRight = maxRight + marginWidth;
         
         console.log('ì´ë²¤íŠ¸ ì˜ì—­ - ì‹œì‘:', minLeft, 'ë:', maxRight);
         console.log('ì…€ ë„ˆë¹„:', cellWidth, 'ì—¬ë°±:', marginWidth);
         
         // ì»¨í…Œì´ë„ˆ ë„ˆë¹„ = ì‚¬ì´ë“œë°” + ì‹¤ì œ ì‚¬ìš©í•˜ëŠ” íƒ€ì„ë¼ì¸ ì˜ì—­
         var containerWidth = sidebarWidth + (maxRight - minLeft);
         
       } else {
         // ì´ë²¤íŠ¸ê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ 6ê°œì›” ì •ë„ë§Œ í‘œì‹œ
         var defaultWidth = 180 * cellWidth; // ì•½ 6ê°œì›”
         var containerWidth = sidebarWidth + defaultWidth;
         minLeft = 0;
         maxRight = defaultWidth;
         
         console.log('ì´ë²¤íŠ¸ ì—†ìŒ - ê¸°ë³¸ ë„ˆë¹„ ì‚¬ìš©:', containerWidth);
       }
       
       var containerHeight = Math.max(
         roadmapContainer[0].scrollHeight,
         timelineBodyElement ? timelineBodyElement.scrollHeight : 0
       );
       var maxWidth = 16000; // ìµœëŒ€ ë„ˆë¹„ ì œí•œ (DPI í–¥ìƒìœ¼ë¡œ ì¸í•œ ì¦ê°€)
       var maxHeight = 12000; // ìµœëŒ€ ë†’ì´ ì œí•œ (DPI í–¥ìƒìœ¼ë¡œ ì¸í•œ ì¦ê°€)
       
       console.log('ì›ë³¸ í¬ê¸°:', containerWidth + 'x' + containerHeight);
       
       // í¬ê¸°ê°€ ë„ˆë¬´ í° ê²½ìš° ìŠ¤ì¼€ì¼ ì¡°ì •
       var scale = 2.0; // ê¸°ë³¸ ìŠ¤ì¼€ì¼ì„ 2.0ìœ¼ë¡œ ì„¤ì • (DPI í–¥ìƒ)
       
       if (containerWidth > maxWidth || containerHeight > maxHeight) {
         var widthScale = maxWidth / containerWidth;
         var heightScale = maxHeight / containerHeight;
         scale = Math.min(widthScale, heightScale, 1.5); // ìµœëŒ€ ìŠ¤ì¼€ì¼ 1.5ë¡œ ì œí•œ (DPI ê³ ë ¤)
         
         console.log('í¬ê¸° ì œí•œìœ¼ë¡œ ì¸í•œ ìŠ¤ì¼€ì¼ ì¡°ì •:', scale);
       }
       
       // ì˜ˆìƒ ì´ë¯¸ì§€ í¬ê¸° ê³„ì‚°
       var finalWidth = Math.floor(containerWidth * scale);
       var finalHeight = Math.floor(containerHeight * scale);
       var estimatedPixels = finalWidth * finalHeight;
       var estimatedMemoryMB = (estimatedPixels * 4) / (1024 * 1024); // RGBA 4ë°”ì´íŠ¸ per pixel
       
       console.log('ì˜ˆìƒ ìµœì¢… í¬ê¸°:', finalWidth + 'x' + finalHeight);
       console.log('ì˜ˆìƒ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:', Math.round(estimatedMemoryMB) + 'MB');
       
       // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ ë„ˆë¬´ í° ê²½ìš° ê²½ê³ 
       if (estimatedMemoryMB > 500) {
         if (!confirm('ì´ë¯¸ì§€ í¬ê¸°ê°€ í½ë‹ˆë‹¤ (' + finalWidth + 'x' + finalHeight + ', ì•½ ' + Math.round(estimatedMemoryMB) + 'MB).\n\nê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€¢ ì˜ˆ: ê·¸ëŒ€ë¡œ ì§„í–‰\nâ€¢ ì•„ë‹ˆì˜¤: ì·¨ì†Œ')) {
           return;
         }
       }
       
       // ë²„íŠ¼ ìƒíƒœ ë³€ê²½ (ë¡œë”© í‘œì‹œ)
       pngBtn.html('<span class="json-btn-icon">â³</span>ìƒì„±ì¤‘...');
       pngBtn.prop('disabled', true);
       
       console.log('ë¡œë“œë§µ ì»¨í…Œì´ë„ˆ ìº¡ì²˜ ì‹œì‘... (ìŠ¤ì¼€ì¼: ' + scale + ')');
       
       // ìº¡ì²˜ ì˜µì…˜ ì„¤ì • (ìµœì í™”ë¨)
       var captureOptions = {
         useCORS: true,
         allowTaint: false, // ë³´ì•ˆ ê°•í™”
         backgroundColor: '#ffffff',
         scale: scale, // ë™ì ìœ¼ë¡œ ê³„ì‚°ëœ ìŠ¤ì¼€ì¼
         width: containerWidth,
         height: containerHeight,
         scrollX: 0,
         scrollY: 0,
         logging: false,
         removeContainer: true,
         foreignObjectRendering: false, // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ê°ì†Œ
         imageTimeout: 10000, // íƒ€ì„ì•„ì›ƒ ë‹¨ì¶•
         ignoreElements: function(element) {
           // ë¶ˆí•„ìš”í•œ ìš”ì†Œë“¤ ì œì™¸ (ë©”ëª¨ë¦¬ ì ˆì•½)
           if (element.classList && (
             element.classList.contains('json-controls') ||
             element.classList.contains('ui-resizable-handle') ||
             element.classList.contains('ui-draggable-helper')
           )) {
             return true;
           }
           return false;
         },
         onclone: function(clonedDoc) {
           // ë³µì œëœ ë¬¸ì„œì—ì„œ ì¶”ê°€ ìŠ¤íƒ€ì¼ ì ìš©
           var clonedContainer = clonedDoc.querySelector('.roadmap-container');
           if (clonedContainer) {
             // ìŠ¤í¬ë¡¤ë°” ë° ì˜¤ë²„í”Œë¡œìš° ì²˜ë¦¬
             clonedContainer.style.overflow = 'visible';
             clonedContainer.style.height = 'auto';
             clonedContainer.style.maxHeight = 'none';
             clonedContainer.style.position = 'static';
             clonedContainer.style.display = 'flex'; // flex ìœ ì§€
             clonedContainer.style.flexDirection = 'row'; // ê°€ë¡œ ë°°ì¹˜ ëª…ì‹œ
             clonedContainer.style.alignItems = 'flex-start'; // ìƒë‹¨ ì •ë ¬
             
             // ì‚¬ì´ë“œë°” ìµœì í™”
             var sidebar = clonedContainer.querySelector('.roadmap-sidebar');
             if (sidebar) {
               sidebar.style.overflow = 'visible';
               sidebar.style.height = 'auto';
               sidebar.style.maxHeight = 'none';
               sidebar.style.display = 'block'; // flex-itemìœ¼ë¡œ ìœ ì§€
               sidebar.style.width = '300px'; // ê³ ì • ë„ˆë¹„ ìœ ì§€
               sidebar.style.minWidth = '300px'; // ìµœì†Œ ë„ˆë¹„ ì„¤ì •
               sidebar.style.flexShrink = '0'; // ì¶•ì†Œ ë°©ì§€
               
               var sidebarContent = sidebar.querySelector('.sidebar-content');
               if (sidebarContent) {
                 sidebarContent.style.overflow = 'visible';
                 sidebarContent.style.height = 'auto';
                 sidebarContent.style.maxHeight = 'none';
               }
             }
             
             // íƒ€ì„ë¼ì¸ ì˜ì—­ ìµœì í™”
             var timeline = clonedContainer.querySelector('.roadmap-timeline');
             if (timeline) {
               timeline.style.overflow = 'visible'; // visibleë¡œ ë³€ê²½
               timeline.style.height = 'auto';
               timeline.style.maxHeight = 'none';
               timeline.style.display = 'flex'; // flexë¡œ ìœ ì§€
               timeline.style.flexDirection = 'column'; // ì„¸ë¡œ ë°°ì¹˜
               timeline.style.flex = '1'; // ë‚¨ì€ ê³µê°„ ì°¨ì§€
               timeline.style.minWidth = '0'; // flex ì¶•ì†Œ í—ˆìš©
               timeline.style.width = (maxRight - minLeft) + 'px'; // ë„ˆë¹„ ì œí•œ
               
               // íƒ€ì„ë¼ì¸ í—¤ë”ë„ ìµœì í™”
               var timelineHeader = timeline.querySelector('.timeline-header');
               if (timelineHeader) {
                 timelineHeader.style.overflow = 'visible'; // visibleë¡œ ë³€ê²½
                 timelineHeader.style.width = 'auto';
                 timelineHeader.style.flexShrink = '0'; // í—¤ë” ì¶•ì†Œ ë°©ì§€
                 
                 // í—¤ë” ë‚´ ì›”/ì¼ í—¤ë” í¬ë¡­
                 var monthHeader = timelineHeader.querySelector('.month-header');
                 var dayHeader = timelineHeader.querySelector('.day-header');
                 
                 if (monthHeader && dayHeader) {
                   monthHeader.style.transform = 'translateX(-' + minLeft + 'px)';
                   dayHeader.style.transform = 'translateX(-' + minLeft + 'px)';
                 }
               }
             }
             
             // íƒ€ì„ë¼ì¸ ë°”ë”” ìµœì í™” - ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„!
             var timelineBody = clonedContainer.querySelector('.timeline-body');
             if (timelineBody) {
               // ìŠ¤í¬ë¡¤ ì˜ì—­ì„ ì™„ì „íˆ í™•ì¥
               timelineBody.style.overflow = 'visible'; // visibleë¡œ ë³€ê²½í•˜ì—¬ ë‚´ìš©ì´ ë³´ì´ë„ë¡
               timelineBody.style.height = 'auto';
               timelineBody.style.maxHeight = 'none';
               timelineBody.style.minHeight = 'auto';
               
               // ì‹¤ì œ ìŠ¤í¬ë¡¤ ë†’ì´ë¡œ ì„¤ì •í•˜ì—¬ ëª¨ë“  ë‚´ìš©ì´ ë³´ì´ë„ë¡ í•¨
               var originalTimelineBody = document.querySelector('.timeline-body');
               if (originalTimelineBody) {
                 var fullHeight = originalTimelineBody.scrollHeight;
                 timelineBody.style.height = fullHeight + 'px';
                 console.log('íƒ€ì„ë¼ì¸ ë°”ë”” ë†’ì´ ì„¤ì •:', fullHeight + 'px');
               }
               
               // íƒ€ì„ë¼ì¸ ë°”ë”” ë‚´ ëª¨ë“  ìš”ì†Œë“¤ í¬ë¡­
               var dateGridLines = timelineBody.querySelector('.date-grid-lines');
               var todayLine = timelineBody.querySelector('.today-line');
               var timelineRows = timelineBody.querySelectorAll('.timeline-row');
               
               // ë‚ ì§œ ê·¸ë¦¬ë“œ ë¼ì¸ í¬ë¡­ - ì‚¬ì´ë“œë°” ì˜ì—­ ì œì™¸
               if (dateGridLines) {
                 dateGridLines.style.transform = 'translateX(-' + minLeft + 'px)';
                 dateGridLines.style.position = 'relative';
                 dateGridLines.style.overflow = 'visible'; // ì„¸ë¡œì„ ì´ ë³´ì´ë„ë¡
                 
                 // ê°œë³„ ë‚ ì§œ ê·¸ë¦¬ë“œ ë¼ì¸ë“¤ ì²˜ë¦¬
                 var gridLines = dateGridLines.querySelectorAll('.date-grid-line');
                 for (var k = 0; k < gridLines.length; k++) {
                   var line = gridLines[k];
                   var lineLeft = parseInt(line.style.left) || 0;
                   // í¬ë¡­ ë²”ìœ„ ë‚´ì— ìˆëŠ” ë¼ì¸ë§Œ í‘œì‹œ
                   if (lineLeft >= minLeft && lineLeft <= maxRight) {
                     line.style.display = 'block';
                   } else {
                     line.style.display = 'none';
                   }
                 }
               }
               
               // ì˜¤ëŠ˜ í‘œì‹œì„  í¬ë¡­
               if (todayLine) {
                 var todayLeft = parseInt(todayLine.style.left) || 0;
                 if (todayLeft >= minLeft && todayLeft <= maxRight) {
                   todayLine.style.left = (todayLeft - minLeft) + 'px';
                 } else {
                   todayLine.style.display = 'none'; // ë²”ìœ„ ë°–ì´ë©´ ìˆ¨ê¹€
                 }
               }
               
               // ëª¨ë“  íƒ€ì„ë¼ì¸ í–‰ í¬ë¡­
               for (var i = 0; i < timelineRows.length; i++) {
                 var row = timelineRows[i];
                 row.style.overflow = 'visible'; // í–‰ë³„ overflowë¥¼ visibleë¡œ ë³€ê²½
                 
                 // íƒ€ì„ë¼ì¸ ê·¸ë¦¬ë“œ í¬ë¡­
                 var timelineGrid = row.querySelector('.timeline-grid');
                 if (timelineGrid) {
                   timelineGrid.style.transform = 'translateX(-' + minLeft + 'px)';
                   timelineGrid.style.position = 'relative';
                   timelineGrid.style.overflow = 'visible'; // ê·¸ë¦¬ë“œ visibleë¡œ ë³€ê²½
                 }
                 
                 // í”„ë¡œì íŠ¸ ë°”ë“¤ ìœ„ì¹˜ ì¡°ì •
                 var projectBars = row.querySelectorAll('.project-bar');
                 for (var j = 0; j < projectBars.length; j++) {
                   var bar = projectBars[j];
                   // style ì†ì„±ì—ì„œ ì§ì ‘ left ê°’ íŒŒì‹±
                   var barStyle = bar.getAttribute('style') || '';
                   var barLeftMatch = barStyle.match(/left:\s*(\d+)px/);
                   var barLeft = barLeftMatch ? parseInt(barLeftMatch[1]) : 0;
                   
                   // ìƒˆë¡œìš´ ìœ„ì¹˜ ê³„ì‚°
                   var newLeft = barLeft - minLeft;
                   bar.style.left = newLeft + 'px';
                   
                   console.log('í”„ë¡œì íŠ¸ ë°” ìœ„ì¹˜ ì¡°ì •:', barLeft, '->', newLeft);
                 }
               }
             }
             
             // JSON ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤ ìˆ¨ê¸°ê¸°
             var controls = clonedDoc.querySelector('.json-controls');
             if (controls) {
               controls.style.display = 'none';
             }
             
             // ë¶ˆí•„ìš”í•œ ì• ë‹ˆë©”ì´ì…˜ ì œê±°
             var allElements = clonedDoc.querySelectorAll('*');
             for (var i = 0; i < allElements.length; i++) {
               allElements[i].style.transition = 'none';
               allElements[i].style.animation = 'none';
             }
           }
           
           console.log('DOM ë³µì œ ë° ìŠ¤íƒ€ì¼ ì ìš© ì™„ë£Œ');
         }
       };
       
       // html2canvasë¡œ ìº¡ì²˜ ì‹¤í–‰ (ë¹„ë™ê¸° ì²˜ë¦¬)
       setTimeout(function() {
         html2canvas(roadmapContainer[0], captureOptions).then(function(canvas) {
           try {
             console.log('ìº”ë²„ìŠ¤ ìƒì„± ì™„ë£Œ, í¬ê¸°:', canvas.width + 'x' + canvas.height);
             
             // ìº”ë²„ìŠ¤ í¬ê¸° ê²€ì¦
             if (canvas.width === 0 || canvas.height === 0) {
               throw new Error('ìƒì„±ëœ ìº”ë²„ìŠ¤ì˜ í¬ê¸°ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.');
             }
             
             var actualPixels = canvas.width * canvas.height;
             var actualMemoryMB = (actualPixels * 4) / (1024 * 1024);
             console.log('ì‹¤ì œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:', Math.round(actualMemoryMB) + 'MB');
             
             // Blob ë°©ì‹ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì´ë¯¸ì§€ ìƒì„±
             canvas.toBlob(function(blob) {
               if (!blob) {
                 throw new Error('ì´ë¯¸ì§€ Blob ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
               }
               
               console.log('Blob ìƒì„± ì™„ë£Œ, í¬ê¸°:', Math.round(blob.size / 1024) + 'KB');
               
               // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
               var url = URL.createObjectURL(blob);
               var downloadLink = document.createElement('a');
               var now = new Date();
               var filename = 'roadmap_' + now.getFullYear() + '-' + 
                             String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                             String(now.getDate()).padStart(2, '0') + '_' +
                             String(now.getHours()).padStart(2, '0') + 
                             String(now.getMinutes()).padStart(2, '0') + '.png';
               
               downloadLink.href = url;
               downloadLink.download = filename;
               downloadLink.style.display = 'none';
               
               // ì„ì‹œë¡œ DOMì— ì¶”ê°€í•˜ê³  í´ë¦­í•˜ì—¬ ë‹¤ìš´ë¡œë“œ
               document.body.appendChild(downloadLink);
               downloadLink.click();
               
               // ì •ë¦¬ ì‘ì—…
               setTimeout(function() {
                 document.body.removeChild(downloadLink);
                 URL.revokeObjectURL(url);
               }, 100);
               
               console.log('PNG ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:', filename);
               alert('ë¡œë“œë§µì´ PNG ì´ë¯¸ì§€ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n' +
                     'íŒŒì¼ëª…: ' + filename + '\n' +
                     'ì´ë¯¸ì§€ í¬ê¸°: ' + canvas.width + ' Ã— ' + canvas.height + ' í”½ì…€\n' +
                     'íŒŒì¼ í¬ê¸°: ' + Math.round(blob.size / 1024) + 'KB');
               
               // ë²„íŠ¼ ìƒíƒœ ë³µì›
               pngBtn.html(originalText);
               pngBtn.prop('disabled', false);
               
             }, 'image/png', 0.9); // PNG í˜•ì‹, í’ˆì§ˆ 90% (ë©”ëª¨ë¦¬ ì ˆì•½)
             
           } catch (downloadError) {
             console.error('PNG ì²˜ë¦¬ ì˜¤ë¥˜:', downloadError);
             
             // ëŒ€ì•ˆ: toDataURL ë°©ì‹ìœ¼ë¡œ ì¬ì‹œë„ (ë” ì‘ì€ í•´ìƒë„)
             try {
               console.log('ëŒ€ì•ˆ ë°©ì‹ìœ¼ë¡œ ì¬ì‹œë„...');
               var smallCanvas = document.createElement('canvas');
               var ctx = smallCanvas.getContext('2d');
               
               // í¬ê¸°ë¥¼ ì ˆë°˜ìœ¼ë¡œ ì¤„ì—¬ì„œ ì¬ì‹œë„
               var targetWidth = Math.floor(canvas.width * 0.5);
               var targetHeight = Math.floor(canvas.height * 0.5);
               
               smallCanvas.width = targetWidth;
               smallCanvas.height = targetHeight;
               
               // ì´ë¯¸ì§€ í’ˆì§ˆ ì„¤ì •
               ctx.imageSmoothingEnabled = true;
               ctx.imageSmoothingQuality = 'high';
               
               // ì¶•ì†Œëœ í¬ê¸°ë¡œ ê·¸ë¦¬ê¸°
               ctx.drawImage(canvas, 0, 0, targetWidth, targetHeight);
               
               // ì¶•ì†Œëœ ì´ë¯¸ì§€ë¥¼ ë°ì´í„° URLë¡œ ë³€í™˜
               var imageDataUrl = smallCanvas.toDataURL('image/png', 0.8);
               
               // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
               var downloadLink = document.createElement('a');
               var now = new Date();
               var filename = 'roadmap_small_' + now.getFullYear() + '-' + 
                             String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                             String(now.getDate()).padStart(2, '0') + '.png';
               
               downloadLink.href = imageDataUrl;
               downloadLink.download = filename;
               downloadLink.style.display = 'none';
               
               document.body.appendChild(downloadLink);
               downloadLink.click();
               document.body.removeChild(downloadLink);
               
               console.log('ì¶•ì†Œëœ PNG ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:', filename);
               alert('ë©”ëª¨ë¦¬ ì ˆì•½ì„ ìœ„í•´ ì¶•ì†Œëœ PNG ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n' +
                     'íŒŒì¼ëª…: ' + filename + '\n' +
                     'ì´ë¯¸ì§€ í¬ê¸°: ' + targetWidth + ' Ã— ' + targetHeight + ' í”½ì…€');
               
            } catch (fallbackError) {
               console.error('ëŒ€ì•ˆ ë°©ì‹ë„ ì‹¤íŒ¨:', fallbackError);
               alert('ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' +
                     'ì›ì¸: ' + downloadError.message + '\n\n' +
                     'í•´ê²° ë°©ë²•:\n' +
                     'â€¢ ë¸Œë¼ìš°ì € ì¤Œì„ 50% ì´í•˜ë¡œ ì¤„ì—¬ë³´ì„¸ìš”\n' +
                     'â€¢ ì¼ë¶€ ìŠ¤ì¼€ì¤„ì„ ìˆ¨ê¸´ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”\n' +
                     'â€¢ ë” ì‘ì€ ê¸°ê°„ì˜ ë¡œë“œë§µìœ¼ë¡œ ì¶•ì†Œí•´ë³´ì„¸ìš”');
            }
             
             // ë²„íŠ¼ ìƒíƒœ ë³µì›
             pngBtn.html(originalText);
             pngBtn.prop('disabled', false);
           }
           
         }).catch(function(canvasError) {
           console.error('ìº”ë²„ìŠ¤ ìƒì„± ì˜¤ë¥˜:', canvasError);
           
           var errorMessage = 'ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n';
           
           if (canvasError.message && (canvasError.message.includes('Invalid string length') || 
                                      canvasError.message.includes('RangeError') ||
                                      canvasError.message.includes('out of memory'))) {
             errorMessage += 'ì˜¤ë¥˜ ì›ì¸: ë©”ëª¨ë¦¬ ë¶€ì¡± (ì´ë¯¸ì§€ê°€ ë„ˆë¬´ í¼)\n\ní•´ê²° ë°©ë²•:\n';
             errorMessage += 'â€¢ ë¸Œë¼ìš°ì € ì¤Œì„ 25-50%ë¡œ ì¤„ì—¬ë³´ì„¸ìš”\n';
             errorMessage += 'â€¢ ë¡œë“œë§µì„ ì—¬ëŸ¬ ë²ˆì— ë‚˜ëˆ„ì–´ ìŠ¤í¬ë¦°ìƒ·ìœ¼ë¡œ ìº¡ì²˜í•˜ì„¸ìš”\n';
             errorMessage += 'â€¢ ì¼ë¶€ ì¹´í…Œê³ ë¦¬ë‚˜ ìŠ¤ì¼€ì¤„ì„ ìˆ¨ê¸´ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”\n';
             errorMessage += 'â€¢ ë” ì‘ì€ ê¸°ê°„(3-6ê°œì›”)ì˜ ë¡œë“œë§µìœ¼ë¡œ ì¶•ì†Œí•´ë³´ì„¸ìš”\n';
             errorMessage += 'â€¢ Chromeì˜ ì‹œí¬ë¦¿ ëª¨ë“œì—ì„œ ì‹œë„í•´ë³´ì„¸ìš”\n';
             errorMessage += 'â€¢ ì»´í“¨í„° ë©”ëª¨ë¦¬ê°€ ë¶€ì¡±í•œ ê²½ìš° ë‹¤ë¥¸ í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•˜ì„¸ìš”';
           } else if (canvasError.message && canvasError.message.includes('timeout')) {
             errorMessage += 'ì˜¤ë¥˜ ì›ì¸: ì²˜ë¦¬ ì‹œê°„ ì´ˆê³¼\n\ní•´ê²° ë°©ë²•:\n';
             errorMessage += 'â€¢ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”\n';
             errorMessage += 'â€¢ ë³µì¡í•œ ìŠ¤ì¼€ì¤„ì´ ë§ì€ ê²½ìš° ì¼ë¶€ë¥¼ ìˆ¨ê¸´ í›„ ì‹œë„í•˜ì„¸ìš”';
           } else if (canvasError.message && (canvasError.message.includes('tainted') || canvasError.message.includes('CORS'))) {
             errorMessage += 'ì˜¤ë¥˜ ì›ì¸: ì™¸ë¶€ ë¦¬ì†ŒìŠ¤ ì ‘ê·¼ ì œí•œ\n\ní•´ê²° ë°©ë²•:\n';
             errorMessage += 'â€¢ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”\n';
             errorMessage += 'â€¢ ë¸Œë¼ìš°ì €ì˜ ë³´ì•ˆ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”';
           } else {
             errorMessage += 'ì˜¤ë¥˜ ì„¸ë¶€ì‚¬í•­: ' + canvasError.message + '\n\n';
             errorMessage += 'í•´ê²° ë°©ë²•:\n';
             errorMessage += 'â€¢ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”\n';
             errorMessage += 'â€¢ ë‹¤ë¥¸ ë¸Œë¼ìš°ì €(Chrome, Firefox)ì—ì„œ ì‹œë„í•´ë³´ì„¸ìš”\n';
             errorMessage += 'â€¢ ë¸Œë¼ìš°ì €ì˜ í•˜ë“œì›¨ì–´ ê°€ì†ì„ ë¹„í™œì„±í™”í•´ë³´ì„¸ìš”\n';
             errorMessage += 'â€¢ ê°œë°œì ë„êµ¬(F12)ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”';
           }
           
           alert(errorMessage);
           
           // ë²„íŠ¼ ìƒíƒœ ë³µì›
           pngBtn.html(originalText);
           pngBtn.prop('disabled', false);
         });
       }, 100); // UI ì—…ë°ì´íŠ¸ ì™„ë£Œ ëŒ€ê¸°
       
     } catch (error) {
       console.error('PNG ë‚´ë³´ë‚´ê¸° ì´ˆê¸° ì˜¤ë¥˜:', error);
       alert('PNG ì´ë¯¸ì§€ ë‚´ë³´ë‚´ê¸° ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n\n' + error.message);
       
       // ë²„íŠ¼ ìƒíƒœ ë³µì›
       pngBtn.html(originalText);
       pngBtn.prop('disabled', false);
     }
   }

   // ì„œë²„ì—ì„œ ë¡œë“œë§µ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
   function loadRoadmapFromServer() {
     console.log('=== ì„œë²„ì—ì„œ ë¡œë“œë§µ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘ ===');
     
     $.ajax({
       url: '<%= load_roadmap_data_project_milestone_index_path(@project) %>',
       method: 'GET',
       success: function(response) {
         console.log('âœ… ì„œë²„ ë¡œë“œ ì„±ê³µ:', response);
         
         if (response.success && response.data) {
           // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ
           clearAllRoadmapData();
           
           // ìƒˆ ë°ì´í„° ì ìš©
           applyImportedData(response.data);
           
           // ì„œë²„ì—ì„œ ë°›ì€ ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì •ë³´ ë³µì›
           if (response.categories && Array.isArray(response.categories)) {
             console.log('ğŸ¨ ì„œë²„ì—ì„œ ë°›ì€ ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì •ë³´:', response.categories);
             
             // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì´ˆê¸°í™”
             categoryColors = {};
             // ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ ì´ˆê¸°í™”
             scheduleColors = {};
             
             response.categories.forEach(function(categoryData) {
               if (categoryData.name && categoryData.customColor) {
                 categoryColors[categoryData.name] = categoryData.customColor;
                 console.log('âœ… ì„œë²„ ë¡œë“œ - ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ë³µì›:', categoryData.name, '->', categoryData.customColor);
                 
                 // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ìŠ¤ì¼€ì¤„ ë°”ë“¤ì— ìƒ‰ìƒ ì ìš©
                 updateCategoryScheduleColors(categoryData.name, categoryData.customColor);
               } else {
                 console.log('âšª ì¹´í…Œê³ ë¦¬', categoryData.name, 'ì—ëŠ” ì»¤ìŠ¤í…€ ìƒ‰ìƒì´ ì—†ìŒ');
               }
               
               // ê°œë³„ ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ ë³µì›
               if (categoryData.events) {
                 categoryData.events.forEach(function(eventData) {
                   if (eventData.schedules) {
                     eventData.schedules.forEach(function(scheduleData, scheduleIndex) {
                       if (scheduleData.customColor) {
                         var scheduleKey = eventData.name + '_' + scheduleIndex;
                         scheduleColors[scheduleKey] = scheduleData.customColor;
                         console.log('âœ… ì„œë²„ ë¡œë“œ - ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ ë³µì›:', scheduleKey, '->', scheduleData.customColor);
                       }
                     });
                   }
                 });
               }
             });
             
             console.log('ğŸ¨ ì„œë²„ ë¡œë“œ í›„ ìµœì¢… ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ:', categoryColors);
             console.log('ğŸ¨ ì„œë²„ ë¡œë“œ í›„ ìµœì¢… ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ:', scheduleColors);
             console.log('ë³µì›ëœ ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ê°œìˆ˜:', Object.keys(categoryColors).length);
             console.log('ë³µì›ëœ ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ ê°œìˆ˜:', Object.keys(scheduleColors).length);
           } else {
             console.log('âŒ ì„œë²„ì—ì„œ ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì •ë³´ë¥¼ ë°›ì§€ ëª»í•¨');
           }
           
           console.log('âœ… ì„œë²„ì—ì„œ ë¡œë“œë§µ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ');
           
           // ë¼ì¸ ë†’ì´ ì—…ë°ì´íŠ¸
           setTimeout(function() {
             updateLineHeight();
           }, 200);
           
           alert('ì„œë²„ì—ì„œ ë¡œë“œë§µ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
         } else {
           console.log('âŒ ì„œë²„ ì‘ë‹µì— ë°ì´í„°ê°€ ì—†ìŒ:', response);
           alert('ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
         }
       },
       error: function(xhr, status, error) {
         console.error('âŒ ì„œë²„ ë¡œë“œ ì‹¤íŒ¨:', {
           status: xhr.status,
           statusText: xhr.statusText,
           responseText: xhr.responseText,
           error: error
         });
         alert('ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nìƒíƒœ: ' + xhr.status + '\nì˜¤ë¥˜: ' + error);
       }
     });
   }

   // ì„œë²„ì— ë¡œë“œë§µ ë°ì´í„° ì €ì¥ í•¨ìˆ˜
   function saveRoadmapToServer() {
     console.log('ì„œë²„ì— ë¡œë“œë§µ ë°ì´í„° ì €ì¥ ì‹œì‘');
     
     // í™•ì¸ ëŒ€í™”ìƒì
     if (!confirm('í˜„ì¬ ë¡œë“œë§µ ë°ì´í„°ë¥¼ ì„œë²„ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
       return;
     }
     
     // ë²„íŠ¼ ìƒíƒœ ë³€ê²½ (ë¡œë”© í‘œì‹œ)
     var saveBtn = $('#saveJsonBtn');
     var originalText = saveBtn.html();
     saveBtn.html('<span class="json-btn-icon">â³</span>Saving...');
     saveBtn.prop('disabled', true);
     
     // í˜„ì¬ ë¡œë“œë§µ ë°ì´í„° ìˆ˜ì§‘ (exportRoadmapDataì™€ ë™ì¼í•œ ë¡œì§)
     var saveData = {
       metadata: {
         saveDate: new Date().toISOString(),
         version: "1.0",
         description: "Redmine ë¡œë“œë§µ ë°ì´í„° - ì„œë²„ ì €ì¥"
       },
       categories: []
     };
     
     // ì‚¬ì´ë“œë°”ì—ì„œ ì¹´í…Œê³ ë¦¬ì™€ ì´ë²¤íŠ¸ ë°ì´í„° ìˆ˜ì§‘
     $('.category-header').each(function() {
       var categoryHeader = $(this);
       var categoryIndex = categoryHeader.data('category-index');
       var categoryName = categoryHeader.find('.category-title').text().trim();
       
       var categoryData = {
         name: categoryName,
         index: categoryIndex,
         customColor: categoryColors[categoryName] || null, // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì •ë³´ í¬í•¨
         events: []
       };
       
       // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì´ë²¤íŠ¸ë“¤ ìˆ˜ì§‘
       $('.project-item[data-category-index="' + categoryIndex + '"]').each(function() {
         var projectItem = $(this);
         var eventName = projectItem.find('.project-name').text().trim();
         
         var eventData = {
           name: eventName,
           schedules: []
         };
         
         // í•´ë‹¹ ì´ë²¤íŠ¸ì˜ ìŠ¤ì¼€ì¤„ë“¤ ìˆ˜ì§‘ (íƒ€ì„ë¼ì¸ì—ì„œ)
         var timelineRow = $('.timeline-row[data-event-name="' + eventName + '"][data-category-name="' + categoryName + '"]');
         timelineRow.find('.project-bar').each(function() {
           var scheduleBar = $(this);
           var title = scheduleBar.attr('title') || '';
           var scheduleName = scheduleBar.text().trim();
           
           // titleì—ì„œ ë‚ ì§œ ì¶”ì¶œ ì‹œë„
           var dateMatch = title.match(/\((\d{4}-\d{2}-\d{2}) ~ (\d{4}-\d{2}-\d{2})\)/);
           var startDate = null;
           var endDate = null;
           
           if (dateMatch) {
             startDate = dateMatch[1];
             endDate = dateMatch[2];
           }
           
           // ìƒíƒœ í´ë˜ìŠ¤ì—ì„œ ìƒíƒœ ì¶”ì¶œ
           var statusClass = scheduleBar.attr('class');
           var status = 'planning'; // ê¸°ë³¸ê°’
           if (statusClass.includes('status-')) {
             var statusMatch = statusClass.match(/status-([a-z-]+)/);
             if (statusMatch) {
               status = statusMatch[1];
             }
           }
           
           var scheduleData = {
             name: scheduleName,
             startDate: startDate,
             endDate: endDate,
             status: status
           };
           
           // ê°œë³„ ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ ì •ë³´ ì¶”ê°€
           var scheduleKey = eventName + '_' + scheduleIndex;
           if (scheduleColors[scheduleKey]) {
             scheduleData.customColor = scheduleColors[scheduleKey];
           }
           
           eventData.schedules.push(scheduleData);
         });
         
         categoryData.events.push(eventData);
       });
       
       saveData.categories.push(categoryData);
     });
     
     // ë””ë²„ê¹…ì„ ìœ„í•œ ë°ì´í„° ë¡œê¹…
     console.log('ì „ì†¡í•  ë°ì´í„°:', saveData);
     
     // ì„œë²„ì— AJAX ìš”ì²­ìœ¼ë¡œ ë°ì´í„° ì „ì†¡
     $.ajax({
       url: '<%= save_roadmap_data_project_milestone_index_path(@project) %>',
       method: 'POST',
       headers: {
         'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content'),
         'Content-Type': 'application/json'
       },
       data: JSON.stringify({
         roadmap_data: JSON.stringify(saveData),
         name: 'Roadmap - ' + new Date().toLocaleDateString('ko-KR')
       }),
       success: function(response) {
         console.log('ì„œë²„ ì €ì¥ ì„±ê³µ:', response);
         alert('ë¡œë“œë§µ ë°ì´í„°ê°€ ì„œë²„ì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
         
         // ë²„íŠ¼ ìƒíƒœ ë³µì›
         saveBtn.html(originalText);
         saveBtn.prop('disabled', false);
       },
       error: function(xhr, status, error) {
         console.error('ì„œë²„ ì €ì¥ ì‹¤íŒ¨:', {
           status: xhr.status,
           statusText: xhr.statusText,
           responseText: xhr.responseText,
           error: error
         });
         
         var errorMessage = 'ì„œë²„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n';
         if (xhr.responseText) {
           try {
             var errorData = JSON.parse(xhr.responseText);
             errorMessage += 'ì˜¤ë¥˜: ' + (errorData.message || errorData.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
           } catch (e) {
             errorMessage += 'ì„œë²„ ì‘ë‹µ: ' + xhr.responseText.substring(0, 200);
           }
         } else {
           errorMessage += 'ìƒíƒœ ì½”ë“œ: ' + xhr.status + '\nì˜¤ë¥˜: ' + error;
         }
         
         // ì„ì‹œ ë°©í¸: ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
         try {
           localStorage.setItem('roadmap_backup_' + new Date().getTime(), JSON.stringify(saveData));
           errorMessage += '\n\nì„ì‹œë¡œ ë¸Œë¼ìš°ì € ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ë°±ì—…ë˜ì—ˆìŠµë‹ˆë‹¤.';
         } catch (e) {
           // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ
         }
         
         alert(errorMessage);
         
         // ë²„íŠ¼ ìƒíƒœ ë³µì›
         saveBtn.html(originalText);
         saveBtn.prop('disabled', false);
       }
     });
   }

  // ìŠ¤ì¼€ì¤„ ë°” ìš°í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
  $(document).on('contextmenu', '.project-bar', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    var scheduleBar = $(this);
    var timelineRow = scheduleBar.closest('.timeline-row');
    var eventName = timelineRow.data('event-name');
    var categoryName = timelineRow.data('category-name');
    var scheduleName = scheduleBar.text().trim();
    
    console.log('ìŠ¤ì¼€ì¤„ ë°” ìš°í´ë¦­:', {
      event: eventName,
      category: categoryName,
      schedule: scheduleName
    });
    
    // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ìŠ¤ì¼€ì¤„ ë°” ì •ë³´ ì €ì¥
    currentEditingScheduleBar = {
      element: scheduleBar,
      eventName: eventName,
      categoryName: categoryName,
      scheduleName: scheduleName,
      scheduleIndex: scheduleBar.data('schedule-index')
    };
    
    // íŒì—…ì— ì •ë³´ ì„¤ì •
    $('#scheduleEditEventName').text(eventName);
    $('#scheduleEditCategoryName').text('(' + categoryName + ')');
    $('#scheduleEditName').val(scheduleName);
    
    // ìŠ¤ì¼€ì¤„ ë°”ì˜ ìœ„ì¹˜ì™€ í¬ê¸°ë¡œë¶€í„° ë‚ ì§œ ì •ë³´ ê³„ì‚°
    var startDate = null;
    var endDate = null;
    
    // titleì—ì„œ ë‚ ì§œ ì •ë³´ ì¶”ì¶œ ì‹œë„
    var title = scheduleBar.attr('title') || '';
    var dateMatch = title.match(/\((\d{4}-\d{2}-\d{2}) ~ (\d{4}-\d{2}-\d{2})\)/);
    
    if (dateMatch) {
      startDate = dateMatch[1];
      endDate = dateMatch[2];
    } else {
      // titleì—ì„œ ë‚ ì§œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìœ¼ë©´ ìœ„ì¹˜/í¬ê¸°ë¡œ ê³„ì‚°
      var barLeft = parseInt(scheduleBar.css('left')) || 0;
      var barWidth = scheduleBar.width() || <%= cell_width %>;
      var cellWidth = <%= cell_width %>;
      var startDateObj = new Date(<%= start_date.to_time.to_i * 1000 %>);
      
      // ì‹œì‘ì¼ ê³„ì‚°
      var startDayOffset = Math.floor(barLeft / cellWidth);
      var calculatedStartDate = new Date(startDateObj.getTime() + (startDayOffset * 24 * 60 * 60 * 1000));
      
      // ì¢…ë£Œì¼ ê³„ì‚° (ì¢…ë£Œì¼ ë¯¸í¬í•¨ ë°©ì‹ìœ¼ë¡œ ì¼ê´€ì„± ìœ ì§€)
      var durationDays = Math.ceil(barWidth / cellWidth);
      var calculatedEndDate = new Date(calculatedStartDate.getTime() + (durationDays * 24 * 60 * 60 * 1000));
      
      startDate = formatLocalDate(calculatedStartDate);
      endDate = formatLocalDate(calculatedEndDate);
      
      console.log('ìœ„ì¹˜ë¡œë¶€í„° ê³„ì‚°ëœ ë‚ ì§œ:', {
        barLeft: barLeft,
        barWidth: barWidth,
        startDate: startDate,
        endDate: endDate
      });
    }
    
    $('#scheduleEditStartDate').val(startDate);
    $('#scheduleEditEndDate').val(endDate);
    
    // ìƒíƒœ ì •ë³´ ì¶”ì¶œ
    var statusClass = scheduleBar.attr('class');
    var status = 'planning'; // ê¸°ë³¸ê°’
    if (statusClass.includes('status-')) {
      var statusMatch = statusClass.match(/status-([a-z-]+)/);
      if (statusMatch) {
        status = statusMatch[1];
      }
    }
    $('#scheduleEditStatus').val(status);
    
    // í˜„ì¬ ìŠ¤ì¼€ì¤„ì˜ ìƒ‰ìƒ ì •ë³´ ë¡œë“œ
    var scheduleKey = eventName + '_' + currentEditingScheduleBar.scheduleIndex;
    var currentScheduleColor = scheduleColors[scheduleKey] || null;
    
    // ìƒ‰ìƒ ì„ íƒ UI ì´ˆê¸°í™”
    initializeScheduleColorPicker(currentScheduleColor, categoryName);
    
    // íŒì—… í‘œì‹œ
    $('#scheduleEditPopup').addClass('show');
    
    // í¬ì»¤ìŠ¤ ì„¤ì •
    setTimeout(function() {
      $('#scheduleEditName').focus().select();
    }, 100);
  });

  // ìŠ¤ì¼€ì¤„ í¸ì§‘ íŒì—… ì·¨ì†Œ ë²„íŠ¼
  $('#scheduleEditCancelBtn').click(function(e) {
    e.preventDefault();
    hideScheduleEditPopup();
  });

  // ìŠ¤ì¼€ì¤„ í¸ì§‘ íŒì—… ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
  $('#scheduleEditPopup').click(function(e) {
    if (e.target === this) {
      hideScheduleEditPopup();
    }
  });

  // ìŠ¤ì¼€ì¤„ í¸ì§‘ íŒì—… ìˆ¨ê¸°ê¸° í•¨ìˆ˜
  function hideScheduleEditPopup() {
    $('#scheduleEditPopup').removeClass('show');
    currentEditingScheduleBar = null;
  }

  // ìŠ¤ì¼€ì¤„ í¸ì§‘ í¼ ì œì¶œ ì²˜ë¦¬
  $('#scheduleEditForm').submit(function(e) {
    e.preventDefault();
    
    if (!currentEditingScheduleBar) {
      console.error('í¸ì§‘ ì¤‘ì¸ ìŠ¤ì¼€ì¤„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    var newScheduleName = $('#scheduleEditName').val().trim();
    var newStartDate = $('#scheduleEditStartDate').val();
    var newEndDate = $('#scheduleEditEndDate').val();
    var newStatus = $('#scheduleEditStatus').val();
    var newColor = rgbToHex($('#scheduleColorPreview').css('background-color'));
    
    if (!newScheduleName || !newStartDate || !newEndDate) {
      alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    // ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬
    if (new Date(newStartDate) > new Date(newEndDate)) {
      alert('ì‹œì‘ì¼ì€ ì¢…ë£Œì¼ë³´ë‹¤ ëŠ¦ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    // ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ ì •ë³´ ì €ì¥
    var scheduleKey = currentEditingScheduleBar.eventName + '_' + currentEditingScheduleBar.scheduleIndex;
    var categoryColor = getCategoryColor(currentEditingScheduleBar.categoryName);
    
    // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒê³¼ ê°™ìœ¼ë©´ ê°œë³„ ìƒ‰ìƒ ì œê±°
    if (newColor === categoryColor) {
      delete scheduleColors[scheduleKey];
    } else {
      scheduleColors[scheduleKey] = newColor;
    }
    
    console.log('ìŠ¤ì¼€ì¤„ í¸ì§‘ ì €ì¥:', {
      name: newScheduleName,
      startDate: newStartDate,
      endDate: newEndDate,
      status: newStatus,
      color: newColor
    });
    
    // ìŠ¤ì¼€ì¤„ ë°” ì—…ë°ì´íŠ¸
    updateScheduleBar(currentEditingScheduleBar.element, {
      name: newScheduleName,
      start_date: parseLocalDate(newStartDate),
      end_date: parseLocalDate(newEndDate),
      status: newStatus,
      color: newColor
    });
    
    // íŒì—… ë‹«ê¸°
    hideScheduleEditPopup();
  });

  // ìŠ¤ì¼€ì¤„ ì‚­ì œ ë²„íŠ¼
  $('#scheduleEditDeleteBtn').click(function(e) {
    e.preventDefault();
    
    if (!currentEditingScheduleBar) {
      console.error('í¸ì§‘ ì¤‘ì¸ ìŠ¤ì¼€ì¤„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    var scheduleName = currentEditingScheduleBar.scheduleName;
    var eventName = currentEditingScheduleBar.eventName;
    
    if (confirm('ì •ë§ë¡œ "' + scheduleName + '" ìŠ¤ì¼€ì¤„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      console.log('ìŠ¤ì¼€ì¤„ ì‚­ì œ:', scheduleName);
      
      // ìŠ¤ì¼€ì¤„ ë°” ì œê±°
      currentEditingScheduleBar.element.remove();
      
      // ì‚¬ì´ë“œë°” í”„ë¡œì íŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸
      updateProjectInfo(eventName, currentEditingScheduleBar.categoryName);
      
      // íŒì—… ë‹«ê¸°
      hideScheduleEditPopup();
    }
  });

  // ìŠ¤ì¼€ì¤„ ë°” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateScheduleBar(scheduleBar, scheduleData) {
    var startDate = new Date(scheduleData.start_date);
    var endDate = new Date(scheduleData.end_date);
    var cellWidth = <%= cell_width %>;
    var startDateObj = new Date(<%= start_date.to_time.to_i * 1000 %>);
    
    // ìœ„ì¹˜ ê³„ì‚° - ë‹¤ë¥¸ í•¨ìˆ˜ë“¤ê³¼ ë™ì¼í•œ ë°©ì‹ ì‚¬ìš©
    var startDayIndex = Math.round((startDate - startDateObj) / (1000 * 60 * 60 * 24));
    var endDayIndex = Math.round((endDate - startDateObj) / (1000 * 60 * 60 * 24));
    var left = startDayIndex * cellWidth;
    var width = (endDayIndex - startDayIndex) * cellWidth;
    
    // ìƒ‰ìƒ ìš°ì„ ìˆœìœ„: ê°œë³„ ìƒ‰ìƒ > ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ > ìƒíƒœ ìƒ‰ìƒ
    var scheduleColor = scheduleData.color;
    var categoryColor = getCategoryColor(currentEditingScheduleBar.categoryName);
    
    // ìŠ¤ì¼€ì¤„ ë°” ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    scheduleBar.removeClass(function(index, className) {
      return (className.match(/status-\S+/g) || []).join(' ');
    });
    scheduleBar.removeClass('custom-color');
    
    if (scheduleColor) {
      // ê°œë³„ ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ ì ìš©
      scheduleBar.addClass('custom-color');
      scheduleBar.css('background-color', scheduleColor);
    } else if (categoryColor) {
      // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì ìš©
      scheduleBar.addClass('custom-color');
      scheduleBar.css('background-color', categoryColor);
    } else {
      // ê¸°ë³¸ ìƒíƒœ ìƒ‰ìƒ ì ìš©
      scheduleBar.addClass('status-' + scheduleData.status);
      scheduleBar.css('background-color', '');
    }
    
    // ìœ„ì¹˜ì™€ í¬ê¸° ì—…ë°ì´íŠ¸
    scheduleBar.css({
      left: left + 'px',
      width: width + 'px'
    });
    
    // í…ìŠ¤íŠ¸ì™€ title ì—…ë°ì´íŠ¸
    scheduleBar.html('<span class="project-bar-text">' + scheduleData.name.replace(/\n/g, '<br>') + '</span>');
    scheduleBar.attr('title', scheduleData.name + ' (' + 
      formatLocalDate(startDate) + ' ~ ' + 
      formatLocalDate(endDate) + ')');
    
    console.log('ìŠ¤ì¼€ì¤„ ë°” ì—…ë°ì´íŠ¸ ì™„ë£Œ:', scheduleData.name);
    
    // ì‚¬ì´ë“œë°” í”„ë¡œì íŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸
    updateProjectInfo(currentEditingScheduleBar.eventName, currentEditingScheduleBar.categoryName);
  }

  // í”„ë¡œì íŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ìŠ¤ì¼€ì¤„ ê°œìˆ˜ë§Œ í‘œì‹œ)
  function updateProjectInfo(eventName, categoryName) {
    // í•´ë‹¹ ì´ë²¤íŠ¸ì˜ íƒ€ì„ë¼ì¸ í–‰ ì°¾ê¸°
    var timelineRow = $('.timeline-row[data-event-name="' + eventName + '"][data-category-name="' + categoryName + '"]');
    if (timelineRow.length === 0) return;
    
    // ìŠ¤ì¼€ì¤„ ë°”ë“¤ ìˆ˜ì§‘
    var scheduleBars = timelineRow.find('.project-bar');
    var scheduleCount = scheduleBars.length;
    
    var info = scheduleCount + 'ê°œ ìŠ¤ì¼€ì¤„';
    
    // ì‚¬ì´ë“œë°”ì—ì„œ í•´ë‹¹ ì´ë²¤íŠ¸ ì°¾ì•„ì„œ ì •ë³´ ì—…ë°ì´íŠ¸
    $('.project-item').each(function() {
      var projectItem = $(this);
      var projectName = projectItem.find('.project-name').text().trim();
      if (projectName === eventName) {
        projectItem.find('.project-info').text(info);
        return false; // ì°¾ì•˜ìœ¼ë¯€ë¡œ ë£¨í”„ ì¢…ë£Œ
      }
    });
    
    console.log('í”„ë¡œì íŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸:', eventName, '->', info);
  }

  // ì´ë²¤íŠ¸ í¸ì§‘ ëª¨ë“œ ì§„ì…
  function enterEventEditMode(eventItem) {
    console.log('ì´ë²¤íŠ¸ í¸ì§‘ ëª¨ë“œ ì§„ì…');
    eventItem.addClass('editing');
    
    // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
    setTimeout(function() {
      eventItem.find('.event-edit-input').focus().select();
    }, 100);
  }

  // ì´ë²¤íŠ¸ í¸ì§‘ ì €ì¥
  function saveEvent(eventItem) {
    console.log('ì´ë²¤íŠ¸ í¸ì§‘ ì €ì¥');
    
    var newName = eventItem.find('.event-edit-input').val().trim();
    var oldName = eventItem.find('.project-name').text().trim();
    
    if (!newName) {
      alert('ì´ë²¤íŠ¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      eventItem.find('.event-edit-input').focus();
      return;
    }
    
    if (newName === oldName) {
      cancelEventEditMode(eventItem);
      return;
    }
    
    // ì‚¬ì´ë“œë°”ì—ì„œ ì´ë²¤íŠ¸ ì´ë¦„ ì—…ë°ì´íŠ¸
    eventItem.find('.project-name').html(newName.replace(/\n/g, '<br>'));
    
    // íƒ€ì„ë¼ì¸ì—ì„œ í•´ë‹¹ ì´ë²¤íŠ¸ì˜ data-event-name ì—…ë°ì´íŠ¸
    var categoryIndex = eventItem.data('category-index');
    var categoryHeader = $('.category-header[data-category-index="' + categoryIndex + '"]');
    var categoryName = categoryHeader.find('.category-title').text().trim();
    
    var timelineRow = $('.timeline-row[data-event-name="' + oldName + '"][data-category-name="' + categoryName + '"]');
    if (timelineRow.length > 0) {
      timelineRow.attr('data-event-name', newName);
      console.log('íƒ€ì„ë¼ì¸ í–‰ì˜ data-event-name ì—…ë°ì´íŠ¸:', oldName, '->', newName);
    }
    
    eventItem.removeClass('editing');
    console.log('ì´ë²¤íŠ¸ ì´ë¦„ ë³€ê²½ ì™„ë£Œ:', oldName, '->', newName);
  }

  // ì´ë²¤íŠ¸ í¸ì§‘ ëª¨ë“œ ì·¨ì†Œ
  function cancelEventEditMode(eventItem) {
    console.log('ì´ë²¤íŠ¸ í¸ì§‘ ëª¨ë“œ ì·¨ì†Œ');
    eventItem.removeClass('editing');
    
    var originalName = eventItem.find('.project-name').text();
    eventItem.find('.event-edit-input').val(originalName);
  }

  // ì´ë²¤íŠ¸ ì‚­ì œ
  function deleteEvent(eventItem) {
    console.log('ì´ë²¤íŠ¸ ì‚­ì œ ì‹œì‘');
    
    var eventName = eventItem.find('.project-name').text().trim();
    var categoryIndex = eventItem.data('category-index');
    var categoryHeader = $('.category-header[data-category-index="' + categoryIndex + '"]');
    var categoryName = categoryHeader.find('.category-title').text().trim();
    
    console.log('ì‚­ì œí•  ì´ë²¤íŠ¸:', eventName, 'ì¹´í…Œê³ ë¦¬:', categoryName);
    
    // 2. íƒ€ì„ë¼ì¸ì—ì„œ í•´ë‹¹ ì´ë²¤íŠ¸ í–‰ ì‚­ì œ
    var timelineRow = $('.timeline-row[data-event-name="' + eventName + '"][data-category-name="' + categoryName + '"]');
    if (timelineRow.length > 0) {
      timelineRow.remove();
      console.log('íƒ€ì„ë¼ì¸ í–‰ ì‚­ì œë¨');
    }
    
    // 3. ì‚¬ì´ë“œë°”ì—ì„œ ì´ë²¤íŠ¸ ì•„ì´í…œ ì‚­ì œ
    eventItem.remove();
    
    console.log('ì´ë²¤íŠ¸ ì‚­ì œ ì™„ë£Œ:', eventName);
  }
  
  // ìƒ‰ìƒ ì„ íƒ íŒì—… ìˆ¨ê¸°ê¸° í•¨ìˆ˜
  function hideColorPickerPopup() {
    $('#colorPickerPopup').removeClass('show');
    currentColorEditingTarget = null;
    selectedColor = '#6c757d';
  }
  
  // ìƒ‰ìƒ ì„ íƒ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateColorSelection(color) {
    // ëª¨ë“  ìƒ‰ìƒ ì•„ì´í…œì—ì„œ ì„ íƒ í•´ì œ
    $('.color-preset-item').removeClass('selected');
    
    // í•´ë‹¹í•˜ëŠ” ìƒ‰ìƒ ì•„ì´í…œì— ì„ íƒ í‘œì‹œ
    $('.color-preset-item[data-color="' + color + '"]').addClass('selected');
    
    // ë¯¸ë¦¬ë³´ê¸° ë°” ìƒ‰ìƒ ì—…ë°ì´íŠ¸
    $('#colorPreviewBar').css('background-color', color);
    
    // ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
    $('#customColorPicker').val(color);
  }
  
  // ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ ì„ íƒ UI ì´ˆê¸°í™” í•¨ìˆ˜
  function initializeScheduleColorPicker(currentColor, categoryName) {
    var displayColor = currentColor;
    if (!displayColor) {
      // ìƒ‰ìƒì´ ì—†ìœ¼ë©´ ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒìœ¼ë¡œ ì´ˆê¸°í™”
      var categoryColor = getCategoryColor(categoryName);
      displayColor = categoryColor || '#6c757d';
    }
    
    // ìƒ‰ìƒ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    $('#scheduleColorPreview').css('background-color', displayColor);
  }
  
  // ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ ì„ íƒ ë²„íŠ¼ í´ë¦­
  $('#scheduleColorSelectBtn, #scheduleColorPreview').click(function(e) {
    e.preventDefault();
    
    if (!currentEditingScheduleBar) return;
    
    // í˜„ì¬ ìŠ¤ì¼€ì¤„ì˜ ìƒ‰ìƒ ì •ë³´
    var scheduleKey = currentEditingScheduleBar.eventName + '_' + currentEditingScheduleBar.scheduleIndex;
    var currentColor = scheduleColors[scheduleKey] || getCategoryColor(currentEditingScheduleBar.categoryName) || '#6c757d';
    
    // í˜„ì¬ ìƒ‰ìƒ ë³€ê²½ ì¤‘ì¸ ëŒ€ìƒ ì •ë³´ ì €ì¥
    currentColorEditingTarget = {
      type: 'schedule',
      scheduleKey: scheduleKey,
      categoryName: currentEditingScheduleBar.categoryName,
      eventName: currentEditingScheduleBar.eventName,
      scheduleIndex: currentEditingScheduleBar.scheduleIndex
    };
    
    // íŒì—… íƒ€ì´í‹€ê³¼ ëŒ€ìƒ ì´ë¦„ ì„¤ì •
    $('#colorPickerTitle').text('ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ ì„ íƒ');
    $('#colorPickerTargetName').text(currentEditingScheduleBar.scheduleName);
    
    // í˜„ì¬ ìƒ‰ìƒ ì„¤ì •
    selectedColor = currentColor;
    updateColorSelection(currentColor);
    
    // íŒì—… í‘œì‹œ
    $('#colorPickerPopup').addClass('show');
  });
  
  // ìƒ‰ìƒ ì´ˆê¸°í™” ë²„íŠ¼
  $('#resetScheduleColorBtn').click(function(e) {
    e.preventDefault();
    
    if (!currentEditingScheduleBar) return;
    
    var categoryColor = getCategoryColor(currentEditingScheduleBar.categoryName) || '#6c757d';
    
    // ìƒ‰ìƒ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    $('#scheduleColorPreview').css('background-color', categoryColor);
    
    // ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ ì •ë³´ ì œê±°
    var scheduleKey = currentEditingScheduleBar.eventName + '_' + currentEditingScheduleBar.scheduleIndex;
    delete scheduleColors[scheduleKey];
  });

  // RGB ìƒ‰ìƒì„ HEXë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
  function rgbToHex(rgb) {
    if (!rgb || rgb.indexOf('rgb') !== 0) return rgb;
    
    var rgbMatch = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
    if (!rgbMatch) return rgb;
    
    function hex(x) {
      return ("0" + parseInt(x).toString(16)).slice(-2);
    }
    
    return "#" + hex(rgbMatch[1]) + hex(rgbMatch[2]) + hex(rgbMatch[3]);
  }

  // ì¹´í…Œê³ ë¦¬ì˜ ëª¨ë“  ì´ë²¤íŠ¸ ìŠ¤ì¼€ì¤„ ë°” ìƒ‰ìƒ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateCategoryScheduleColors(categoryName, color) {
    console.log('ì¹´í…Œê³ ë¦¬ ìŠ¤ì¼€ì¤„ ìƒ‰ìƒ ì—…ë°ì´íŠ¸:', categoryName, color);
    
    // ë§¤ê°œë³€ìˆ˜ ê²€ì¦
    if (!categoryName || typeof categoryName !== 'string') {
      console.error('âŒ ì˜ëª»ëœ ì¹´í…Œê³ ë¦¬ ì´ë¦„:', categoryName);
      return;
    }
    
    if (!color || typeof color !== 'string') {
      console.error('âŒ ì˜ëª»ëœ ìƒ‰ìƒ ê°’:', color);
      return;
    }
    
    // categoryColors ê°ì²´ ì•ˆì „ì„± í™•ì¸
    if (typeof categoryColors === 'undefined' || categoryColors === null) {
      console.warn('âš ï¸ categoryColors ê°ì²´ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ - ì´ˆê¸°í™” ì§„í–‰');
      categoryColors = {};
    }
    
    // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ëª¨ë“  íƒ€ì„ë¼ì¸ í–‰ ì°¾ê¸°
    var timelineRows = $('.timeline-row[data-category-name="' + categoryName + '"]');
    console.log('ì—…ë°ì´íŠ¸í•  íƒ€ì„ë¼ì¸ í–‰ ê°œìˆ˜:', timelineRows.length);
    
    timelineRows.each(function() {
      var timelineRow = $(this);
      var eventName = timelineRow.data('event-name');
      
      // í•´ë‹¹ í–‰ì˜ ëª¨ë“  ìŠ¤ì¼€ì¤„ ë°” ì°¾ê¸°
      var scheduleBars = timelineRow.find('.project-bar');
      console.log('ì´ë²¤íŠ¸ "' + eventName + '"ì˜ ìŠ¤ì¼€ì¤„ ë°” ê°œìˆ˜:', scheduleBars.length);
      
      // ê° ìŠ¤ì¼€ì¤„ ë°”ì˜ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
      scheduleBars.each(function(scheduleIndex) {
        var $bar = $(this);
        
        // ê°œë³„ ìŠ¤ì¼€ì¤„ ìƒ‰ìƒì´ ì§€ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        var scheduleKey = eventName + '_' + scheduleIndex;
        var hasCustomScheduleColor = scheduleColors[scheduleKey] !== undefined;
        
        // ê°œë³„ ìƒ‰ìƒì´ ì§€ì •ëœ ê²½ìš° ìŠ¤í‚µ
        if (hasCustomScheduleColor) {
          console.log('ìŠ¤ì¼€ì¤„ ë°” ê°œë³„ ìƒ‰ìƒ ìœ ì§€:', $bar.text().trim(), '->', scheduleColors[scheduleKey]);
          return; // continue to next schedule bar
        }
        
        // ê¸°ì¡´ ìƒíƒœ í´ë˜ìŠ¤ ì œê±°
        $bar.removeClass(function(index, className) {
          return (className.match(/status-\S+/g) || []).join(' ');
        });
        
        // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì ìš©
        $bar.css('background-color', color);
        $bar.addClass('custom-color');
        
        console.log('ìŠ¤ì¼€ì¤„ ë°” ìƒ‰ìƒ ì—…ë°ì´íŠ¸:', $bar.text().trim(), '->', color);
      });
    });
  }
  
  // ì¹´í…Œê³ ë¦¬ì˜ ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ (ì•ˆì „í•œ ì ‘ê·¼)
  function getCategoryColor(categoryName) {
    if (!categoryName || typeof categoryName !== 'string') {
      return null;
    }
    
    // categoryColors ê°ì²´ê°€ ì•ˆì „í•˜ê²Œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
    if (typeof categoryColors === 'undefined' || categoryColors === null) {
      console.warn('âš ï¸ categoryColors ê°ì²´ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
      categoryColors = {};
      return null;
    }
    
    return categoryColors[categoryName] || null;
  }

  // ì´ë²¤íŠ¸ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ ì´ˆê¸°í™”
  function initializeEventDragAndDrop() {
    console.log('ì´ë²¤íŠ¸ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ ì´ˆê¸°í™”');
    
    var dragStartData = null;
    var dragHelper = null;
    
    // ì´ë²¤íŠ¸ ì•„ì´í…œì— ë“œë˜ê·¸ ê¸°ëŠ¥ ì¶”ê°€
    $(document).on('mousedown', '.project-item .event-content', function(e) {
      // í¸ì§‘ ëª¨ë“œì—ì„œëŠ” ë“œë˜ê·¸ ë¹„í™œì„±í™”
      if ($(this).closest('.project-item').hasClass('editing')) {
        return;
      }
      
      // ì˜¤ë¥¸ìª½ í´ë¦­ ë¬´ì‹œ
      if (e.which !== 1) {
        return;
      }
      
      var eventItem = $(this).closest('.project-item');
      var eventName = eventItem.find('.project-name').text().trim();
      var sourceCategoryIndex = eventItem.data('category-index');
      
      dragStartData = {
        eventItem: eventItem,
        eventName: eventName,
        sourceCategoryIndex: sourceCategoryIndex,
        startX: e.pageX,
        startY: e.pageY,
        isDragging: false
      };
      
      console.log('ë“œë˜ê·¸ ì‹œì‘ ì¤€ë¹„:', dragStartData);
      
      // ì „ì—­ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ì¶”ê°€
      $(document).on('mousemove.eventDrag', handleMouseMove);
      $(document).on('mouseup.eventDrag', handleMouseUp);
      
      e.preventDefault();
    });
    
    function handleMouseMove(e) {
      if (!dragStartData) return;
      
      var deltaX = Math.abs(e.pageX - dragStartData.startX);
      var deltaY = Math.abs(e.pageY - dragStartData.startY);
      
      // ë“œë˜ê·¸ ì‹œì‘ ì„ê³„ê°’ í™•ì¸
      if (!dragStartData.isDragging && (deltaX > 5 || deltaY > 5)) {
        startDrag(e);
      }
      
      if (dragStartData.isDragging) {
        updateDragPosition(e);
        updateDropZones(e);
      }
    }
    
    function handleMouseUp(e) {
      if (dragStartData && dragStartData.isDragging) {
        finishDrag(e);
      }
      
      // ì „ì—­ ì´ë²¤íŠ¸ ì œê±°
      $(document).off('mousemove.eventDrag');
      $(document).off('mouseup.eventDrag');
      
      dragStartData = null;
    }
    
    function startDrag(e) {
      console.log('ë“œë˜ê·¸ ì‹œì‘:', dragStartData.eventName);
      
      dragStartData.isDragging = true;
      dragStartData.eventItem.addClass('dragging');
      
      // ë“œë˜ê·¸ í—¬í¼ ìƒì„±
      dragHelper = $('<div class="project-item drag-helper">' + 
                     '<div class="event-content">' +
                     '<div class="project-name">' + dragStartData.eventName + '</div>' +
                     '</div>' +
                     '</div>');
      
      $('body').append(dragHelper);
      updateDragPosition(e);
      
      // ë“œë¡­ ì¡´ í™œì„±í™”
      // 1. ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ í—¤ë”ë“¤ì„ ë“œë¡­ ì¡´ìœ¼ë¡œ ì„¤ì •
      $('.category-header').not('[data-category-index="' + dragStartData.sourceCategoryIndex + '"]')
                          .addClass('drop-zone');
      
      // 2. ê°™ì€ ì¹´í…Œê³ ë¦¬ ë‚´ì˜ ë‹¤ë¥¸ ì´ë²¤íŠ¸ë“¤ì„ ë“œë¡­ ì¡´ìœ¼ë¡œ ì„¤ì •
      $('.project-item[data-category-index="' + dragStartData.sourceCategoryIndex + '"]')
                          .not(dragStartData.eventItem)
                          .addClass('drop-zone');
    }
    
    function updateDragPosition(e) {
      if (dragHelper) {
        dragHelper.css({
          left: e.pageX + 10,
          top: e.pageY - 10
        });
      }
    }
    
    function updateDropZones(e) {
      // í˜„ì¬ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ì˜ ë“œë¡­ ì¡´ ì°¾ê¸°
      var categoryDropTarget = $(e.target).closest('.category-header.drop-zone');
      var eventDropTarget = $(e.target).closest('.project-item.drop-zone');
      
      // ëª¨ë“  ë“œë¡­ ì¡´ì—ì„œ hover íš¨ê³¼ ì œê±°
      $('.category-header.drop-zone').removeClass('drop-zone-hover');
      $('.project-item.drop-zone').removeClass('drop-zone-hover');
      
      // í˜„ì¬ ìœ„ì¹˜ì˜ ë“œë¡­ ì¡´ì— hover íš¨ê³¼ ì¶”ê°€ ë° í—¬í¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
      if (categoryDropTarget.length > 0) {
        categoryDropTarget.addClass('drop-zone-hover');
        updateDragHelperText('ì¹´í…Œê³ ë¦¬ ì´ë™');
      } else if (eventDropTarget.length > 0) {
        eventDropTarget.addClass('drop-zone-hover');
        updateDragHelperText('ìˆœì„œ ë³€ê²½');
      } else {
        updateDragHelperText('ì´ë™');
      }
    }
    
    function updateDragHelperText(action) {
      if (dragHelper) {
        var helperText = dragHelper.find('.drag-helper-action');
        if (helperText.length === 0) {
          dragHelper.append('<div class="drag-helper-action" style="font-size: 10px; color: #666; margin-top: 2px;"></div>');
          helperText = dragHelper.find('.drag-helper-action');
        }
        helperText.text(action);
      }
    }
    
    function finishDrag(e) {
      console.log('ë“œë˜ê·¸ ì™„ë£Œ');
      
      // ë“œë¡­ íƒ€ê²Ÿ ì°¾ê¸°
      var categoryDropTarget = $(e.target).closest('.category-header.drop-zone');
      var eventDropTarget = $(e.target).closest('.project-item.drop-zone');
      
      if (categoryDropTarget.length > 0) {
        // ì¹´í…Œê³ ë¦¬ í—¤ë”ì— ë“œë¡­ - ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™
        var targetCategoryIndex = categoryDropTarget.data('category-index');
        
        if (targetCategoryIndex != dragStartData.sourceCategoryIndex) {
          try {
            moveEventToCategory(dragStartData.eventItem, dragStartData.sourceCategoryIndex, targetCategoryIndex);
          } catch (error) {
            console.error('ì´ë²¤íŠ¸ ì´ë™ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            alert('ì´ë²¤íŠ¸ ì´ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
          }
        } else {
          console.log('ê°™ì€ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™ ì‹œë„ - ë¬´ì‹œ');
        }
      } else if (eventDropTarget.length > 0) {
        // ì´ë²¤íŠ¸ ì•„ì´í…œì— ë“œë¡­ - ê°™ì€ ì¹´í…Œê³ ë¦¬ ë‚´ ìˆœì„œ ë³€ê²½
        var targetEventCategoryIndex = eventDropTarget.data('category-index');
        
        if (targetEventCategoryIndex == dragStartData.sourceCategoryIndex) {
          try {
            reorderEventInCategory(dragStartData.eventItem, eventDropTarget);
          } catch (error) {
            console.error('ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            alert('ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
          }
        } else {
          console.log('ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ì˜ ì´ë²¤íŠ¸ì— ë“œë¡­ - ë¬´ì‹œ');
        }
      }
      
      // ì •ë¦¬
      cleanup();
    }
    
    function cleanup() {
      if (dragHelper) {
        dragHelper.remove();
        dragHelper = null;
      }
      
      $('.project-item').removeClass('dragging');
      $('.category-header').removeClass('drop-zone drop-zone-hover');
      $('.project-item').removeClass('drop-zone drop-zone-hover');
    }
    
    function moveEventToCategory(eventItem, sourceCategoryIndex, targetCategoryIndex) {
      console.log('ì´ë²¤íŠ¸ ì¹´í…Œê³ ë¦¬ ì´ë™:', sourceCategoryIndex, '->', targetCategoryIndex);
      
      var eventName = eventItem.find('.project-name').text().trim();
      var targetCategoryHeader = $('.category-header[data-category-index="' + targetCategoryIndex + '"]');
      var sourceCategoryHeader = $('.category-header[data-category-index="' + sourceCategoryIndex + '"]');
      
      if (targetCategoryHeader.length === 0) {
        console.error('íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
      
      // ì›ë³¸ ì¹´í…Œê³ ë¦¬ì™€ íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
      var sourceCategoryName = sourceCategoryHeader.find('.category-title').text().trim();
      var targetCategoryName = targetCategoryHeader.find('.category-title').text().trim();
      
      console.log('ì¹´í…Œê³ ë¦¬ ì´ë¦„:', sourceCategoryName, '->', targetCategoryName);
      
      // 1. ì‚¬ì´ë“œë°”ì—ì„œ ì´ë²¤íŠ¸ ì•„ì´í…œ ì´ë™
      var newEventItem = eventItem.clone();
      newEventItem.attr('data-category-index', targetCategoryIndex);
      
      // íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ì˜ ë§ˆì§€ë§‰ ì´ë²¤íŠ¸ ë‹¤ìŒì— ì‚½ì…
      var targetCategoryEvents = $('.project-item[data-category-index="' + targetCategoryIndex + '"]');
      if (targetCategoryEvents.length > 0) {
        targetCategoryEvents.last().after(newEventItem);
      } else {
        targetCategoryHeader.after(newEventItem);
      }
      
      // 2. íƒ€ì„ë¼ì¸ì—ì„œ í•´ë‹¹ ì´ë²¤íŠ¸ì˜ ëª¨ë“  í–‰ ì°¾ê¸°
      var originalTimelineRows = $('.timeline-row[data-category-name="' + sourceCategoryName + '"][data-event-name="' + eventName + '"]');
      console.log('ì´ë™í•  íƒ€ì„ë¼ì¸ í–‰ ê°œìˆ˜:', originalTimelineRows.length);
      
      // 3. íƒ€ì„ë¼ì¸ í–‰ë“¤ì„ ìƒˆë¡œìš´ ìœ„ì¹˜ë¡œ ì´ë™
      if (originalTimelineRows.length > 0) {
        // íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ì—ì„œ ì´ë²¤íŠ¸ ì‚½ì… ìœ„ì¹˜ ì°¾ê¸°
        var insertPosition = findTimelineInsertPosition(targetCategoryIndex, eventName);
        
        // ê° í–‰ì„ ìƒˆë¡œìš´ ìœ„ì¹˜ë¡œ ì´ë™í•˜ê³  ë°ì´í„° ì†ì„± ì—…ë°ì´íŠ¸
        originalTimelineRows.each(function() {
          var $row = $(this);
          $row.attr('data-category-name', targetCategoryName);
          
          // í–‰ì„ ìƒˆë¡œìš´ ìœ„ì¹˜ë¡œ ì´ë™
          if (insertPosition && insertPosition.length > 0) {
            $row.detach().insertAfter(insertPosition);
            insertPosition = $row; // ë‹¤ìŒ í–‰ì€ í˜„ì¬ í–‰ ë‹¤ìŒì— ì‚½ì…
          } else {
            // ì‚½ì… ìœ„ì¹˜ë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš° íƒ€ì„ë¼ì¸ ëì— ì¶”ê°€
            $row.detach().appendTo('.timeline-body');
          }
        });
      }
      
      // 4. ì›ë³¸ ì´ë²¤íŠ¸ ì•„ì´í…œ ì œê±°
      eventItem.remove();
      
      // 5. í”„ë¡œì íŠ¸ ë°” ë“œë˜ê·¸ ê¸°ëŠ¥ ì¬ì´ˆê¸°í™”
      initializeProjectBarDraggable();
      
      // 6. ë¼ì¸ ë†’ì´ ì—…ë°ì´íŠ¸
      updateLineHeight();
      
      console.log('ì´ë²¤íŠ¸ ì´ë™ ì™„ë£Œ:', eventName);
    }
    
    // ê°™ì€ ì¹´í…Œê³ ë¦¬ ë‚´ì—ì„œ ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½
    function reorderEventInCategory(sourceEventItem, targetEventItem) {
      console.log('ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½ ì‹œì‘');
      
      var sourceEventName = sourceEventItem.find('.project-name').text().trim();
      var targetEventName = targetEventItem.find('.project-name').text().trim();
      var categoryIndex = sourceEventItem.data('category-index');
      var categoryName = $('.category-header[data-category-index="' + categoryIndex + '"]')
                         .find('.category-title').text().trim();
      
      console.log('ìˆœì„œ ë³€ê²½:', sourceEventName, '->', targetEventName, '(ì¹´í…Œê³ ë¦¬:', categoryName + ')');
      
      // 1. ì‚¬ì´ë“œë°”ì—ì„œ ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½
      var sourceIndex = sourceEventItem.index();
      var targetIndex = targetEventItem.index();
      
      console.log('ì‚¬ì´ë“œë°” ì¸ë±ìŠ¤:', sourceIndex, '->', targetIndex);
      
      if (sourceIndex < targetIndex) {
        // ì•„ë˜ìª½ìœ¼ë¡œ ì´ë™ - íƒ€ê²Ÿ ìš”ì†Œ ë‹¤ìŒì— ì‚½ì…
        sourceEventItem.detach().insertAfter(targetEventItem);
      } else {
        // ìœ„ìª½ìœ¼ë¡œ ì´ë™ - íƒ€ê²Ÿ ìš”ì†Œ ì´ì „ì— ì‚½ì…
        sourceEventItem.detach().insertBefore(targetEventItem);
      }
      
      // 2. íƒ€ì„ë¼ì¸ì—ì„œ í•´ë‹¹ ì´ë²¤íŠ¸ì˜ ëª¨ë“  í–‰ ì°¾ê¸°
      var sourceTimelineRows = $('.timeline-row[data-category-name="' + categoryName + '"][data-event-name="' + sourceEventName + '"]');
      var targetTimelineRows = $('.timeline-row[data-category-name="' + categoryName + '"][data-event-name="' + targetEventName + '"]');
      
      console.log('íƒ€ì„ë¼ì¸ í–‰ ê°œìˆ˜ - ì†ŒìŠ¤:', sourceTimelineRows.length, 'íƒ€ê²Ÿ:', targetTimelineRows.length);
      
      // 3. íƒ€ì„ë¼ì¸ì—ì„œ ì´ë²¤íŠ¸ í–‰ ìˆœì„œ ë³€ê²½
      if (sourceTimelineRows.length > 0 && targetTimelineRows.length > 0) {
        var targetLastRow = targetTimelineRows.last();
        var targetFirstRow = targetTimelineRows.first();
        
        if (sourceIndex < targetIndex) {
          // ì•„ë˜ìª½ìœ¼ë¡œ ì´ë™ - íƒ€ê²Ÿ ì´ë²¤íŠ¸ì˜ ë§ˆì§€ë§‰ í–‰ ë‹¤ìŒì— ì‚½ì…
          sourceTimelineRows.each(function() {
            $(this).detach().insertAfter(targetLastRow);
            targetLastRow = $(this); // ë‹¤ìŒ í–‰ì€ í˜„ì¬ í–‰ ë‹¤ìŒì— ì‚½ì…
          });
        } else {
          // ìœ„ìª½ìœ¼ë¡œ ì´ë™ - íƒ€ê²Ÿ ì´ë²¤íŠ¸ì˜ ì²« ë²ˆì§¸ í–‰ ì´ì „ì— ì‚½ì…
          sourceTimelineRows.get().reverse().forEach(function(row) {
            $(row).detach().insertBefore(targetFirstRow);
          });
        }
      }
      
      // 4. ë¼ì¸ ë†’ì´ ì—…ë°ì´íŠ¸
      updateLineHeight();
      
      console.log('ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½ ì™„ë£Œ:', sourceEventName);
    }
    
    // íƒ€ì„ë¼ì¸ì—ì„œ ìƒˆ ì´ë²¤íŠ¸ í–‰ì˜ ì‚½ì… ìœ„ì¹˜ë¥¼ ì°¾ëŠ” í•¨ìˆ˜
    function findTimelineInsertPosition(categoryIndex, eventName) {
      var categoryName = $('.category-header[data-category-index="' + categoryIndex + '"]')
                         .find('.category-title').text().trim();
      
      console.log('íƒ€ì„ë¼ì¸ ì‚½ì… ìœ„ì¹˜ ì°¾ê¸°:', categoryName, eventName);
      
      // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ê¸°ì¡´ íƒ€ì„ë¼ì¸ í–‰ë“¤ ì°¾ê¸°
      var categoryTimelineRows = $('.timeline-row[data-category-name="' + categoryName + '"]');
      console.log('ê¸°ì¡´ ì¹´í…Œê³ ë¦¬ íƒ€ì„ë¼ì¸ í–‰ ê°œìˆ˜:', categoryTimelineRows.length);
      
      if (categoryTimelineRows.length > 0) {
        return categoryTimelineRows.last();
      }
      
      // ì¹´í…Œê³ ë¦¬ í–‰ì´ ì—†ëŠ” ê²½ìš°, ì‚¬ì´ë“œë°” ìˆœì„œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‚½ì… ìœ„ì¹˜ ì°¾ê¸°
      var allTimelineRows = $('.timeline-row');
      var sidebarElements = $('.roadmap-sidebar').children().not('.sidebar-header');
      
      // íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ì˜ ì‚¬ì´ë“œë°” ìœ„ì¹˜ ì°¾ê¸°
      var targetCategoryPosition = -1;
      sidebarElements.each(function(index) {
        if ($(this).hasClass('category-header') && 
            $(this).data('category-index') == categoryIndex) {
          targetCategoryPosition = index;
          return false; // break
        }
      });
      
      console.log('íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ ìœ„ì¹˜:', targetCategoryPosition);
      
      if (targetCategoryPosition >= 0) {
        // íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ ì´ì „ ìš”ì†Œë“¤ ì¤‘ì—ì„œ ë§ˆì§€ë§‰ íƒ€ì„ë¼ì¸ í–‰ ì°¾ê¸°
        var insertAfterRow = null;
        var timelineIndex = 0;
        
        for (var i = 0; i < targetCategoryPosition; i++) {
          var sidebarElement = sidebarElements.eq(i);
          if (sidebarElement.hasClass('category-header') || sidebarElement.hasClass('project-item')) {
            if (timelineIndex < allTimelineRows.length) {
              insertAfterRow = allTimelineRows.eq(timelineIndex);
              timelineIndex++;
            }
          }
        }
        
        console.log('ì‚½ì… ìœ„ì¹˜ (ì´ì „ í–‰):', insertAfterRow ? insertAfterRow.index() : 'none');
        return insertAfterRow;
      }
      
      // ë§ˆì§€ë§‰ ìˆ˜ë‹¨ìœ¼ë¡œ íƒ€ì„ë¼ì¸ ëì— ì‚½ì…
      console.log('ë§ˆì§€ë§‰ ìˆ˜ë‹¨: íƒ€ì„ë¼ì¸ ëì— ì‚½ì…');
      return allTimelineRows.last();
    }
  }

  // ì¹´í…Œê³ ë¦¬ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ ì´ˆê¸°í™”
  function initializeCategoryDragAndDrop() {
    console.log('ì¹´í…Œê³ ë¦¬ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ ì´ˆê¸°í™”');
    
    var categoryDragData = null;
    var categoryDragHelper = null;
    
    // ì¹´í…Œê³ ë¦¬ í—¤ë”ì— ë“œë˜ê·¸ ê¸°ëŠ¥ ì¶”ê°€
    $(document).on('mousedown', '.category-header .category-title', function(e) {
      // í¸ì§‘ ëª¨ë“œì—ì„œëŠ” ë“œë˜ê·¸ ë¹„í™œì„±í™”
      if ($(this).closest('.category-header').hasClass('editing')) {
        return;
      }
      
      // ì˜¤ë¥¸ìª½ í´ë¦­ ë¬´ì‹œ
      if (e.which !== 1) {
        return;
      }
      
      var categoryHeader = $(this).closest('.category-header');
      var categoryName = $(this).text().trim();
      var categoryIndex = categoryHeader.data('category-index');
      
      categoryDragData = {
        categoryHeader: categoryHeader,
        categoryName: categoryName,
        categoryIndex: categoryIndex,
        startX: e.pageX,
        startY: e.pageY,
        isDragging: false
      };
      
      console.log('ì¹´í…Œê³ ë¦¬ ë“œë˜ê·¸ ì‹œì‘ ì¤€ë¹„:', categoryDragData);
      
      // ì „ì—­ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ì¶”ê°€
      $(document).on('mousemove.categoryDrag', handleCategoryMouseMove);
      $(document).on('mouseup.categoryDrag', handleCategoryMouseUp);
      
      e.preventDefault();
    });
    
    function handleCategoryMouseMove(e) {
      if (!categoryDragData) return;
      
      var deltaX = Math.abs(e.pageX - categoryDragData.startX);
      var deltaY = Math.abs(e.pageY - categoryDragData.startY);
      
      // ë“œë˜ê·¸ ì‹œì‘ ì„ê³„ê°’ í™•ì¸
      if (!categoryDragData.isDragging && (deltaX > 5 || deltaY > 5)) {
        startCategoryDrag(e);
      }
      
      if (categoryDragData.isDragging) {
        updateCategoryDragPosition(e);
        updateCategoryDropZones(e);
      }
    }
    
    function handleCategoryMouseUp(e) {
      if (categoryDragData && categoryDragData.isDragging) {
        finishCategoryDrag(e);
      }
      
      // ì „ì—­ ì´ë²¤íŠ¸ ì œê±°
      $(document).off('mousemove.categoryDrag');
      $(document).off('mouseup.categoryDrag');
      
      categoryDragData = null;
    }
    
    function startCategoryDrag(e) {
      console.log('ì¹´í…Œê³ ë¦¬ ë“œë˜ê·¸ ì‹œì‘:', categoryDragData.categoryName);
      
      categoryDragData.isDragging = true;
      categoryDragData.categoryHeader.addClass('dragging');
      
      // ë“œë˜ê·¸ í—¬í¼ ìƒì„±
      categoryDragHelper = $('<div class="category-header drag-helper">' + 
                            '<div class="category-left">' +
                            '<span class="category-title">' + categoryDragData.categoryName + '</span>' +
                            '</div>' +
                            '</div>');
      
      $('body').append(categoryDragHelper);
      updateCategoryDragPosition(e);
      
      // ë“œë¡­ ì¡´ í™œì„±í™” - ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ë“¤ì„ ë“œë¡­ ì¡´ìœ¼ë¡œ ì„¤ì •
      $('.category-header').not(categoryDragData.categoryHeader).addClass('category-drop-zone');
    }
    
    function updateCategoryDragPosition(e) {
      if (categoryDragHelper) {
        categoryDragHelper.css({
          left: e.pageX + 10,
          top: e.pageY - 10
        });
      }
    }
    
    function updateCategoryDropZones(e) {
      // í˜„ì¬ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ì˜ ë“œë¡­ ì¡´ ì°¾ê¸°
      var dropTarget = $(e.target).closest('.category-header.category-drop-zone');
      
      // ëª¨ë“  ë“œë¡­ ì¡´ì—ì„œ hover íš¨ê³¼ ì œê±°
      $('.category-header.category-drop-zone').removeClass('category-drop-zone-hover');
      
      // í˜„ì¬ ìœ„ì¹˜ì˜ ë“œë¡­ ì¡´ì— hover íš¨ê³¼ ì¶”ê°€
      if (dropTarget.length > 0) {
        dropTarget.addClass('category-drop-zone-hover');
        
        // ë“œë¡­ ìœ„ì¹˜ í‘œì‹œ (ìœ„/ì•„ë˜)
        var dropY = e.pageY - dropTarget.offset().top;
        var dropHeight = dropTarget.outerHeight();
        
        if (dropY < dropHeight / 2) {
          dropTarget.removeClass('drop-after').addClass('drop-before');
        } else {
          dropTarget.removeClass('drop-before').addClass('drop-after');
        }
      }
    }
    
    function finishCategoryDrag(e) {
      console.log('ì¹´í…Œê³ ë¦¬ ë“œë˜ê·¸ ì™„ë£Œ');
      
      // ë“œë¡­ íƒ€ê²Ÿ ì°¾ê¸°
      var dropTarget = $(e.target).closest('.category-header.category-drop-zone');
      
      if (dropTarget.length > 0) {
        var targetIndex = dropTarget.data('category-index');
        
        // ë“œë¡­ ìœ„ì¹˜ í™•ì¸ (ìœ„/ì•„ë˜)
        var dropY = e.pageY - dropTarget.offset().top;
        var dropHeight = dropTarget.outerHeight();
        var insertBefore = dropY < dropHeight / 2;
        
        try {
          reorderCategory(categoryDragData.categoryHeader, dropTarget, insertBefore);
        } catch (error) {
          console.error('ì¹´í…Œê³ ë¦¬ ìˆœì„œ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
          alert('ì¹´í…Œê³ ë¦¬ ìˆœì„œ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        }
      }
      
      // ì •ë¦¬
      cleanupCategoryDrag();
    }
    
    function cleanupCategoryDrag() {
      if (categoryDragHelper) {
        categoryDragHelper.remove();
        categoryDragHelper = null;
      }
      
      $('.category-header').removeClass('dragging category-drop-zone category-drop-zone-hover drop-before drop-after');
    }
    
    // ì¹´í…Œê³ ë¦¬ ìˆœì„œ ë³€ê²½ í•¨ìˆ˜
    function reorderCategory(sourceCategory, targetCategory, insertBefore) {
      console.log('ì¹´í…Œê³ ë¦¬ ìˆœì„œ ë³€ê²½ ì‹œì‘');
      
      var sourceName = sourceCategory.find('.category-title').text().trim();
      var targetName = targetCategory.find('.category-title').text().trim();
      var sourceIndex = sourceCategory.data('category-index');
      var targetIndex = targetCategory.data('category-index');
      
      console.log('ìˆœì„œ ë³€ê²½:', sourceName, 'â†’', targetName, '(ì‚½ì… ìœ„ì¹˜:', insertBefore ? 'ìœ„' : 'ì•„ë˜', ')');
      
      // 1. ì‚¬ì´ë“œë°”ì—ì„œ ì¹´í…Œê³ ë¦¬ì™€ í•´ë‹¹ ì´ë²¤íŠ¸ë“¤ ì´ë™
      var sourceEvents = $('.project-item[data-category-index="' + sourceIndex + '"]');
      console.log('ì´ë™í•  ì´ë²¤íŠ¸ ìˆ˜:', sourceEvents.length);
      
      // ì¹´í…Œê³ ë¦¬ì™€ ì´ë²¤íŠ¸ë“¤ì„ í•œ ë²ˆì— ì´ë™
      var elementsToMove = sourceCategory.add(sourceEvents);
      
      if (insertBefore) {
        elementsToMove.detach().insertBefore(targetCategory);
      } else {
        // íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ì˜ ë§ˆì§€ë§‰ ì´ë²¤íŠ¸ ì°¾ê¸°
        var targetEvents = $('.project-item[data-category-index="' + targetIndex + '"]');
        if (targetEvents.length > 0) {
          elementsToMove.detach().insertAfter(targetEvents.last());
        } else {
          elementsToMove.detach().insertAfter(targetCategory);
        }
      }
      
      // 2. íƒ€ì„ë¼ì¸ì—ì„œ ì¹´í…Œê³ ë¦¬ í–‰ê³¼ ì´ë²¤íŠ¸ í–‰ë“¤ ì´ë™
      reorderTimelineForCategory(sourceName, targetName, insertBefore);
      
      // 3. ë¼ì¸ ë†’ì´ ì—…ë°ì´íŠ¸
      setTimeout(function() {
        updateLineHeight();
      }, 50);
      
      console.log('ì¹´í…Œê³ ë¦¬ ìˆœì„œ ë³€ê²½ ì™„ë£Œ');
    }
    
    // íƒ€ì„ë¼ì¸ì—ì„œ ì¹´í…Œê³ ë¦¬ ìˆœì„œ ë³€ê²½
    function reorderTimelineForCategory(sourceCategoryName, targetCategoryName, insertBefore) {
      console.log('íƒ€ì„ë¼ì¸ ì¹´í…Œê³ ë¦¬ ìˆœì„œ ë³€ê²½:', sourceCategoryName, 'â†’', targetCategoryName);
      
      // ì†ŒìŠ¤ ì¹´í…Œê³ ë¦¬ì˜ ëª¨ë“  í–‰ ì°¾ê¸° (ì¹´í…Œê³ ë¦¬ í–‰ + ì´ë²¤íŠ¸ í–‰ë“¤)
      var sourceRows = [];
      var foundSourceCategory = false;
      var foundTargetCategory = false;
      var targetCategoryRow = null;
      var lastTargetEventRow = null;
      
      $('.timeline-row').each(function() {
        var $row = $(this);
        
        // ì¹´í…Œê³ ë¦¬ í–‰ì¸ì§€ í™•ì¸
        if ($row.hasClass('category-row')) {
          // ì†ŒìŠ¤ ì¹´í…Œê³ ë¦¬ ì°¾ê¸°
          if (!foundSourceCategory) {
            var categoryIndex = $('.category-header').index($('.category-header:contains("' + sourceCategoryName + '")'));
            var rowIndex = $('.timeline-row.category-row').index($row);
            
            if (categoryIndex === rowIndex) {
              foundSourceCategory = true;
              sourceRows.push($row);
            }
          }
          
          // íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ ì°¾ê¸°
          if (!foundTargetCategory && !targetCategoryRow) {
            var targetCategoryIndex = $('.category-header').index($('.category-header:contains("' + targetCategoryName + '")'));
            var targetRowIndex = $('.timeline-row.category-row').index($row);
            
            if (targetCategoryIndex === targetRowIndex) {
              foundTargetCategory = true;
              targetCategoryRow = $row;
            }
          }
        }
        // ì†ŒìŠ¤ ì¹´í…Œê³ ë¦¬ì˜ ì´ë²¤íŠ¸ í–‰ ìˆ˜ì§‘
        else if (foundSourceCategory && $row.attr('data-category-name') === sourceCategoryName) {
          sourceRows.push($row);
        }
        // íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ì˜ ë§ˆì§€ë§‰ ì´ë²¤íŠ¸ í–‰ ì°¾ê¸°
        else if (foundTargetCategory && $row.attr('data-category-name') === targetCategoryName) {
          lastTargetEventRow = $row;
        }
        // ë‹¤ìŒ ì¹´í…Œê³ ë¦¬ë¥¼ ë§Œë‚˜ë©´ ì†ŒìŠ¤ ì¹´í…Œê³ ë¦¬ ìˆ˜ì§‘ ì¢…ë£Œ
        else if (foundSourceCategory && $row.hasClass('category-row')) {
          foundSourceCategory = false;
        }
      });
      
      console.log('ì´ë™í•  í–‰ ìˆ˜:', sourceRows.length);
      
      // í–‰ë“¤ ì´ë™
      if (sourceRows.length > 0 && targetCategoryRow) {
        if (insertBefore) {
          // íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ ìœ„ì— ì‚½ì…
          sourceRows.forEach(function(row) {
            $(row).detach().insertBefore(targetCategoryRow);
          });
        } else {
          // íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ì˜ ë§ˆì§€ë§‰ ì´ë²¤íŠ¸ ë‹¤ìŒì— ì‚½ì…
          var insertAfter = lastTargetEventRow || targetCategoryRow;
          sourceRows.forEach(function(row) {
            $(row).detach().insertAfter(insertAfter);
            insertAfter = $(row);
          });
        }
      }
      
      console.log('íƒ€ì„ë¼ì¸ ì¹´í…Œê³ ë¦¬ ìˆœì„œ ë³€ê²½ ì™„ë£Œ');
    }
  }


});
</script>
