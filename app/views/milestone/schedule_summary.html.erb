<%= render 'milestone/header' %>

<% content_for :header_tags do %>
  <!-- ExcelJS ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
  
  <!-- TX XLSX Exporter (ê³µìš© ì—‘ì…€ ìµìŠ¤í¬í„°) -->
  <%= javascript_include_tag 'tx_xlsx_exporter', plugin: 'redmine_tx_0_base' %>
  
  <!-- TX Timeline Grid (ì›¹ íƒ€ì„ë¼ì¸ ë Œë”ëŸ¬) -->
  <%= javascript_include_tag 'tx_timeline_grid', plugin: 'redmine_tx_0_base' %>
  <%= stylesheet_link_tag 'tx_timeline_grid', plugin: 'redmine_tx_0_base' %>
  
  <!-- TX Issue Autocomplete (ì¼ê° ìë™ì™„ì„±) -->
  <%= javascript_include_tag 'tx_issue_autocomplete', plugin: 'redmine_tx_0_base' %>
  
  <style>
    .schedule-summary-form {
      background: #f9f9f9;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .schedule-summary-form label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .schedule-summary-form .form-group {
      margin-bottom: 15px;
    }
    .schedule-summary-form textarea {
      width: 100%;
      max-width: 600px;
      height: 60px;
      font-family: monospace;
    }
    .schedule-summary-form select[multiple] {
      width: 100%;
      max-width: 300px;
      height: 150px;
    }
    .schedule-summary-form .hint {
      color: #888;
      font-size: 0.9em;
      margin-top: 3px;
    }
    .schedule-summary-result {
      margin-top: 20px;
    }
    .schedule-summary-result h3 {
      background: #628db6;
      color: white;
      padding: 8px 12px;
      margin: 15px 0 10px 0;
      border-radius: 3px;
    }
    .schedule-summary-result .user-schedule {
      margin-left: 15px;
      padding: 5px 0;
      border-bottom: 1px dotted #ddd;
    }
    .schedule-summary-result .user-schedule:last-child {
      border-bottom: none;
    }
    .schedule-summary-result .user-name {
      font-weight: bold;
      color: #333;
      min-width: 80px;
      display: inline-block;
    }
    .schedule-summary-result .issue-link {
      margin-right: 8px;
    }
    .schedule-summary-result .issue-dates {
      color: #666;
      font-size: 0.9em;
    }
    .no-result {
      color: #888;
      font-style: italic;
      padding: 20px;
      text-align: center;
    }
    .color-legend {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px 15px;
      margin: 15px 0;
    }
    .color-legend h4 {
      margin: 0 0 10px 0;
      font-size: 0.95em;
      color: #555;
    }
    .legend-item {
      display: inline-block;
      margin: 5px 10px 5px 0;
      padding: 4px 10px;
      border-radius: 3px;
      font-size: 0.9em;
      color: white;
      font-weight: bold;
    }
    .legend-item a {
      color: white;
      text-decoration: none;
    }
    .legend-item a:hover {
      text-decoration: underline;
    }
    .issue-color-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 2px;
      margin-right: 3px;
      vertical-align: middle;
      border: 1px solid rgba(0,0,0,0.2);
    }
    /* XLSX ë²„íŠ¼ ì»¤ì„œ í¬ì¸í„° */
    #export-xlsx-btn {
      cursor: pointer;
    }
  </style>
<% end %>

<% html_title("ì¼ì •ìš”ì•½") %>

<%
# íŒ€(ê·¸ë£¹) ëª©ë¡ ë¡œë“œ
excluded_group_ids = TxBaseHelper.config_arr('e_group') || []
all_groups = Group.all.reject { |group| excluded_group_ids.include?(group.id) }
%>

<% if params[:issue_ids].present? %>
  <%
  # í‘œê¸° ì‹œì‘ì¼ íŒŒì‹±
  default_display_start_date = 6.months.ago.to_date
  display_start_date = params[:display_start_date].present? ? Date.parse(params[:display_start_date]) : default_display_start_date
  
  # ì¼ê° ID íŒŒì‹± (ì‰¼í‘œ, ì„¸ë¯¸ì½œë¡ , ê³µë°±ìœ¼ë¡œ ë¶„ë¦¬)
  input_issue_ids = params[:issue_ids].to_s.split(/[,;\s]+/).map(&:strip).reject(&:empty?).map(&:to_i).uniq
  
  # ì…ë ¥ëœ ì¼ê°ë“¤ê³¼ ì—°ê´€ëœ ì¼ê°ë“¤ ì¡°íšŒ
  input_issues = Issue.where(id: input_issue_ids)
  parent_issues = input_issues.map(&:root).uniq

  # ë²„ì „ë³„ ë§ˆì»¤ ìˆ˜ì§‘
  versions = parent_issues.map(&:fixed_version).uniq.select { |v| v.effective_date.present? }.sort_by(&:effective_date)
  version_markers = []
  versions.each do |version|
    version.marks.each do |mark|
      version_markers << { date: mark[:date], name: mark[:name], color: '#9999ff', side: 'right' }
    end
    version_markers << { date: version.effective_date, name: version.name, color: '#5555cc', side: 'right' }
  end

  # ë©”ì¸ ì¼ê°ë³„ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì •ì˜
  color_palette = [
    '#98E5B0', '#FFD280', '#C897CE', '#8FC5F0', '#FFB0B0', 
    '#70D8BE', '#F09897', '#8FBFEA', '#F9CC85', '#78D9A8',
    '#F9C980', '#B880C3', '#6BC2B0', '#E08080', '#70D095'
  ]
  
  # ë©”ì¸ ì¼ê°(ì…ë ¥ëœ ì¼ê°)ë§ˆë‹¤ ìƒ‰ìƒ í• ë‹¹
  main_issue_colors = {}
  parent_issues.each_with_index do |issue, idx|
    main_issue_colors[issue.id] = color_palette[idx % color_palette.length]
  end
  
  # ê° ì¼ê°ì´ ì–´ë–¤ ë©”ì¸ ì¼ê°ì— ì†í•˜ëŠ”ì§€ ë§¤í•‘ (ì¼ê° ID -> ë©”ì¸ ì¼ê° ID)
  issue_to_main_issue = {}
  parent_issues.each do |main_issue|
    # ë©”ì¸ ì¼ê° ìì‹ 
    issue_to_main_issue[main_issue.id] = main_issue.id
    # í•˜ìœ„ ì¼ê°ë“¤
    main_issue.descendants.each do |descendant|
      issue_to_main_issue[descendant.id] = main_issue.id
    end
  end
  
  # ëª¨ë“  í•˜ìœ„ ì¼ê° í¬í•¨ (descendants)
  all_issue_ids = Set.new(input_issue_ids)
  parent_issues.each do |issue|
    all_issue_ids.merge(issue.descendants.pluck(:id))
  end
  
  # ì „ì²´ ì¼ê° ì¡°íšŒ
  all_issues = Issue.where(id: all_issue_ids.to_a)
  
  # ì‹œì‘ì¼ê³¼ ì™„ë£Œì¼ì´ ëª¨ë‘ ìˆëŠ” ì¼ê°ë§Œ í•„í„°ë§
  filtered_issues = all_issues.where.not(start_date: nil)
                              .where.not(due_date: nil)

  # í‘œê¸° ì‹œì‘ì¼ ì´ì „ì— ì‹œì‘í•˜ê³  ì¢…ë£Œë˜ëŠ” ì¼ê° ì œì™¸
  # startDateì™€ endDateê°€ ëª¨ë‘ í‘œê¸° ì‹œì‘ì¼ë³´ë‹¤ ë¹ ë¥¸ ê²½ìš° ì œì™¸
  filtered_issues = filtered_issues.where(
    "start_date >= ? OR due_date >= ?", 
    display_start_date, 
    display_start_date
  )

  # íê¸°ëœ ì¼ê° ì œê±°
  filtered_issues = filtered_issues.where.not(status_id: IssueStatus.discarded_ids)

  # ì‹¤ì œ êµ¬í˜„ ì¼ê°ë§Œ ì·¨í•©
  excluded_tracker_ids = ( Tracker.bug_trackers_ids + 
                         Tracker.sidejob_trackers_ids + 
                         Tracker.exception_trackers_ids + 
                         Tracker.roadmap_trackers_ids ).uniq

  filtered_issues = filtered_issues.where.not(tracker_id: excluded_tracker_ids)

  # ê³µíœ´ì¼ ë°ì´í„° ìˆ˜ì§‘ (íƒ€ì„ë¼ì¸ í‘œì‹œ ë²”ìœ„)
  # íƒ€ì„ë¼ì¸ ì‹œì‘ì¼: display_start_date, ì¢…ë£Œì¼: í•„í„°ë§ëœ ì¼ê°ë“¤ì˜ ìµœëŒ€ ì™„ë£Œì¼ + ì—¬ìœ (60ì¼)
  timeline_start_date = display_start_date
  max_due_date = filtered_issues.maximum(:due_date) || Date.today
  timeline_end_date = max_due_date + 60.days

  # ê³µíœ´ì¼ ì¡°íšŒ
  # for_date_rangeëŠ” Hashë¥¼ ë°˜í™˜í•˜ê³ , selectëŠ” [[date, name], ...] í˜•íƒœì˜ ë°°ì—´ì„ ë°˜í™˜
  holidays = if TxBaseHelper::HolidayApi.available?
    holiday_data = TxBaseHelper::HolidayApi.for_date_range(timeline_start_date, timeline_end_date)
    # holiday_dataëŠ” [[date, name], ...] í˜•íƒœì˜ ë°°ì—´
    holiday_data.map { |date, name| date.strftime('%Y-%m-%d') }
  else
    []
  end

  # ì „ì²´ ì¼ê°ì—ë„ ë™ì¼í•œ tracker í•„í„° ì ìš© (ë°°ì œëœ ì¼ê° ê³„ì‚°ì— ì‚¬ìš©)
  filtered_all_issues = all_issues.where.not(tracker_id: excluded_tracker_ids)
                                  .where.not(status_id: IssueStatus.discarded_ids)
  
  # ì„ íƒëœ ê·¸ë£¹ í•„í„°
  selected_group_ids = params[:group_ids]&.map(&:to_i)&.reject { |id| id == 0 } || []
  
  # ê·¸ë£¹ ì •ë³´ ë¡œë“œ
  if selected_group_ids.any?
    groups_to_show = Group.where(id: selected_group_ids)
  else
    groups_to_show = all_groups
  end
  
  # ì‚¬ìš©ìë³„ ì¼ê° ê·¸ë£¹í•‘ (ë‹´ë‹¹ìê°€ ìˆê³  ì¼ì •ì´ ìˆëŠ” ê²ƒë§Œ)
  issues_by_user = filtered_issues.where.not(assigned_to_id: nil).group_by(&:assigned_to_id)
  
  # ì‚¬ìš©ì ì •ë³´ ë¯¸ë¦¬ ë¡œë“œ
  user_ids = issues_by_user.keys.compact
  users = User.where(id: user_ids).index_by(&:id)
  
  # ê·¸ë£¹ë³„ ì‚¬ìš©ì ë§¤í•‘
  group_user_mapping = {}
  groups_to_show.each do |group|
    group_user_mapping[group] = group.users.pluck(:id)
  end
  
  # ê²°ê³¼ ë°ì´í„° êµ¬ì„±: ê·¸ë£¹ -> ì‚¬ìš©ì -> ì¼ê°ë“¤
  result_data = {}
  registered_user_ids = Set.new  # ì´ë¯¸ ë“±ë¡ëœ ì‚¬ìš©ì ID ì¶”ì 
  
  groups_to_show.each do |group|
    group_users_issues = {}
    group_user_ids = group_user_mapping[group]
    
    group_user_ids.each do |user_id|
      next if registered_user_ids.include?(user_id)  # ì´ë¯¸ ë“±ë¡ëœ ì‚¬ìš©ìëŠ” skip
      next unless issues_by_user[user_id]
      user = users[user_id]
      next unless user
      
      user_issues = issues_by_user[user_id].sort_by(&:start_date)
      if user_issues.any?
        group_users_issues[user] = user_issues
        registered_user_ids.add(user_id)  # ë“±ë¡ëœ ì‚¬ìš©ì ID ê¸°ë¡
      end
    end
    
    result_data[group] = group_users_issues if group_users_issues.any?
  end
  
  # ê° ì‚¬ìš©ìë³„ ë‹¤ë¥¸ ë¯¸ì™„ë£Œ ì¼ê° ì¡°íšŒ (ë°°ê²½ í‘œì‹œìš©)
  # í˜„ì¬ í‘œì‹œëœ ì¼ê° ID ì§‘í•©
  displayed_issue_ids = filtered_issues.where.not(assigned_to_id: nil).pluck(:id).to_set
  
  # ë¯¸ì™„ë£Œ ìƒíƒœ ID ì¡°íšŒ (is_closedê°€ falseì¸ ìƒíƒœ)
  open_status_ids = IssueStatus.where(is_closed: false).pluck(:id)
  
  # ì‚¬ìš©ìë³„ ë‹¤ë¥¸ ë¯¸ì™„ë£Œ ì¼ê° (ë°°ê²½ ì¼ì •)
  background_issues_by_user = {}
  user_ids.each do |user_id|
    # í•´ë‹¹ ì‚¬ìš©ìì˜ ë¯¸ì™„ë£Œ ì¼ê° ì¤‘ í‘œì‹œ ë²”ìœ„ ë‚´ì— ìˆëŠ” ê²ƒ
    other_issues = Issue.where(assigned_to_id: user_id)
                        #.where(status_id: open_status_ids)
                        .where.not(id: displayed_issue_ids.to_a)
                        .where.not(start_date: nil)
                        .where.not(due_date: nil)
                        .where.not(tracker_id: excluded_tracker_ids)
                        .where("start_date >= ? OR due_date >= ?", display_start_date, display_start_date)
    
    background_issues_by_user[user_id] = other_issues.to_a if other_issues.any?
  end
  
  # ë°°ì œëœ ì¼ê°ë“¤ ë¶„ë¥˜
  # 1. ë¯¸ë°°ì • ì¼ê° (ë‹´ë‹¹ì ì—†ìŒ)
  unassigned_issues = filtered_all_issues.where(assigned_to_id: nil)
  
  # 2. ì¼ì • ë¯¸ê¸°ì… ì¼ê° (ë‹´ë‹¹ìëŠ” ìˆì§€ë§Œ ì‹œì‘ì¼ ë˜ëŠ” ì™„ë£Œì¼ ì—†ìŒ)
  missing_schedule_issues = filtered_all_issues.where.not(assigned_to_id: nil)
                                               .where('start_date IS NULL OR due_date IS NULL')
  %>
  
  <div class="schedule-summary-result">
    <h2>ìš”ì•½ ê²°ê³¼</h2>
    
    <%# 'ë©”ì¸ ì¼ê°ë³„ ìƒ‰ìƒ'ì€ íƒ€ì„ë¼ì¸ ê·¸ë¦¬ë“œì˜ ë²”ë¡€(jsonData.legends)ì™€ ì¤‘ë³µë˜ë¯€ë¡œ í‘œê¸°í•˜ì§€ ì•ŠìŒ %>
    
    <p>
      ì…ë ¥ëœ ì¼ê°: <strong><%= input_issue_ids.size %>ê°œ</strong> | 
      ì „ì²´ ì¼ê° (í•˜ìœ„ í¬í•¨, ì‹¤ì œ êµ¬í˜„ ì¼ê°ë§Œ): <strong><%= filtered_all_issues.size %>ê°œ</strong> | 
      ìš”ì•½ëœ ì¼ê° (ë‹´ë‹¹ì/ì¼ì • ìˆìŒ): <strong><%= filtered_issues.where.not(assigned_to_id: nil).size %>ê°œ</strong>
    </p>
    
    <% if result_data.any? %>
      <!-- íƒ€ì„ë¼ì¸ ê·¸ë¦¬ë“œ -->
      <div id="timeline-grid-container" style="margin: 20px 0;"></div>
    <% else %>
      <div class="no-result">
        ì„ íƒí•œ ì¡°ê±´ì— ë§ëŠ” ì¼ê°ì´ ì—†ìŠµë‹ˆë‹¤.
      </div>
    <% end %>
    
    <% if unassigned_issues.any? || missing_schedule_issues.any? %>
      <hr style="margin: 30px 0; border: none; border-top: 2px solid #ddd;">
      <h3 style="color: #ddd;">ğŸ“ ì‚°ì •ì—ì„œ ë°°ì œëœ ì¼ê°</h3>
      
      <% if unassigned_issues.any? %>
        <h4 style="margin: 15px 0 10px 0; color: #666;">ë¯¸ë°°ì • ì¼ê° (<%= unassigned_issues.size %>ê°œ)</h4>
        <%= render partial: 'shared/issue_list', locals: { 
          issues: unassigned_issues, 
          page_size: 15, 
          columns: [:id, :tracker, :priority, :assigned_to, :subject, :status, :start_date, :due_date], 
          list_id: 'unassigned-issues-list' 
        } %>
      <% end %>
      
      <% if missing_schedule_issues.any? %>
        <h4 style="margin: 15px 0 10px 0; color: #666;">ì¼ì • ë¯¸ê¸°ì… ì¼ê° (<%= missing_schedule_issues.size %>ê°œ)</h4>
        <%= render partial: 'shared/issue_list', locals: { 
          issues: missing_schedule_issues, 
          page_size: 15, 
          columns: [:id, :tracker, :priority, :assigned_to, :subject, :status, :start_date, :due_date, :estimated_hours_plus, :tip], 
          list_id: 'missing-schedule-issues-list' 
        } %>
      <% end %>
    <% end %>

    <%# í…ìŠ¤íŠ¸ ìš”ì•½ (ì ‘ì´ì‹) - ê²°ê³¼ ìµœí•˜ë‹¨ìœ¼ë¡œ ì´ë™ %>
    <% if result_data.any? %>
      <details style="margin-top: 20px;">
        <summary style="cursor: pointer; font-weight: bold; padding: 8px; background: #f5f5f5; border-radius: 4px;">ğŸ“ í…ìŠ¤íŠ¸ ìš”ì•½ ë³´ê¸°</summary>
        <div style="padding: 10px 0;">
          <% result_data.each do |group, users_issues| %>
            <h3>* <%= group.name %></h3>
            <% users_issues.each do |user, issues| %>
              <div class="user-schedule">
                <span class="user-name">- <%= link_to user.name, user_path(user) %> :</span>

                <%# ê¸°ë³¸ ì¼ê° í‘œì‹œ %>
                <% issues.sort_by(&:start_date).each_with_index do |issue, idx| %>
                  <%
                    main_issue_id = issue_to_main_issue[issue.id]
                    issue_color = main_issue_colors[main_issue_id] || '#999999'
                  %>
                  <span class="issue-link">
                    <span class="issue-color-indicator" style="background-color: <%= issue_color %>;"></span><%= link_to "##{issue.id}", issue_path(issue), data: { issue_tooltip: issue.id } %><span class="issue-dates">(<%= issue.start_date.strftime('%Y-%m-%d') %>~<%= issue.due_date.strftime('%Y-%m-%d') %>)</span><%= ',' unless idx == issues.size - 1 %>
                  </span>
                <% end %>

                <%# ë¯¸ì™„ë£Œ ì¼ê° í‘œì‹œ (ì—°í•œ íšŒìƒ‰) %>
                <% if background_issues_by_user[user.id] %>
                  <br>
                  <span style="margin-left: 20px; color: #999;">
                    (ê¸°íƒ€ ì¼ì •:
                    <% background_issues_by_user[user.id].sort_by(&:start_date).each_with_index do |bg_issue, idx| %>
                      <span class="issue-link" style="opacity: 0.7;">
                        <span class="issue-color-indicator" style="background-color: #e0e0e0;"></span><%= link_to "##{bg_issue.id}", issue_path(bg_issue), data: { issue_tooltip: bg_issue.id }, style: "color: #999;" %><span class="issue-dates">(<%= bg_issue.start_date.strftime('%Y-%m-%d') %>~<%= bg_issue.due_date.strftime('%Y-%m-%d') %>)</span><%= ',' unless idx == background_issues_by_user[user.id].size - 1 %>
                      </span>
                    <% end %>
                    )
                  </span>
                <% end %>
              </div>
            <% end %>
          <% end %>
        </div>
      </details>
    <% end %>
  </div>
<% end %>

<% if params[:issue_ids].present? && result_data.any? %>
<script>
$(document).ready(function() {
  /**
   * ìŠ¤ì¼€ì¤„ ì˜¤ë²„ë© ì²˜ë¦¬ í•¨ìˆ˜
   * ê·œì¹™:
   * 1. ë©”ì¸ ì¼ê°(isMuted=false)ì´ ë°°ê²½ ì¼ê°(isMuted=true)ë³´ë‹¤ ìš°ì„ 
   * 2. ì™„ì „ í¬í•¨: ë” ê¸´(ë˜ëŠ” ìš°ì„ ìˆœìœ„ ë†’ì€) ì¼ì •ë§Œ í‘œì‹œ
   * 3. ë¶€ë¶„ ì¤‘ì²©: ìš°ì„ í•˜ëŠ” ì¼ì •ì„ ì˜¨ì „íˆ í‘œê¸°, ê²¹ì¹˜ëŠ” ì¼ì •ì€ ì´ì „ ì¼ì • ì¢…ë£Œ ë‹¤ìŒë‚ ë¶€í„° ì‹œì‘í•˜ë„ë¡ ì¡°ì •
   */
  function resolveScheduleOverlaps(schedules) {
    if (!schedules || schedules.length <= 1) return schedules;
    
    // ë‚ ì§œ ë¬¸ìì—´ì„ Date ê°ì²´ë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼
    function parseDate(dateStr) {
      return new Date(dateStr + 'T00:00:00');
    }
    
    // Dateë¥¼ ë‚ ì§œ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼
    function formatDate(date) {
      var year = date.getFullYear();
      var month = String(date.getMonth() + 1).padStart(2, '0');
      var day = String(date.getDate()).padStart(2, '0');
      return year + '-' + month + '-' + day;
    }
    
    // ì¼ì • ê¸°ê°„(ì¼ìˆ˜) ê³„ì‚°
    function getDuration(schedule) {
      var start = parseDate(schedule.startDate);
      var end = parseDate(schedule.endDate);
      return Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
    }
    
    // ì •ë ¬: 1. isMuted=false ìš°ì„ , 2. ì‹œì‘ì¼ ë¹ ë¥¸ ìˆœ, 3. ê¸°ê°„ ê¸´ ìˆœ
    var sorted = schedules.slice().sort(function(a, b) {
      // isMutedê°€ falseì¸ ê²ƒ(ë©”ì¸ ì¼ê°)ì´ ìš°ì„ 
      if (a.isMuted !== b.isMuted) {
        return a.isMuted ? 1 : -1;
      }
      // ì‹œì‘ì¼ ë¹„êµ
      var startA = parseDate(a.startDate);
      var startB = parseDate(b.startDate);
      if (startA.getTime() !== startB.getTime()) {
        return startA - startB;
      }
      // ê¸°ê°„ì´ ê¸´ ê²ƒ ìš°ì„ 
      return getDuration(b) - getDuration(a);
    });
    
    var result = [];
    var mainOccupiedRanges = []; // ê¸°ë³¸ ì¼ê°(isMuted=false)ë§Œì˜ ì ìœ  ë²”ìœ„
    var allOccupiedRanges = [];  // ì „ì²´ ì¼ê°ì˜ ì ìœ  ë²”ìœ„ (ê¸°ë³¸ + ë¯¸ì™„ë£Œ)
    
    // ìŠ¤ì¼€ì¤„ ë³µì‚¬ í—¬í¼
    function cloneSchedule(schedule) {
      var copy = {};
      for (var key in schedule) {
        if (schedule.hasOwnProperty(key)) {
          copy[key] = schedule[key];
        }
      }
      return copy;
    }
    
    sorted.forEach(function(schedule) {
      var schedStart = parseDate(schedule.startDate);
      var schedEnd = parseDate(schedule.endDate);
      var isMuted = schedule.isMuted;
      
      // ì°¸ì¡°í•  ì ìœ  ë²”ìœ„ ì„ íƒ:
      // - ê¸°ë³¸ ì¼ê°(isMuted=false): ê¸°ë³¸ ì¼ê° ì ìœ  ë²”ìœ„ë§Œ ì°¸ì¡°
      // - ë¯¸ì™„ë£Œ ì¼ê°(isMuted=true): ì „ì²´ ì ìœ  ë²”ìœ„ ì°¸ì¡°
      var referenceRanges = isMuted ? allOccupiedRanges : mainOccupiedRanges;
      
      // ì ìœ  ë²”ìœ„ë¥¼ ì‹œì‘ì¼ ìˆœìœ¼ë¡œ ì •ë ¬
      var sortedOccupied = referenceRanges.slice().sort(function(a, b) {
        return a.start - b.start;
      });
      
      if (isMuted) {
        // ========================================
        // ë¯¸ì™„ë£Œ ì¼ê°: ë¶„í•  ë¡œì§
        // ê¸°ë³¸ ì¼ê°ì— ì˜í•´ ì¤‘ê°„ì´ ì˜ë¦¬ë©´ ì•/ë’¤ë¡œ ë¶„í• 
        // ========================================
        var periodsToProcess = [{
          start: new Date(schedStart),
          end: new Date(schedEnd)
        }];
        
        // ê° ì ìœ  ë²”ìœ„ì— ëŒ€í•´ ê¸°ê°„ ë¶„í• 
        sortedOccupied.forEach(function(occupied) {
          var newPeriods = [];
          
          periodsToProcess.forEach(function(period) {
            // ê²¹ì¹˜ëŠ”ì§€ í™•ì¸
            if (period.start <= occupied.end && period.end >= occupied.start) {
              // ê²¹ì¹¨ ë°œìƒ - ë¶„í•  í•„ìš”
              
              // ì ìœ  ë²”ìœ„ "ì „" ë¶€ë¶„ (period.start ~ occupied.start - 1ì¼)
              if (period.start < occupied.start) {
                var beforeEnd = new Date(occupied.start);
                beforeEnd.setDate(beforeEnd.getDate() - 1);
                if (beforeEnd >= period.start) {
                  newPeriods.push({ 
                    start: new Date(period.start), 
                    end: beforeEnd 
                  });
                }
              }
              
              // ì ìœ  ë²”ìœ„ "í›„" ë¶€ë¶„ (occupied.end + 1ì¼ ~ period.end)
              if (period.end > occupied.end) {
                var afterStart = new Date(occupied.end);
                afterStart.setDate(afterStart.getDate() + 1);
                if (afterStart <= period.end) {
                  newPeriods.push({ 
                    start: afterStart, 
                    end: new Date(period.end) 
                  });
                }
              }
            } else {
              // ê²¹ì¹˜ì§€ ì•ŠìŒ - ê·¸ëŒ€ë¡œ ìœ ì§€
              newPeriods.push(period);
            }
          });
          
          periodsToProcess = newPeriods;
        });
        
        // ë¶„í• ëœ ê¸°ê°„ë“¤ì„ ê²°ê³¼ì— ì¶”ê°€
        periodsToProcess.forEach(function(period) {
          var adjustedSchedule = cloneSchedule(schedule);
          adjustedSchedule.startDate = formatDate(period.start);
          adjustedSchedule.endDate = formatDate(period.end);
          
          // ì›ë³¸ê³¼ ë‹¤ë¥´ë©´ í‘œì‹œ
          if (formatDate(schedStart) !== adjustedSchedule.startDate || 
              formatDate(schedEnd) !== adjustedSchedule.endDate) {
            adjustedSchedule.originalStartDate = formatDate(schedStart);
            adjustedSchedule.originalEndDate = formatDate(schedEnd);
          }
          
          result.push(adjustedSchedule);
          
          // ì ìœ  ë²”ìœ„ì— ì¶”ê°€ (ë¯¸ì™„ë£Œ ì¼ê°ì€ allOccupiedRangesì—ë§Œ)
          allOccupiedRanges.push({ 
            start: new Date(period.start), 
            end: new Date(period.end) 
          });
        });
        
      } else {
        // ========================================
        // ê¸°ë³¸ ì¼ê°: ê¸°ì¡´ ë¡œì§ (ì‹œì‘ì¼ ì¡°ì •)
        // ========================================
        var adjustedStart = new Date(schedStart);
        var adjustedEnd = new Date(schedEnd);
        
        for (var i = 0; i < sortedOccupied.length; i++) {
          var occupied = sortedOccupied[i];
          
          // ê²¹ì¹¨ í™•ì¸
          if (adjustedStart <= occupied.end && adjustedEnd >= occupied.start) {
            var nextDay = new Date(occupied.end);
            nextDay.setDate(nextDay.getDate() + 1);
            
            if (nextDay > adjustedStart) {
              adjustedStart = nextDay;
            }
          }
          
          if (adjustedStart > adjustedEnd) {
            break;
          }
        }
        
        // ìœ íš¨í•œ ê¸°ê°„ì´ ì—†ìœ¼ë©´ ìŠ¤í‚µ
        if (adjustedStart > adjustedEnd) {
          return;
        }
        
        var adjustedSchedule = cloneSchedule(schedule);
        adjustedSchedule.startDate = formatDate(adjustedStart);
        adjustedSchedule.endDate = formatDate(adjustedEnd);
        
        if (formatDate(schedStart) !== adjustedSchedule.startDate) {
          adjustedSchedule.originalStartDate = formatDate(schedStart);
        }
        
        result.push(adjustedSchedule);
        
        // ì ìœ  ë²”ìœ„ì— ì¶”ê°€ (ê¸°ë³¸ ì¼ê°ì€ ì–‘ìª½ ëª¨ë‘)
        var rangeEntry = { start: new Date(adjustedStart), end: new Date(adjustedEnd) };
        allOccupiedRanges.push(rangeEntry);
        mainOccupiedRanges.push({ start: new Date(adjustedStart), end: new Date(adjustedEnd) });
      }
    });
    
    // ê²°ê³¼ë¥¼ ì‹œì‘ì¼ ìˆœìœ¼ë¡œ ë‹¤ì‹œ ì •ë ¬
    result.sort(function(a, b) {
      return parseDate(a.startDate) - parseDate(b.startDate);
    });
    
    return result;
  }
  
  // JSON ë°ì´í„° êµ¬ì„± (íƒ€ì„ë¼ì¸ ê·¸ë¦¬ë“œ + ì—‘ì…€ ê³µìš©)
  var jsonData = {
    options: {
      categoryLabel: "íŒ€",
      eventLabel: "ë‹´ë‹¹ì",
      rowHeight: 15,
      showScheduleName: true,
      startDate: "<%= display_start_date.strftime('%Y-%m-%d') %>",
      holidays: <%= holidays.to_json.html_safe %>
    },
    categories: [],
    legends: []
  };
  
  <% result_data.each do |group, users_issues| %>
    var category = {
      name: "<%= j(group.name) %>",
      customColor: null,
      events: []
    };
    
    <% users_issues.each do |user, issues| %>
      var event = {
        name: "<%= j(user.name) %>",
        link: "<%= url_for(controller: 'users', action: 'show', id: user.id, only_path: false) %>",
        schedules: []
      };
      
      <%# í•´ë‹¹ ì‚¬ìš©ìì˜ ë°°ê²½ ì¼ê° (ë‹¤ë¥¸ ë¯¸ì™„ë£Œ ì¼ê°) ë¨¼ì € ì¶”ê°€ %>
      <% if background_issues_by_user[user.id] %>
        <% background_issues_by_user[user.id].sort_by(&:start_date).each do |bg_issue| %>
          <%
            # êµ¬í˜„ì´ ëœ ëë‚œ ìƒíƒœ í™•ì¸ (new, in_progress, in_review ìƒíƒœ ID ê¸°ë°˜)
            bg_status_id = bg_issue.status_id
            bg_in_progress_status_ids = IssueStatus.new_ids + IssueStatus.in_progress_ids + IssueStatus.in_review_ids
            bg_is_in_progress = bg_in_progress_status_ids.include?(bg_status_id)
            bg_font_color = bg_is_in_progress ? "#555555" : "#AAAAAA"
          %>
          event.schedules.push({
            name: "<%= j("##{bg_issue.id} : #{bg_issue.subject}") %>",
            startDate: "<%= bg_issue.start_date.strftime('%Y-%m-%d') %>",
            endDate: "<%= bg_issue.due_date.strftime('%Y-%m-%d') %>",
            issue: "#<%= bg_issue.id %>",
            issueId: "<%= bg_issue.id %>",
            doneRatio: "<%= bg_issue.done_ratio || 0 %>",
            link: "<%= url_for(controller: 'issues', action: 'show', id: bg_issue.id, only_path: false) %>",
            customColor: "#e0e0e0",
            customFontColor: "<%= bg_font_color %>",
            isMuted: true
          });
        <% end %>
      <% end %>
      
      <%# ë©”ì¸ ì¼ê°ë“¤ ì¶”ê°€ %>
      <% issues.sort_by(&:start_date).each do |issue| %>
        <%
          main_issue_id = issue_to_main_issue[issue.id]
          issue_color = main_issue_colors[main_issue_id] || '#999999'
          
          # êµ¬í˜„ì´ ëœ ëë‚œ ìƒíƒœ í™•ì¸ (new, in_progress, in_review ìƒíƒœ ID ê¸°ë°˜)
          status_id = issue.status_id
          in_progress_status_ids = IssueStatus.new_ids + IssueStatus.in_progress_ids + IssueStatus.in_review_ids
          is_in_progress = in_progress_status_ids.include?(status_id)
          
          # êµ¬í˜„ ì¤‘ì¸ ì¼ê°ì€ ê¸°ë³¸ ë°ê¸°, êµ¬í˜„ ëë‚œ ì¼ê°ì€ íë¦¿í•œ ìƒ‰ìƒ
          font_color = is_in_progress ? "#555555" : "#AAAAAA"
        %>
        event.schedules.push({
          name: "<%= j("##{issue.id} : #{issue.subject}") %>",
          startDate: "<%= issue.start_date.strftime('%Y-%m-%d') %>",
          endDate: "<%= issue.due_date.strftime('%Y-%m-%d') %>",
          issue: "#<%= issue.id %>",
          issueId: "<%= issue.id %>",
          doneRatio: "<%= issue.done_ratio || 0 %>",
          link: "<%= url_for(controller: 'issues', action: 'show', id: issue.id, only_path: false) %>",
          customColor: "<%= issue_color %>"<% if font_color %>,
          customFontColor: "<%= font_color %>"<% end %>
        });
      <% end %>
      
      category.events.push(event);
    <% end %>
    
    jsonData.categories.push(category);
  <% end %>
  
  // ë²”ë¡€ ì •ë³´ ì¶”ê°€ (ë©”ì¸ ì¼ê°ë³„ ìƒ‰ìƒ)
  <% if main_issue_colors.any? %>
    <% parent_issues.each do |main_issue| %>
      jsonData.legends.push({
        title: "<%= j("##{main_issue.id} : #{main_issue.subject.truncate(30)}") %>",
        color: "<%= main_issue_colors[main_issue.id] %>",
        url: "<%= url_for(controller: 'issues', action: 'show', id: main_issue.id, only_path: false) %>"
      });
    <% end %>
  <% end %>
  
  // ê° ì´ë²¤íŠ¸ì˜ ìŠ¤ì¼€ì¤„ì— ëŒ€í•´ ì˜¤ë²„ë© ì²˜ë¦¬
  jsonData.categories.forEach(function(category) {
    category.events.forEach(function(event) {
      event.schedules = resolveScheduleOverlaps(event.schedules);
    });
  });
  
  // íƒ€ì„ë¼ì¸ ê·¸ë¦¬ë“œ ë Œë”ë§
  try {
    TxTimelineGrid.render('#timeline-grid-container', jsonData, { verticalMarkers: <%= version_markers.to_json.html_safe %>, scrollToToday: true, scrollAlign: 'center', scrollBehavior: 'auto' });
    console.log('íƒ€ì„ë¼ì¸ ê·¸ë¦¬ë“œ ë Œë”ë§ ì™„ë£Œ');
    
    // ë Œë”ë§ í›„ í˜ì´ì§€ ìƒë‹¨(í¼ ìœ„ì¹˜)ìœ¼ë¡œ ì¦‰ì‹œ ìŠ¤í¬ë¡¤
    window.scrollTo(0, 0);
  } catch (error) {
    console.error('íƒ€ì„ë¼ì¸ ê·¸ë¦¬ë“œ ë Œë”ë§ ì˜¤ë¥˜:', error);
    $('#timeline-grid-container').html('<div class="no-result">íƒ€ì„ë¼ì¸ ë Œë”ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>');
  }
  
  // ìŠ¤ì¼€ì¤„ í´ë¦­ ì´ë²¤íŠ¸ (ì„ íƒì )
  document.getElementById('timeline-grid-container').addEventListener('tx-schedule-click', function(e) {
    console.log('ìŠ¤ì¼€ì¤„ í´ë¦­:', e.detail.scheduleName);
  });
  
  // XLSX ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
  $('#export-xlsx-btn').on('click', function() {
    try {
      var today = new Date();
      var dateStr = today.getFullYear() + 
                    String(today.getMonth() + 1).padStart(2, '0') + 
                    String(today.getDate()).padStart(2, '0');
      var fileName = 'ì¼ì •ìš”ì•½_' + dateStr;
      
      TxXlsxExporter.exportToXlsx(jsonData, fileName)
        .then(function() {
          console.log('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
        })
        .catch(function(error) {
          console.error('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
          alert('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        });
      
    } catch (error) {
      console.error('ë°ì´í„° ìƒì„± ì˜¤ë¥˜:', error);
      alert('ë°ì´í„° ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
  });
});
</script>
<% end %>
<br>

<h2>ğŸ“‹ ì¼ì •ìš”ì•½</h2>
<p>ì¼ê°ë“¤ì„ íŒ€ê³¼ ì‚¬ìš©ì ê¸°ì¤€ìœ¼ë¡œ ìš”ì•½í•©ë‹ˆë‹¤. ì…ë ¥ëœ ì¼ê°ì˜ í•˜ìœ„ ì¼ê° ì¤‘ ì‹œì‘ì¼ê³¼ ì™„ë£Œì¼ì´ ëª¨ë‘ ê¸°ì¬ëœ ì¼ê°ë§Œ ì·¨í•©ë©ë‹ˆë‹¤.</p>

<div class="schedule-summary-form" style="margin-top: 30px;">
  <%= form_tag(request.path, method: :get, id: 'schedule-summary-form') do %>

    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
      <!-- ì™¼ìª½ ì»¬ëŸ¼: ì¼ê° ëª©ë¡ + í‘œê¸° ì‹œì‘ì¼ -->
      <div style="flex: 1;">
        <div class="form-group">
          <label for="issue_ids">ì¼ê° ëª©ë¡ (ID - ì œëª©ì„ ì…ë ¥í•˜ë©´ IDê°€ ìë™ ì™„ì„± ë©ë‹ˆë‹¤.</label>
          <textarea name="issue_ids" id="issue_ids" placeholder="ì˜ˆ: 12312, 32123; 42128 35123"><%= params[:issue_ids] %></textarea>
          <div class="hint">ì‰¼í‘œ(,), ì„¸ë¯¸ì½œë¡ (;), ê³µë°±ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ ì—¬ëŸ¬ ì¼ê° IDë¥¼ ì…ë ¥í•˜ì„¸ìš”. ë²ˆí˜¸ë‚˜ ì œëª©ì„ ì…ë ¥í•˜ë©´ ìë™ì™„ì„±ìœ¼ë¡œ ê²€ìƒ‰ë©ë‹ˆë‹¤. ê²€ìƒ‰ ëŒ€ìƒì€ ìµœìƒìœ„ ë¶€ëª¨ ì¼ê°ë§Œ í¬í•¨ë©ë‹ˆë‹¤.</div>
        </div>

        <div class="form-group">
          <label for="display_start_date">í‘œê¸° ì‹œì‘ì¼</label>
          <%
            # ê¸°ë³¸ê°’: ì˜¤ëŠ˜ë¡œë¶€í„° 2ê°œì›” ì „
            default_display_start_date = 2.months.ago.to_date
            display_start_date = params[:display_start_date].present? ? Date.parse(params[:display_start_date]) : default_display_start_date
          %>
          <input type="date" name="display_start_date" id="display_start_date" value="<%= display_start_date.strftime('%Y-%m-%d') %>" class="form-control" style="max-width: 200px;">
          <div class="hint">ì´ ë‚ ì§œ ì´ì „ì— ì‹œì‘í•˜ê³  ì¢…ë£Œë˜ëŠ” ì¼ê°ì€ í‘œì‹œì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.</div>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½ ì»¬ëŸ¼: íŒ€ ì„ íƒ -->
      <div style="flex: 1;">
        <div class="form-group">
          <label for="group_ids">íŒ€ ì„ íƒ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</label>
          <select name="group_ids[]" id="group_ids" multiple style="min-height: 150px;">
            <% all_groups.each do |group| %>
              <option value="<%= group.id %>" <%= 'selected' if params[:group_ids]&.include?(group.id.to_s) %>><%= group.name %></option>
            <% end %>
          </select>
          <div class="hint">íŒ€ì„ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ì „ì²´ íŒ€ ê¸°ì¤€ìœ¼ë¡œ ìš”ì•½ë©ë‹ˆë‹¤. Ctrl/Cmd í‚¤ë¥¼ ëˆ„ë¥´ê³  í´ë¦­í•˜ì—¬ ì—¬ëŸ¬ íŒ€ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        </div>
      </div>
    </div>

    <div class="form-group">
      <%= submit_tag 'ğŸ“Š ìš”ì•½', class: 'btn btn-primary' %>
      <% if params[:issue_ids].present? %>
        <button type="button" id="export-xlsx-btn" class="btn btn-success" style="margin-left: 10px;">ğŸ“Š XLSX</button>
      <% end %>
    </div>
  <% end %>
</div>

<%= javascript_tag do %>
  // ì¼ê° ID ë‹¤ì¤‘ ìë™ì™„ì„± (ë²ˆí˜¸/ì œëª© ê²€ìƒ‰) - ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©
  setupIssueAutocomplete(
    'issue_ids',
    '<%= j tx_base_top_parent_issues_path %>',
    {
      <% if @project.present? %>
      projectId: '<%= @project.id %>',
      <% else %>
      scope: 'all',
      <% end %>
    }
  );
<% end %>
