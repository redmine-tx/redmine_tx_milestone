<!-- TX Issue Autocomplete (ì¼ê° ìë™ì™„ì„±) -->
<%= javascript_include_tag 'tx_issue_autocomplete', plugin: 'redmine_tx_0_base' %>

<div class="issue-auto-schedule">
  <h3>ë©”ì¸ ì¼ê° ë‹¨ìœ„ ìë™ ë°°ì¹˜</h3>
  <p style="color: #666; margin-bottom: 20px;">
    ë©”ì¸ ì¼ê°ì„ ê¸°ì¤€ìœ¼ë¡œ í•˜ìœ„ ì¼ê°ë“¤ì˜ ì¼ì •ì„ ìë™ìœ¼ë¡œ ë°°ì¹˜í•©ë‹ˆë‹¤.<br>
    ë©”ì¸ ì¼ê°ì˜ IDë¥¼ ì…ë ¥í•˜ì—¬ ìë™ ë°°ì¹˜ë¥¼ ì‹œì‘í•˜ì„¸ìš”. (í–¥í›„ ì—¬ëŸ¬ ê°œì˜ ë©”ì¸ ì¼ê°ì„ ë™ì‹œì— ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ í™•ì¥ë  ì˜ˆì •ì…ë‹ˆë‹¤)
  </p>
  
  <div class="issue-input-section">
    <div class="form-group">
      <label for="issue-id-input">ì¼ê° ID (ì—¬ëŸ¬ ê°œ ì…ë ¥ ê°€ëŠ¥):</label>
      <textarea id="issue-id-input" placeholder="ì¼ê° IDë‚˜ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 12312, 32123)" class="issue-id-field"></textarea>
      <div class="hint">ì‰¼í‘œ(,), ì„¸ë¯¸ì½œë¡ (;), ê³µë°±ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ ì—¬ëŸ¬ ì¼ê° IDë¥¼ ì…ë ¥í•˜ì„¸ìš”. ë²ˆí˜¸ë‚˜ ì œëª©ì„ ì…ë ¥í•˜ë©´ ìë™ì™„ì„±ìœ¼ë¡œ ê²€ìƒ‰ë©ë‹ˆë‹¤.</div>
    </div>
    
    <div class="form-actions">
      <button type="button" id="start-auto-schedule" class="button button-primary" disabled>
        âš¡ ì‹œì‘
      </button>
    </div>
  </div>
  
  <div class="help-text">
    <h4>ğŸ’¡ ì‚¬ìš© ë°©ë²•</h4>
    <ul>
      <li>ë©”ì¸ ì¼ê°ì˜ IDë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì—¬ëŸ¬ ê°œ ì…ë ¥ ê°€ëŠ¥)</li>
      <li>ì¼ê° ë²ˆí˜¸ë‚˜ ì œëª©ì„ ì…ë ¥í•˜ë©´ ìë™ì™„ì„±ìœ¼ë¡œ ê²€ìƒ‰ë©ë‹ˆë‹¤</li>
      <li>í•´ë‹¹ ì¼ê°ì˜ í•˜ìœ„ ì¼ê°ë“¤ì´ ìë™ìœ¼ë¡œ ë°°ì¹˜ë©ë‹ˆë‹¤</li>
      <li>ì¶”ì • ì‘ì—… ì‹œê°„ì´ ì„¤ì •ëœ ì¼ê°ë§Œ ì²˜ë¦¬ë©ë‹ˆë‹¤</li>
      <li>Ctrl+Enterë¥¼ ëˆŒëŸ¬ ë¹ ë¥´ê²Œ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
    </ul>
  </div>
</div>

<script>
$(document).ready(function() {
  var projectId = '<%= params[:project_id] %>';
  
  // ë²„íŠ¼ í™œì„±í™” ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
  function updateButtonState() {
    var inputValue = $('#issue-id-input').val().trim();
    var issueIds = parseIssueIds(inputValue);
    var startButton = $('#start-auto-schedule');
    
    if (issueIds.length > 0) {
      startButton.prop('disabled', false);
    } else {
      startButton.prop('disabled', true);
    }
  }
  
  // ì¼ê° ID ë‹¤ì¤‘ ìë™ì™„ì„± (ë²ˆí˜¸/ì œëª© ê²€ìƒ‰) - ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©
  setupIssueAutocomplete(
    'issue-id-input',
    '<%= j tx_base_top_parent_issues_path %>',
    {
      <% if @project.present? %>
      projectId: '<%= @project.id %>',
      <% else %>
      scope: 'all',
      <% end %>
      onSelect: updateButtonState
    }
  );
  
  // ì…ë ¥ì°½ ë³€ê²½ ì´ë²¤íŠ¸
  $('#issue-id-input').on('input', function() {
    updateButtonState();
  });
  
  // ì—”í„°í‚¤ ì²˜ë¦¬ (textareaì—ì„œëŠ” Ctrl+Enterë¡œ ë³€ê²½)
  $('#issue-id-input').on('keydown', function(e) {
    if (e.which === 13 && e.ctrlKey) { // Ctrl+Enter
      e.preventDefault();
      $('#start-auto-schedule').click();
    }
  });
  
  // ì‹œì‘ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  $('#start-auto-schedule').click(function() {
    var inputValue = $('#issue-id-input').val().trim();
    var issueIds = parseIssueIds(inputValue);
    
    if (issueIds.length === 0) {
      alert('ì˜¬ë°”ë¥¸ ì¼ê° IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    // ì²« ë²ˆì§¸ ì¼ê° IDë¡œ ì´ë™ (í–¥í›„ ì—¬ëŸ¬ ê°œ ì²˜ë¦¬ ë¡œì§ìœ¼ë¡œ í™•ì¥ ì˜ˆì •)
    var issueId = issueIds[0];
    var url = '/projects/' + projectId + '/milestone/tetris/issues/' + issueId;
    
    if (issueIds.length > 1) {
      alert('í˜„ì¬ëŠ” ì²« ë²ˆì§¸ ì¼ê°(' + issueId + ')ë§Œ ì²˜ë¦¬ë©ë‹ˆë‹¤. í–¥í›„ ì—¬ëŸ¬ ì¼ê° ì²˜ë¦¬ ê¸°ëŠ¥ì´ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤.');
    }
    
    window.location.href = url;
  });
});
</script>

<style>
.issue-auto-schedule {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  margin: 20px 0;
}

.issue-auto-schedule h3 {
  margin-top: 0;
  color: #333;
  font-size: 1.2em;
}

.issue-input-section {
  background: #f9f9f9;
  padding: 20px;
  border-radius: 5px;
  margin: 20px 0;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
  color: #333;
}

.issue-id-field {
  width: 100%;
  max-width: 600px;
  min-height: 60px;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
  font-family: monospace;
  transition: border-color 0.3s;
  resize: vertical;
}

.issue-id-field:focus {
  outline: none;
  border-color: #4CAF50;
  box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
}

.form-actions {
  margin-top: 15px;
}

.hint {
  color: #888;
  font-size: 0.9em;
  margin-top: 5px;
}


.help-text {
  margin-top: 20px;
  padding: 15px;
  background-color: #f0f8ff;
  border-radius: 5px;
  border-left: 4px solid #4CAF50;
}

.help-text h4 {
  margin-top: 0;
  color: #333;
}

.help-text ul {
  margin-bottom: 0;
}

.help-text li {
  margin-bottom: 5px;
  color: #666;
}
</style>

