<div id="tx-milestone-settings">

  <h3>일정 자동 배치 설정</h3>
  <p>
    <%= check_box_tag "settings[setting_milestone_use_redmine_auto_schedule]", @settings["setting_milestone_use_redmine_auto_schedule"], @settings["setting_milestone_use_redmine_auto_schedule"] == 'true' %>
    <label for="settings_setting_milestone_use_redmine_auto_schedule">레드마인 자동 일정 배치 사용</label>
    <span class="description">레드마인의 기본 자동 스케줄링 기능(set_issue_to_dates)을 설정에 따라 선택적으로 비활성화합니다. <font color="red" style="font-weight: bold;">이 플러그인의 자체 AutoScheduler 로직과 충돌을 방지하기 위해 사용되므로 특별한 경우가 아니면 체크하지 마세요.</font></span>
  </p>

  <br>

  <h3>마감기한 설정</h3>
  <p class="description">마일스톤 마감일 이전에 표시할 일정 마크를 설정합니다.</p>

  <table class="list" id="milestone-deadlines">
    <thead>
      <tr>
        <th>마감 ?일전</th>
        <th>제목</th>
        <th class="buttons"></th>
      </tr>
    </thead>
    <tbody>
      <% deadlines = RedmineTxMilestone::SettingsMigration.get_deadlines(@settings) %>
      <% deadlines.each do |deadline| %>
      <tr class="deadline-entry">
        <td>
          <%= number_field_tag "settings[setting_milestone_deadlines][][days]",
                               deadline['days'], id: nil, size: 10, min: 1 %>
        </td>
        <td>
          <%= text_field_tag "settings[setting_milestone_deadlines][][title]",
                             deadline['title'], id: nil, size: 30 %>
        </td>
        <td class="buttons">
          <a href="#" class="delete-deadline icon-only icon-del" title="삭제"><%= sprite_icon('del', '삭제') %></a>
        </td>
      </tr>
      <% end %>
      <tr>
        <td colspan="2"></td>
        <td class="buttons">
          <a href="#" class="add-deadline icon-only icon-add" title="추가"><%= sprite_icon('add', '추가') %></a>
        </td>
      </tr>
    </tbody>
  </table>

</div>

<style>
/* .tabular.settings 상속 스타일 전체 리셋 */
#tx-milestone-settings p {
  padding-left: 0;
  clear: none;
  overflow: visible;
}

#tx-milestone-settings label {
  float: none;
  width: auto;
  margin-left: 0;
  text-align: left;
  font-weight: bold;
}

#tx-milestone-settings input,
#tx-milestone-settings select,
#tx-milestone-settings textarea {
  max-width: none;
}

/* 테이블 스타일 */
#milestone-deadlines {
  width: auto;
  margin-top: 8px;
}

#milestone-deadlines td input[type="number"] {
  width: 80px;
}

#milestone-deadlines td input[type="text"] {
  width: 200px;
}

/* 체크박스 인라인 정렬 */
#tx-milestone-settings p label {
  display: inline;
  margin-right: 4px;
}
</style>

<script>
$(function() {
  var $tbody = $('#milestone-deadlines tbody');

  // 행 삭제
  $tbody.on('click', '.delete-deadline', function(e) {
    e.preventDefault();
    // 최소 1개 행 유지
    if ($tbody.find('.deadline-entry').length > 1) {
      $(this).closest('tr').remove();
    }
  });

  // 삭제 버튼 HTML 템플릿 (기존 행에서 복사)
  var deleteIconHtml = $tbody.find('.delete-deadline').first().html() ||
    '<span class="icon-label">삭제</span>';

  // 행 추가
  $tbody.on('click', '.add-deadline', function(e) {
    e.preventDefault();
    var newRow = '<tr class="deadline-entry">' +
      '<td><input type="number" name="settings[setting_milestone_deadlines][][days]" value="" size="10" min="1"></td>' +
      '<td><input type="text" name="settings[setting_milestone_deadlines][][title]" value="" size="30"></td>' +
      '<td class="buttons"><a href="#" class="delete-deadline icon-only icon-del" title="삭제">' +
      deleteIconHtml + '</a></td>' +
      '</tr>';
    $(this).closest('tr').before(newRow);
  });
});
</script>
